@using Satyanam.Nop.Plugin.SatyanamCRM.Models.Campaings
@model CampaingsModel
@inject AdminAreaSettings adminAreaSettings
<input type="hidden" asp-for="@Model.Id"/>
<input asp-for="CreatedOnUtc" type="hidden" />
<input type="hidden" id="TotalLeads" name="TotalLeads" value="@Model.TotalLeads" />
<section class="content">
    <div class="container-fluid">
        <div class="form-horizontal">
            <div class="cards-group">
                <div class="card card-default">
                    <div class="card-body">
                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="Name" />
                            </div>
                            <div class="col-md-4">
                                <nop-editor asp-for="Name" asp-required="true" />
                                <span asp-validation-for="Name"></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="EmailAccountId" />
                            </div>
                            <div class="col-md-4">
                                <nop-select asp-for="EmailAccountId" asp-items="Model.Emails" />
                                <span asp-validation-for="EmailAccountId"></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="Subject" />
                            </div>
                            <div class="col-md-4">
                                <nop-editor asp-for="Subject" />
                                <span asp-validation-for="Subject"></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="Body" />
                            </div>
                            <div class="col-md-9">
                                <div class="input-group-append input-group-required">
                                    <div class="input-group">
                                        <nop-editor asp-for="Body" asp-template="RichEditor"></nop-editor>
                                    </div>
                                    <div class="input-group-btn">
                                        <nop-required />
                                    </div>
                                </div>

                                <span asp-validation-for="Body"></span>
                            </div>
                        </div>
                        <script>
                            $(document).ready(function () {
                                $('#@Html.IdFor(model => model.Body)').height($('#@Html.IdFor(model => model.Body)')[0].scrollHeight);
                            });
                        </script>
                        <div class="form-group row">
                            <script>
                                function toggleLoadedAllowedTokens() {
                                    $('#pnlAllowedTokens').toggleClass('d-none');
                                    if ($('#pnlAllowedTokens').hasClass('d-none')) {
                                        $('#allowedTokensShowHide').text('@T("Admin.Common.Show")');
                                    } else {
                                        $('#allowedTokensShowHide').text('@T("Admin.Common.Hide")');
                                    }
                                }
                            </script>

                            <div class="col-md-3">
                                <nop-label asp-for="AllowedTokens" />
                            </div>
                            <div class="col-md-9">
                                <a id="allowedTokensShowHide" href="javascript:toggleLoadedAllowedTokens();">@T("Admin.Common.Show")</a>
                                <div id="pnlAllowedTokens" class="d-none">
                                    <div class="form-text-row">
                                        @if (Model.AllowedTokens != null && Model.AllowedTokens.Any())
                                        {
                                            @Html.Raw(string.Join(", ", Model.AllowedTokens.Select(t => $"%{t}%")))
                                        }
                                        else
                                        {
                                            <span>No tokens available.</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="StatusId" />
                            </div>
                            <div class="col-md-4">
                                <nop-select asp-for="StatusId" asp-items="Model.Status" />
                                <span asp-validation-for="StatusId"></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="ScheduledDate" />
                            </div>
                            <div class="col-md-9">
                                <nop-editor asp-for="ScheduledDate" />
                                <span asp-validation-for="ScheduledDate"></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="TagsId" />
                            </div>
                            <div class="col-md-4">
                                <select id="tagsDropdown" name="TagsId" multiple="multiple">
                                    @foreach (var tag in Model.Tags)
                                    {
                                        <option value="@tag.Value" selected="@(Model.TagsId.Contains(int.Parse(tag.Value)) ? "selected" : null)">
                                            @tag.Text
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="TagsId"></span>
                            </div>
                            <div class="col-md-3">
                                <strong>Total Leads:</strong> <span id="leadTotal">@Model.TotalLeads</span>
                            </div>
                        </div>
                    </div>
                </div>
                    <script>
                        $(document).ready(function () {
                            var tagsDropdown = $("#tagsDropdown").kendoMultiSelect({
                                placeholder: "Select Tags...",
                                autoClose: false,
                                filter: "contains"
                            }).data("kendoMultiSelect");

                        @if (Model.Tags.Count == 0)
                        {
                            <text>
                                    tagsDropdown.setOptions({
                                        enable: false,
                                        placeholder: "No tags available"
                                    });
                                tagsDropdown._placeholder();
                                tagsDropdown._enable();
                            </text>
                        }
                                            });
                    </script>
                <script>
                    $(document).ready(function () {
                        $('#tagsDropdown').on('change', function () {
                            var selectedTags = $(this).val(); // Get selected tags

                            if (selectedTags.length === 0) {
                                $('#leadTotal').text(0); // If no tags selected, set to 0
                                return;
                            }

                            $.ajax({
                                url: '@Url.Action("GetLeadCountByTags", "Campaings")',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify(selectedTags),
                                success: function (response) {
                                    $('#leadTotal').text(response);  
                                    $('#TotalLeads').val(response);
                                },
                                error: function () {
                                    alert("Error fetching lead count.");
                                }
                            });
                        });
                    });
                </script>


                <div class="card card-default" id="test-email-area">
                    <div class="card-header">
                        @T("Campaings.SendTestEmail")
                    </div>
                    <div class="card-body">
                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="SendTestEmailTo" />
                            </div>
                            <div class="col-md-9">
                                <div class="input-group">
                                    <nop-editor asp-for="SendTestEmailTo" id="TestEmail" />
                                    <div class="input-group-append">
                                        <button type="submit" formaction="@Url.Action("SendTestEmail", "Campaings")" formmethod="post" class="btn btn-primary">
                                            @T("Admin.Configuration.EmailAccounts.SendTestEmail.Button")
                                        </button>
                                    </div>
                                </div>
                                <span asp-validation-for="SendTestEmailTo"></span>
                            </div>
                        </div>
                    </div>
                </div>
               
                <div class="card card-default" id="email-analytics-area">
                    <div class="card-header">
                        @T("Campaings.Analytics")
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-4">
                            <div class="col-md-3">
                                <div class="card p-3 rounded bg-light h-100">
                                    <h5>Total Sent</h5>
                                    <h3 class="text-dark mb-0">
                                        @Model.TotalEmailsSent (@(Model.TotalEmailsSent > 0 ? "100%" : "0%"))
                                    </h3>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="card p-3 rounded bg-light h-100">
                                    <h5>Total Opens</h5>
                                    <h3 class="text-success mb-0">
                                        @Model.TotalOpens (@Model.OpenRate%)
                                    </h3>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="card p-3 rounded bg-light h-100">
                                    <h5>Total Clicks</h5>
                                    <h3 class="text-primary mb-0">
                                        @Model.TotalClicks (@Model.ClickRate%)
                                    </h3>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="card p-3 rounded bg-light h-100">
                                    <h5>Total Unsubscribed</h5>
                                    <h3 class="text-danger mb-0">
                                        @Model.UnsubscribedCount (@Model.UnsubscribeRate%)
                                    </h3>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="card-body">
                        @await Html.PartialAsync("~/Plugins/Misc.SatyanamCRM/Views/Campaings/_EmailLogsTable.cshtml", Model)
                    </div>
                </div>

                

            </div>
        </div>
        </div>
</section>


