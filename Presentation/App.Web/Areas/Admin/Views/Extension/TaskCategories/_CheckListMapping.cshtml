@using App.Web.Areas.Admin.Models.CheckListMappings
@model CheckListMappingModel
<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

@if (ViewBag.RefreshPage == true)
{
    <script>
        try {
            // Trigger the custom event in the parent page
            var event = new Event('refreshGrid');
            window.opener.dispatchEvent(event);
            window.close();
        }
        catch (e) {
            console.log("Error triggering event: " + e.message);
        }
    </script>
}

<section class="content">
    <div class="container-fluid">
        <div class="form-horizontal">
            <div class="cards-group">
                <div class="card card-default card-popup">
                    <div class="card-body">
                        <input asp-for="Id" type="hidden" />
                        <input asp-for="TaskCategoryId" type="hidden" />

                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="ProcessWorkflowId" />
                            </div>
                            <div class="col-md-4">
                                <nop-select asp-for="ProcessWorkflowId" asp-items="Model.AvailableProcessWorkflows" asp-required="true" class="form-control" />
                                <span asp-validation-for="ProcessWorkflowId"></span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="StatusId" />
                            </div>
                            <div class="col-md-4">
                                <select id="statusDropdown" name="StatusId" asp-for="StatusId" asp-items="Model.AvailableStatuses" class="select2-custom form-control" style="border-radius:0;"></select>
                                <span asp-validation-for="StatusId"></span>
                            </div>
                        </div>
                        <script>
                            $(document).ready(function () {
                                function formatStatus(state) {
                                    if (!state.id) return state.text;

                                    const [text, color] = state.text.split("|||");
                                    return $(`
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${color};"></div>
                                            <span>${text}</span>
                                        </div>
                                    `);
                                }

                            $('#statusDropdown').select2({
                                    templateResult: formatStatus,
                                    templateSelection: formatStatus,
                                    escapeMarkup: function (m) { return m; },
                                     minimumResultsForSearch: Infinity
                                });
                            });
                        </script>
                        <style>
                            .select2-container .select2-selection--single {
                                height: 35px;
                                padding-left: 0px;
                            }

                            .select2-container--default .select2-selection--single .select2-selection__arrow {
                                height: 35px;
                            }

                            .select2-container--default .select2-selection--single {
                                border-radius: 0;
                            }

                        </style>
 
                        <div class="form-group row">
                            <div class="col-sm-3">
                                <nop-label asp-for="CheckListName" />
                            </div>
                            <div class="col-md-4">
                                <input type="text" id="checkListName" name="CheckListName" class="form-control"
                                       placeholder="Search or enter a new checklist" autocomplete="off" value="@Model.CheckListName"/>
                                <span style="color:red;" id="checkListError"></span>
                                <ul id="checkListSuggestions" class="list-group" style="position: absolute; z-index: 100; display: none;">
                                </ul>
                            </div>
                        </div>
                        <script>

                    $(document).ready(function () {
                                let timeout = null;

                                        $("#checkListName").on("input", function () {
                                    clearTimeout(timeout);
                                    const query = $(this).val().trim();
                                   
                                    if (query.length > 0) {
                                        timeout = setTimeout(() => {
                                            $.ajax({
                                                url: '@Url.Action("SearchCheckList", "CheckListMapping")',
                                                type: 'GET',
                                                data: { searchText: query},
                                                success: function (data) {
                                                            const suggestions = $("#checkListSuggestions");
                                                    suggestions.empty().hide();

                                                    if (data && data.length > 0) {
                                                        data.forEach(checklist => {
                                                                    const item = $(`<li class="list-group-item list-group-item-action">${checklist.Text}</li>`);
                                                            item.on("click", function () {
                                                                                $("#checkListName").val(checklist.Text);
                                                                        $("#checkListSuggestions").hide();
                                                            });
                                                            suggestions.append(item);
                                                        });
                                                        suggestions.show();
                                                    }
                                                },
                                                error: function (xhr, status, error) {
                                                    console.error("Error fetching activities: " + error);
                                                }
                                            });
                                        }, 300); 
                                    } else {
                                                $("#checkListSuggestions").empty().hide();
                                    }


                                            const suggestions = $("#checkListSuggestions");

                                    // Handle arrow keys and Enter for navigation
                                    let selectedIndex = -1;
                                            $("#checkListName").on("keydown", function (event) {
                                        const items = suggestions.children("li");

                                        if (items.length > 0) {
                                            if (event.key === "ArrowDown") {
                                                event.preventDefault();
                                                selectedIndex = (selectedIndex + 1) % items.length; 
                                                items.removeClass("active");
                                                items.eq(selectedIndex).addClass("active");
                                                scrollToView(items.eq(selectedIndex));
                                            } else if (event.key === "ArrowUp") {
                                                event.preventDefault();
                                                selectedIndex = (selectedIndex - 1 + items.length) % items.length; 
                                                items.removeClass("active");
                                                items.eq(selectedIndex).addClass("active");
                                                scrollToView(items.eq(selectedIndex));
                                            } else if (event.key === "Enter") {
                                                event.preventDefault();
                                                if (selectedIndex >= 0 && selectedIndex < items.length) {
                                                    const selectedItem = items.eq(selectedIndex);
                                                    $("#activitySearchInput").val(selectedItem.text());
                                                    $("#activityIdInput").val(selectedItem.data("id")); 
                                                    suggestions.hide();
                                                }
                                            }
                                        }
                                    });

                                    function scrollToView(item) {
                                        const container = suggestions;
                                        const offset = item.position().top;
                                        const containerHeight = container.outerHeight();
                                        const itemHeight = item.outerHeight();

                                        if (offset + itemHeight > containerHeight) {
                                            container.scrollTop(container.scrollTop() + offset - containerHeight + itemHeight);
                                        } else if (offset < 0) {
                                            container.scrollTop(container.scrollTop() + offset);
                                        }
                                    }

                                });

                                $(document).on("click", function (event) {
                                    if (!$(event.target).closest("#activitySearchInput, #activitySuggestions").length) {
                                                $("#activitySuggestions").hide();
                                    }
                                });


                            });
                        </script>
                        <style>
                            #activitySuggestions {
                                position: absolute;
                                width: 100%;
                                z-index: 100;
                                max-height: 200px; 
                                overflow-y: auto;
                                border: 1px solid #ccc; 
                                background-color: #fff; 
                                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
                            }

                                #activitySuggestions .list-group-item {
                                    cursor: pointer; 
                                }

                                    #activitySuggestions .list-group-item:hover {
                                        background-color: #f0f0f0; 
                                    }
                        </style>
                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="IsMandatory" />
                            </div>
                            <div class="col-md-4">
                                <nop-editor asp-for="IsMandatory" />
                                <span asp-validation-for="IsMandatory"></span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-3">
                                <nop-label asp-for="OrderBy" />
                            </div>
                            <div class="col-md-4">
                                <nop-editor asp-for="OrderBy" />
                                <span asp-validation-for="OrderBy"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
        var processWorkflowSelector = $('#@Html.IdFor(model => model.ProcessWorkflowId)');
            var statusSelector = $('#statusDropdown');

     $(document).ready(function () {
        getStatusByProcessWorkflow();
        processWorkflowSelector.change(function () {
            getStatusByProcessWorkflow();
        });
    });

      function getStatusByProcessWorkflow() {
            var processWorkflowId = processWorkflowSelector.val();
            var currentStatusId = '@Model.StatusId';
            statusSelector.empty();
            if (processWorkflowId) {

                $.ajax({
                    url: '/Admin/ProjectTask/GetStatusesByProcessWorkflow',
                    type: 'GET',
                    data: {
                        processWorkflowId: processWorkflowId
                    },
                    success: function (data) {
                        statusSelector.empty();
                        console.log(data);
                        if (data && data.length > 0) {
                            $.each(data, function (index, item) {
                                statusSelector.append($('<option>').val(item.Value).text(item.Text));
                            });

                        if (currentStatusId) {
                                    
                        statusSelector.val(currentStatusId).trigger('change');
                    }
                        } else {
                            statusSelector.append($('<option>').val('').text('No statuses available'));
                        }
                    },
                    error: function () {
                        alert('Failed to load statuses.');
                    }
                });
            }
        }
</script>
