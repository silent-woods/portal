@using App.Web.Areas.Admin.Models.Extension.ProjectTasks
@model ProjectTaskSearchModel
@{
    //page title
    ViewBag.PageTitle = T("Admin.Configuration.ProjectTask").Text;
    //active menu item (system name)
    NopHtml.SetActiveMenuItemSystemName("ProjectTask");

    const string hideSearchBlockAttributeName = "ProjectTask.HideSearchBlock";
    var hideSearchBlock = await genericAttributeService.GetAttributeAsync<bool>(await workContext.GetCurrentCustomerAsync(), hideSearchBlockAttributeName);
}


<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<div class="content-header clearfix">
    <h1 class="float-left">
        @T("Admin.Configuration.ProjectTask")
    </h1>
    <div class="float-right">
        @if (await permissionService.AuthorizeAsync(StandardPermissionProvider.ManageProjectTask, PermissionAction.Edit))
        {
            <button id="btnAddLeaveLog" class="btn btn-primary" onclick="javascript:OpenWindow('@(Url.Action("SyncTime", "ProjectTask", new { btnId = "btnRefreshMonthlyLeave", formId = "LeaveTransactionLog-form" }))', 1000, 600, true); return false;">
                <i class="fas fa-sync"></i>
                @T("Admin.Common.SyncTime")
            </button>
        }
        @if (await permissionService.AuthorizeAsync(StandardPermissionProvider.ManageProjectTask, PermissionAction.Add))
        {
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus-square"></i>
                @T("Admin.Common.AddNew")
            </a>
        }
        @if (await permissionService.AuthorizeAsync(StandardPermissionProvider.ManageProjectTask, PermissionAction.Delete))
        {
            <button type="button" id="delete-selected" class="btn btn-danger">
                <i class="far fa-trash-alt"></i>
                @T("Admin.Common.Delete.Selected")
            </button>
            <nop-action-confirmation asp-button-id="delete-selected" />
        }
    </div>

</div>
<section class="content">
    <div class="container-fluid">
        <div class="form-horizontal">
            <div class="cards-group">
                <div class="card card-default card-search">
                    <div class="card-body">
                        <div class="row search-row @(!hideSearchBlock ? "opened" : "")" data-hideAttribute="@hideSearchBlockAttributeName">
                            <div class="search-text">@T("Admin.Common.Search")</div>
                            <div class="icon-search"><i class="fas fa-search" aria-hidden="true"></i></div>
                            <div class="icon-collapse"><i class="far fa-angle-@(!hideSearchBlock ? "up" : "down")" aria-hidden="true"></i></div>
                        </div>

                        <div class="search-body @(hideSearchBlock ? "closed" : "")">
                            <div class="row">

                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <nop-label asp-for="SearchTaskTitle" />
                                        </div>
                                        <div class="col-md-8">
                                            <nop-editor asp-for="SearchTaskTitle" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <nop-label asp-for="SearchTaskId" />
                                        </div>
                                        <div class="col-md-8">
                                            <nop-editor asp-for="SearchTaskId" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <nop-label asp-for="SelectedProjectIds" />
                                        </div>
                                        <div class="col-md-8">
                                            <nop-select asp-for="SelectedProjectIds" asp-items="Model.AvailableProject" asp-multiple="true" />
                                            <script>
                                                $(document).ready(function () {
                                                    var rolesIdsInput =
                                                        $('#@Html.IdFor(model => model.SelectedProjectIds)')
                                                            .data("kendoMultiSelect");
                                                    rolesIdsInput.setOptions({
                                                        autoClose: true,
                                                        filter: "contains"
                                                    });

                                                @if (Model.AvailableProject.Count == 0)
                                                {
                                                    <text>
                                                            rolesIdsInput.setOptions({
                                                                enable: false,
                                                                placeholder:
                                                                    '@T("Admin.Catalog.Products.CustomerRoles.NoCustomerRolesAvailable")'
                                                            });
                                                        rolesIdsInput._placeholder();
                                                        rolesIdsInput._enable();
                                                    </text>
                                                }
                                                                                                                                                                                            });
                                            </script>
                                        </div>
                                    </div>
                                </div>

                            <script>
                                $(document).ready(function () {
                                    $("#projectDropdown").kendoDropDownList({
                                        dataTextField: "Text",
                                        dataValueField: "Value",
                                        filter: "contains",
                                        autoBind: false,
                                        dataSource: @Html.Raw(Json.Serialize(Model.AvailableProject)),
                                        change: function (e) {
                                            var searchProjectId = $('#projectDropdown').val();

                                            $('#SearchProjectId').val(searchProjectId);
                                        }
                                    });
                                });
                                </script>

                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <nop-label asp-for="SearchTaskTypeId" />
                                        </div>
                                        <div class="col-md-8">
                                            <nop-select asp-for="SearchTaskTypeId" asp-items="Model.AvailableTaskTypes" />
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                            <div class="row">

                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <nop-label asp-for="SelectedEmployeeIds" />
                                        </div>
                                        <div class="col-md-8">
                                            <nop-select asp-for="SelectedEmployeeIds" asp-items="Model.AvailableEmployees" asp-multiple="true" />
                                            <script>
                                                $(document).ready(function () {
                                                    var rolesIdsInput =
                                                        $('#@Html.IdFor(model => model.SelectedEmployeeIds)')
                                                            .data("kendoMultiSelect");
                                                    rolesIdsInput.setOptions({
                                                        autoClose: true,
                                                        filter: "contains"
                                                    });

                                                @if (Model.AvailableEmployees.Count == 0)
                                                {
                                                    <text>
                                                            rolesIdsInput.setOptions({
                                                                enable: false,
                                                                placeholder:
                                                                    '@T("Admin.Catalog.Products.CustomerRoles.NoCustomerRolesAvailable")'
                                                            });
                                                        rolesIdsInput._placeholder();
                                                        rolesIdsInput._enable();
                                                    </text>
                                                }
                                                                                                                                                                                            });
                                            </script>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <nop-label asp-for="SearchProcessWorkflowId" />
                                        </div>
                                        <div class="col-md-8">
                                            <nop-select asp-for="SearchProcessWorkflowId" asp-items="Model.AvailableProcessWorkflow" />
                                        </div>
                                    </div>
                                </div>

                                <script>
                                    var processWorkflowSelector = $('#@Html.IdFor(model => model.SearchProcessWorkflowId)');
                                    var statusSelector = $('#SearchStatusId');
                                               processWorkflowSelector.change(function () {
                                        getStatusByProcessWorkflow()

                                        });

                                      function getStatusByProcessWorkflow() {

                                        var processWorkflowId = processWorkflowSelector.val();

                                        statusSelector.empty();
                                        if (processWorkflowId) {

                                            $.ajax({
                                                url: '/ProjectTask/GetStatusesByProcessWorkflow',
                                                type: 'GET',
                                                data: {
                                                    processWorkflowId: processWorkflowId

                                                },
                                                success: function (data) {
                                                    statusSelector.empty();
                                                    console.log(data);
                                                    if (data && data.length > 0) {
                                                        $.each(data, function (index, item) {
                                                            statusSelector.append($('<option>').val(item.Value).text(item.Text));
                                                        });
                                                    } else {
                                                        statusSelector.append($('<option>').val('').text('No statuses available'));
                                                    }
                                                },
                                                error: function () {
                                                    alert('Failed to load statuses.');
                                                }
                                            });
                                        }
                                    }
                                </script>
                               
                              
                               
                                  <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <nop-label asp-for="DueDate" />
                                        </div>
                                        <div class="col-md-8">
                                            <nop-editor asp-for="DueDate" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <nop-label asp-for="SearchStatusId" />
                                        </div>
                                        <div class="col-md-8">
                                            <select id="SearchStatusId" name="SearchStatusId" asp-for="SearchStatusId" asp-items="Model.AvailableStatus" class="form-control"></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <nop-label asp-for="SearchParentTaskId" />
                                        </div>
                                        <div class="col-md-8">
                                            <div style="position: relative;">
                                                <select id="SearchParentTaskId" name="SearchParentTaskId" class="form-control" style="border: none; box-shadow: none;">
                                                    <option value=""></option>
                                                    @foreach (var task in Model.AvailableParentTasks)
                                                    {
                                                        <option value="@task.Value">@task.Text</option>
                                                    }
                                                </select>
                                                
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                <script>
                                    $(document).ready(function () {
                                        $("#SearchParentTaskId").kendoDropDownList({
                                            optionLabel: "Select a task",
                                            dataTextField: "Text",
                                            dataValueField: "Value",
                                            filter: "contains",
                                            autoBind: false,
                                            minLength: 1,
                                            dataSource: {
                                                type: "json",
                                                serverFiltering: true,
                                                transport: {
                                                    read: {
                                                        url: "/Admin/ProjectTask/GetParentTasksByFilter",
                                                        dataType: "json"
                                                    },
                                                    parameterMap: function (data, type) {
                                                        var searchTerm = "";
                                                        if (data.filter && data.filter.filters && data.filter.filters.length > 0) {
                                                            searchTerm = data.filter.filters[0].value || "";
                                                        }
                                                        return { term: searchTerm };
                                                    }
                                                }
                                            }
                                        });
                                    });
                                </script>

                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <nop-label asp-for="SearchDeliveryOnTime" />
                                        </div>
                                        <div class="col-md-8">
                                            <select id="SearchDeliveryOnTime" name="SearchDeliveryOnTime" asp-for="SearchDeliveryOnTime" asp-items="Model.AvailableDeliveryOnTime" class="form-control"></select>

                                        </div>
                                    </div>
                                </div>
                                <script>
                                    $(document).ready(function () {
                                        function formatStatus(state) {
                                            if (!state.id) return state.text;

                                            const [text, color] = state.text.split("|||");
                                            return $(`
                                                <div style="display: flex; align-items: center; gap: 6px;">
                                                    <div style="flex-shrink: 0;width: 12px; height: 12px; border-radius: 50%; background-color: ${color};"></div>
                                                    <span>${text}</span>
                                                </div>
                                            `);
                                        }

                                    $('#SearchStatusId').select2({
                                            templateResult: formatStatus,
                                            templateSelection: formatStatus,
                                            escapeMarkup: function (m) { return m; },
                                             minimumResultsForSearch: Infinity
                                        });
                                    });
                                </script>
                            <style>
                                    .select2-container .select2-selection--single{
                                        height:35px;
                                        padding-left:0px;
                                    }

                                    .select2-container--default .select2-selection--single .select2-selection__arrow {
                                        height: 35px;
                                    }
                            </style>
                            </div>

                            <div class="row">
                                <div class="text-center col-12">
                                    <button type="button" id="search-brands" class="btn btn-primary btn-search">
                                        <i class="fas fa-search"></i>
                                        @T("Admin.Common.Search")
                                    </button>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
                <div id="status-summary" style="overflow-x: auto; max-width: 100%; background-color: #f9f9f9; padding: 16px; margin-top: 20px; margin-bottom: 5px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);"></div>

                <div class="card card-default">
                    <div class="card-body">
                        @{
                            var gridModel = new DataTablesModel
                            {
                                Name = "projecttask-grid",
                                UrlRead = new DataUrl("List", "ProjectTask", null),
                                SearchButtonId = "search-brands",
                                Length = Model.PageSize,
                                LengthMenu = Model.AvailablePageSizes,
                                Filters = new List<FilterParameter>
                                {
                                    new FilterParameter(nameof(Model.SearchTaskTitle)),
                                    new FilterParameter(nameof(Model.SearchStatusId)),
                                    new FilterParameter(nameof(Model.SearchTaskId)),
                                    new FilterParameter(nameof(Model.SelectedProjectIds)),
                                    new FilterParameter(nameof(Model.SearchTaskTypeId)),
                                    new FilterParameter(nameof(Model.SelectedEmployeeIds)),
                                    new FilterParameter(nameof(Model.SearchProcessWorkflowId)),
                                    new FilterParameter(nameof(Model.DueDate)),
                                    new FilterParameter(nameof(Model.SearchDeliveryOnTime)),
                                    new FilterParameter(nameof(Model.SearchParentTaskId))
                                },
                            };

                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.Id))
                            {
                                IsMasterCheckBox = true,
                                Render = new RenderCheckBox("checkbox_project_tasks"),
                                ClassName = NopColumnClassDefaults.CenterAll,
                                Width = "30"
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.Id))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.TaskId").Text
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.TaskTitle))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.TaskTitle").Text,
                                Render = new RenderCustom("renderTaskLink")
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.TaskTypeName))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.TaskTypeName").Text
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.ParentTaskName))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.ParentTaskName").Text
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.ProjectName))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.ProjectName").Text
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.Status))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.Status").Text,
                                Render = new RenderCustom("renderStatusDot"),
                                Width = "110"
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.AssignedEmployee))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.AssignedEmployee").Text
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.EstimationTimeHHMM))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.EstimationTimeHHMM").Text
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.SpentTime))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.SpentTime").Text
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.DueDateFormat))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.DueDate").Text,
                                Width = "100",
                                Encode = false
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.WorkQualityFormat))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.WorkQuality").Text
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.DeliveryOnTime))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.DeliveryOnTime").Text,
                                Render = new RenderCustom("renderDeliveredWithDot")
                            });
                            gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.CreatedOnUtc))
                            {
                                Title = T("Admin.Extension.ProjectTask.Fields.CreatedOnUtc").Text,
                                Render = new RenderDate()
                            });
                            @if (await permissionService.AuthorizeAsync(StandardPermissionProvider.ManageProjectTask, PermissionAction.Edit))
                            {
                                gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ProjectTaskModel.Id))
                                {
                                    Title = T("Admin.Common.Edit").Text,
                                    Width = "80",
                                    ClassName = NopColumnClassDefaults.Button,
                                    Render = new RenderButtonEdit(new DataUrl("Edit"))
                                });
                            }
                        }
                        @await Html.PartialAsync("Table", gridModel)
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        function renderTaskLink(data, type, row, meta) {
            if (!row.Id) return data || "";

            return `
                <div
                    onclick="window.open('/ProjectTask/Edit?id=${row.Id}', '_blank')"
                    style="cursor: pointer; color: inherit; text-decoration: none;"
                    onmouseover="this.style.color='blue'; this.style.textDecoration='underline';"
                    onmouseout="this.style.color='inherit'; this.style.textDecoration='none';"
                >
                    ${data}
                </div>
            `;
        }
        function renderDeliveredWithDot(data, type, row) {
            var iconHtml = '';
            if (data === true) {
                iconHtml = '<i class="fa fa-check true-icon" style="color:green;"></i>';
            } else {
                iconHtml = '<i class="fa fa-times false-icon" style="color:red;"></i>';
            }

            var dot = row.DOTPercentage != null ? ` <span style="font-size: 90%;">(${row.DOTPercentage.toFixed(2)}%)</span>` : '';

            return iconHtml + dot;
        }
        function renderStatusDot(data, type, row, meta) {
            if (!data) return '';

            const parts = data.split("|||");
            const text = parts[0];
            const color = parts[1] ;

            return `
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${color};"></div>
                    <span>${text}</span>
                </div>`;
        }
    </script>

    <script>
        function loadStatusSummary() {
            const data = {
                SearchTaskTitle: $('#SearchTaskTitle').val(),
                SearchStatusId: $('#SearchStatusId').val(),
                SearchTaskId: $('#SearchTaskId').val(),
                SelectedProjectIds: $('#SelectedProjectIds').val(),
                SearchTaskTypeId: $('#SearchTaskTypeId').val(),
                SelectedEmployeeIds: $('#SelectedEmployeeIds').val(),
                SearchProcessWorkflowId: $('#SearchProcessWorkflowId').val(),
                DueDate: $('#DueDate').val(),
                SearchDeliveryOnTime: $('#SearchDeliveryOnTime').val(),
                SearchParentTaskId: $('#SearchParentTaskId').val()

            };
            addAntiForgeryToken(data);

            $.post('@Url.Action("GetStatusSummary", "ProjectTask")', data, function (response) {
                const container = $('#status-summary');
                container.empty();

                const grouped = {};
                response.forEach(item => {
                    if (!grouped[item.WorkflowId]) grouped[item.WorkflowId] = {
                        WorkflowName: item.WorkflowName,
                        Statuses: []
                    };
                    grouped[item.WorkflowId].Statuses.push(item);
                });

                const table = $('<table style="border-collapse: collapse; min-width: 100%; width: max-content; background-color: #fff; border: 1px solid #ddd;"></table>');

                for (const [workflowId, data] of Object.entries(grouped)) {
                    const { WorkflowName, Statuses } = data;

                    const row = $('<tr></tr>');
                    const workflowCell = $(`
                        <td style="padding: 12px 16px; border: 1px solid #ddd; font-weight: bold; background-color: #e9f0f5; white-space: nowrap;">
                            ${WorkflowName}
                        </td>`);
                    row.append(workflowCell);

                    Statuses.forEach(s => {
                        const cell = $(`
                            <td style="padding: 12px 16px; border: 1px solid #ddd; background-color: #fefefe;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background-color: ${s.ColorCode};"></div>
                                    <span>${s.StatusName} (${s.TaskCount})</span>
                                </div>
                            </td>
                        `);
                        row.append(cell);
                    });

                    table.append(row);
                }

                container.append(table);
            });
        }

        function afterGridReloaded() {
            loadStatusSummary();
        }

            
        $(document).ready(function () {
            $('#projecttask-grid').on('draw.dt', function () {
                afterGridReloaded();
            });
        });
    

        $('#delete-selected-action-confirmation-submit-button').bind('click', function () {
            var postData = {
                selectedIds: selectedIds
            };
            addAntiForgeryToken(postData);
            $.ajax({
                cache: false,
                type: "POST",
                url: "@(Url.Action("DeleteSelected", "ProjectTask"))",
                data: postData,
                error: function (jqXHR, textStatus, errorThrown) {
                    showAlert('deleteSelectedFailed', errorThrown);
                },
                complete: function (jqXHR, textStatus) {
                    if (jqXHR.status === 204) {
                        showAlert('nothingSelectedAlert', '@T("Admin.Common.Alert.NothingSelected")');
                        return;
                    }
                    updateTable('#projecttask-grid');

                }
            });
            $('#delete-selected-action-confirmation').modal('toggle');
            return false;
        });
    </script>
    <nop-alert asp-alert-id="deleteSelectedFailed" />
    <nop-alert asp-alert-id="nothingSelectedAlert" />
</section>


                 