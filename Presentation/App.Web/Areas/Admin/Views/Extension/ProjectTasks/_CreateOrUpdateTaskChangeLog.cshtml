@using App.Web.Areas.Admin.Models.Extension.ProjectTasks
@using App.Web.Areas.Admin.Models.Extension.TaskChangeLogs
@model ProjectTaskModel

<div class="card-body">
    @if (Model.Id > 0)
    {
        <div class="card card-default">
            <div class="card-body">
                @{
                    var gridModel = new DataTablesModel
                    {
                        Name = "TaskChangeLog-grid",
                        UrlRead = new DataUrl("List", "TaskChangeLog", new RouteValueDictionary { [nameof(Model.TaskChangeLogSearchModel.SearchTaskId)] = Model.Id }),
                        UrlDelete = new DataUrl("Delete", "TaskChangeLog", new RouteValueDictionary { [nameof(Model.Id)] = Model.TaskChangeLogModel.FirstOrDefault()?.Id }),
                        Length = Model.TaskChangeLogSearchModel.PageSize,
                        LengthMenu = Model.TaskChangeLogSearchModel.AvailablePageSizes,
                    };

                    gridModel.ColumnCollection.Add(new ColumnProperty(nameof(TaskChangeLogModel.TaskName))
                    {
                        Title = T("Admin.TaskChangeLog.Fields.TaskName").Text,
                        Width = "200"
                    });
                    gridModel.ColumnCollection.Add(new ColumnProperty(nameof(TaskChangeLogModel.EmployeeName))
                    {
                        Title = T("Admin.TaskChangeLog.Fields.EmployeeName").Text,
                        Width = "200"
                    });
                    gridModel.ColumnCollection.Add(new ColumnProperty(nameof(TaskChangeLogModel.LogTypeName))
                    {
                        Title = T("Admin.TaskChangeLog.Fields.LogTypeName").Text,
                        Width = "200"
                    });
                    gridModel.ColumnCollection.Add(new ColumnProperty(nameof(TaskChangeLogModel.Notes))
                    {
                        Title = T("Admin.TaskChangeLog.Fields.Notes").Text,
                        Width = "200"
                    });
                    gridModel.ColumnCollection.Add(new ColumnProperty(nameof(TaskChangeLogModel.CreatedOn))
                    {
                        Title = T("Admin.TaskChangeLog.Fields.CreateOn").Text,
                        Width = "150",
                        Render = new RenderDate()
                    });
                    @if (await permissionService.AuthorizeAsync(StandardPermissionProvider.ManageProjectTaskChangeLog, PermissionAction.Delete))
                    {
                        gridModel.ColumnCollection.Add(new ColumnProperty(nameof(TaskChangeLogModel.Id))
                        {
                            Title = T("Admin.Common.Delete").Text,
                            Width = "100",
                            Render = new RenderButtonRemove(T("Admin.Common.Delete").Text),
                            ClassName = NopColumnClassDefaults.Button
                        });
                    }
                }
                @await Html.PartialAsync("Table", gridModel)
            </div>
            <script>
                function renderColumnEdit(data, type, row, meta) {
                    var projectId = @Model.Id;
                    var url = '@Url.Action("Edit", "ProjectEmployeeMapping")' + '?projectId=' + projectId + '&id=' + data;
                    return '<button onclick="javascript:OpenWindow(\'' + url + '&btnId=btnRefreshProjectEmp&formId=project-form\', 800, 800, true); return false;" class="btn btn-default"><i class="fas fa-pencil-alt"></i>@T("Admin.Common.Edit").Text</button>';
                }

                $(document).ready(function () {
                    $(window).on('refreshGrid', function () {
                        updateTable('#projectempmapping-grid');
                        console.log("Grid refreshed");
                    });
                });
            </script>

        </div>
    }
    else
    {
        <div class="card card-default">
            <div class="card-body">
                @T("Admin.Catalog.Products.SpecificationAttributes.SaveBeforeEdit")
            </div>
        </div>
    }
</div>
