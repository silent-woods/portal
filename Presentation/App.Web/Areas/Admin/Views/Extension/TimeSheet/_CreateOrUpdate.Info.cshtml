@model App.Web.Areas.Admin.Models.TimeSheets.TimeSheetModel

<section class="content">
    <div class="container-fluid">
        <div class="form-horizontal">
            <div class="cards-group">
                <div class="card card-default card-popup">
                    <div class="card-body">
                        <form asp-action="SaveNew" method="post" id="timeSheetForm">
                            <!-- Employee Name and Spent Date Section -->
                            <div class="form-group row">
                                <div class="col-sm-3">
                                    <nop-label asp-for="SelectedEmployeeId" />
                                </div>
                                <div class="col-md-4">
                                    <div style="position: relative;">
                                        <select id="employeeDropdown" name="SelectedEmployeeId" class="form-control" style="border: none; box-shadow: none;">
                                            <option value=""></option>
                                            @foreach (var employee in Model.AvailableEmployees)
                                            {
                                                <option value="@employee.Value">@employee.Text</option>
                                            }
                                        </select>
                                        <span style="color:red; font-weight:bold; position: absolute; right: -12px; top: 15px;">*</span>
                                        <span style="color:red;" id="employeeError"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group row">
                                <div class="col-md-3">
                                    <nop-label asp-for="SpentDate" />
                                </div>
                                <div class="col-md-4">
                                    <nop-editor asp-for="SpentDate" class="form-control" />
                                    <span style="color:red; " id="dateError"></span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="text-center col-12">
                                    <button type="button" id="searchButton" class="btn btn-primary
                                         btn-search">
                                        <i class="fas fa-search"></i>
                                        @T("Admin.Common.Search")
                                    </button>
                                </div>
                            </div>
                           
                            <div id="tableContainer" style="display: none; margin-top:3%;">
                                <!-- Dynamic Grid Section -->
                                <div class="table-responsive" style="margin-bottom:1%;">

                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>@Html.DisplayNameFor(model => model.TimeSheetRows.First().ProjectId)</th>
                                                <th>@Html.DisplayNameFor(model => model.TimeSheetRows.First().TaskId)</th>
                                                <th>@Html.DisplayNameFor(model => model.TimeSheetRows.First().ActivityName)</th>
                                                <th>@Html.DisplayNameFor(model => model.TimeSheetRows.First().EstimatedHours)</th>
                                                <th>@Html.DisplayNameFor(model => model.TimeSheetRows.First().TotalSpent)</th>
                                                <th>@Html.DisplayNameFor(model => model.TimeSheetRows.First().SpentTime)</th>
                                                <th>@Html.DisplayNameFor(model => model.TimeSheetRows.First().Billable)</th>

                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="timeSheetTableBody">

                                            <!-- Rows will be populated here -->
                                        </tbody>
                                    </table>

                                </div>
                                <div class="form-group row">

                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-primary" id="addRowButton">Add Row</button>
                                       @*  <button id="btnAddNewProjectTask" class="btn btn-primary" onclick="javascript:OpenWindow('@(Url.Action("CreateProjectTask", "TimeSheet", new { employeeId= @ViewBag.EmployeeId,btnId="btnRefreshProjectTask", formId="PeojectTask-form" }))', 770, 400, true); return false;">
                                            @T("Admin.Catalog.Timesheet.ProjectTaskAdd")
                                        </button> *@
                                        <button type="button" id="fetchRecentBtn" class="btn btn-primary fetch-recent-btn" onclick="fetchRecentEntries()" style="display:none">Recent Entries</button>

                                    </div>

                                    <div class="col-md-6 text-right">
                                        <button class="btn btn-success" id="SaveNew">
                                            @T("Admin.Common.SaveNewChanges")
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

  
    <script>
        function fetchRecentEntries() {
            var employeeId = $('#employeeDropdown').val();
            var spentDate = $('input[name="SpentDate"]').val();
            $.ajax({
                url: '@Url.Action("GetRecentEntries", "TimeSheet")',
                type: 'GET',
                data: { employeeId: employeeId, spentDate: spentDate },
                success: function (data) {
                    $('#timeSheetTableBody').empty();  // Clear existing rows
                    if (data.length > 0) {
                        $.each(data, function (index, row) {
                            $('#addRowButton').click();  // Add a new row using the existing function

                            var lastRow = $('#timeSheetTableBody tr:last');  // Get the last added row

                            // Initialize the dropdowns for the last row (if not already initialized)
                            var projectDropdown = lastRow.find('select[name$=".ProjectId"]').data("kendoDropDownList");
                            var taskDropdown = lastRow.find('select[name$=".TaskId"]').data("kendoDropDownList");

                            if (projectDropdown && taskDropdown) {
                                // Set the project and trigger change to load the tasks
                                projectDropdown.value(row.ProjectId);
                                projectDropdown.trigger('change');
                                projectDropdown.refresh();
                                // lastRow.find(`input[name$=".ActivityName"]`).val(row.ActivityName);

                                // Fetch tasks for the selected project
                                $.ajax({
                                    url: '@Url.Action("GetTasksByProject", "TimeSheet")',
                                    type: 'GET',
                                    data: { projectId: row.ProjectId },
                                    success: function (taskData) {
                                        taskDropdown.setDataSource(taskData);  // Load tasks into dropdown
                                        taskDropdown.value(row.TaskId);  // Set the selected task
                                        taskDropdown.trigger('change');
                                        taskDropdown.refresh();
                                        lastRow.find(`input[name$=".ActivityName"]`).val(row.ActivityName);
                                    },
                                    error: function (xhr, status, error) {
                                        console.log("Error fetching tasks: " + error);
                                    }
                                });

                                // Fetch estimated time and total spent for the task
                                $.ajax({
                                    url: '@Url.Action("GetEstimatedTimeByTask", "TimeSheet")',
                                    type: 'GET',
                                    data: { taskId: row.TaskId, projectId: row.ProjectId },
                                    success: function (estData) {
                                        lastRow.find(`input[name$=".EstimatedHours"]`).val(estData.EstimatedTime);
                                        lastRow.find(`input[name$=".TotalSpent"]`).val(estData.TotalSpent);
                                        lastRow.find(`input[name$=".ActivityName"]`).val(row.ActivityName);

                                    },
                                    error: function (xhr, status, error) {
                                        console.log("Error fetching estimated time: " + error);
                                    }
                                });

                                // Set billable checkbox status
                                lastRow.find(`input[name$=".Billable"]`).prop('checked', row.Billable);
                            } else {
                                console.error("Dropdowns are not properly initialized for row " + index);
                            }
                        });
                    }

                    else {
                        $('#addRowButton').click();
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error fetching recent entries: " + error);
                }
            });
        }
        $(document).ready(function () {
            // Initialize Kendo DropDownList for employees
            $("#employeeDropdown").kendoDropDownList({
                optionLabel: "Select an employee",
                dataTextField: "Text",
                dataValueField: "Value",
                filter: "contains",
                autoBind: false,
                dataSource: @Html.Raw(Json.Serialize(Model.AvailableEmployees))
                                                });
            $('#addRowButton').hide();
            // Function to initialize Kendo DropDownLists for project and initializeDropdowns
            function initializeDropdowns(index, projectId, taskId, SpentTime) {
                // Initialize Project DropDown
                var projectDropdown = $(`#projectDropdown${index}`).kendoDropDownList({
                    optionLabel: "Select a project",
                    dataTextField: "Text",
                    dataValueField: "Value",
                    filter: "contains",
                    autoBind: false,

                    dataSource: @Html.Raw(Json.Serialize(Model.Projects)),
                    change: function () {
                        var projectId = this.value();
                        // Get the original value of TaskId
                        var originalProjectId = $(`input[name="TimeSheetRows[${index}].prevProjectId"]`).val();

                        // Clear ActivityName only if the task value has changed
                        if (projectId !== originalProjectId) {
                            $(`input[name="TimeSheetRows[${index}].ActivityName"]`).val("");
                        }
                        $(`input[name="TimeSheetRows[${index}].ProjectId"]`).val(projectId); // Set the ProjectId value

                        $(`input[name="TimeSheetRows[${index}].EstimatedHours"]`).val(0);
                        $(`input[name="TimeSheetRows[${index}].TotalSpent"]`).val("");
                        $(`input[name="TimeSheetRows[${index}].TaskId"]`).val(0);
                     
                        //Get Tasks By Project
                        $.ajax({
                            url: '@Url.Action("GetTasksByProject", "TimeSheet")',
                            type: 'GET',
                            data: { projectId: projectId },
                            success: function (data) {
                                var taskDropdown = $(`#taskDropdown${index}`).data("kendoDropDownList");
                                taskDropdown.dataSource.data(data);
                                taskDropdown.refresh();
                            },
                            error: function (xhr, status, error) {
                                console.log("Error fetching tasks: " + error);
                            }
                        });
                    },
                  

                }).data("kendoDropDownList");
             
                // Initialize Task DropDown
                var taskDropdown = $(`#taskDropdown${index}`).kendoDropDownList({
                    optionLabel: "Select a task",
                    dataTextField: "Text",
                    dataValueField: "Value",
                    filter: "contains",
                    autoBind: false,
                    dataSource: [],
                    change: function () {
                        var taskId = this.value();
                        // Get the original value of TaskId
                        var originalTaskId = $(`input[name="TimeSheetRows[${index}].prevTaskId"]`).val();


                        // Clear ActivityName only if the task value has changed
                        if (taskId !== originalTaskId) {
                            $(`input[name="TimeSheetRows[${index}].ActivityName"]`).val("");
                        }

                        $(`input[name="TimeSheetRows[${index}].TaskId"]`).val(taskId); 
                      
                        $.ajax({
                            url: '@Url.Action("GetEstimatedTimeByTask", "TimeSheet")',
                            type: 'GET',
                            data: { taskId: taskId },
                            success: function (data) {
                                console.log(data);
                                $(`input[name="TimeSheetRows[${index}].EstimatedHours"]`).val(data.EstimatedTime);
                                $(`input[name="TimeSheetRows[${index}].TotalSpent"]`).val(data.TotalSpent);

                            },
                            error: function (xhr, status, error) {
                                console.log("Error fetching estimated time: " + error);
                            }
                        });
                    }
                }).data("kendoDropDownList");

                // Set the initial values for project and task dropdowns if provided
                if (projectId) {
                    projectDropdown.value(projectId);
                }

                if (taskId) {
                    $.ajax({
                        url: '@Url.Action("GetTasksByProject", "TimeSheet")',
                        type: 'GET',
                        data: { projectId: projectId },
                        success: function (data) {
                            taskDropdown.dataSource.data(data);
                            taskDropdown.refresh();
                            taskDropdown.value(taskId);
                        },
                        error: function (xhr, status, error) {
                            console.log("Error fetching tasks: " + error);
                        }
                    });
                }

                
                if (taskId > 0) {
                    var row = $(this).closest('tr');
                    // Store the original spentHours value in a hidden input field
                    row.find(`input[name="TimeSheetRows[${index}].prevTaskId"]`).val(taskId);
                }
            
            if (SpentTime) {


                // Store the original SpentTime value in a hidden input field
                row.find(`input[name="TimeSheetRows[${index}].prevSpentTime"]`).val(SpentTime);
            }
        }

            var prevrowIndex = 0;


            // Handle adding rows
            $('#addRowButton').click(function () {
                var rowIndex = $('#timeSheetTableBody tr').length;
                if (rowIndex <= prevrowIndex) {
                    rowIndex = prevrowIndex + 1;
                }
                console.log("rowIndex", rowIndex);
                var newRow = `<tr data-index="${rowIndex}" data-new="true">
                                                            <td class="col-md-2">

                                                                <input type="hidden" name="TimeSheetRows[${rowIndex}].ProjectId" value="" />
                                                                        <select id="projectDropdown${rowIndex}" name="TimeSheetRows[${rowIndex}].ProjectId" class="form-control project-dropdown"  style = "border: none; box-shadow: none;"></select>
                                                                                <span class="projectError" style="color:red;"></span>
                                                            </td>
                                                            <td class="col-md-4">
                                                                    <input type="hidden" name="TimeSheetRows[${rowIndex}].TaskId" value="" />
                                                                <select id="taskDropdown${rowIndex}" name="TimeSheetRows[${rowIndex}].TaskId" class="form-control task-dropdown"  style = "border: none; box-shadow: none;"></select>
                                                                        <span class="taskError" style="color:red;"></span>
                                                            </td>
                                                                                                       <td class="col-md-4">
            <input type="text" id="activitySearchInput${rowIndex}" name="TimeSheetRows[${rowIndex}].ActivityName"
                class="form-control activity-search-input"
                placeholder="Search or enter a new activity" autocomplete="off" />
            <div id="activityContainer${rowIndex}" style="position: relative;">
                <ul id="activitySuggestions${rowIndex}" class="list-group activity-suggestions" style="display: none;"></ul>
            </div>
            <span class="activityError" style="color:red;"></span>
        </td>
                                                            <td class="col-md-1">
                                                                        <input type="text" name="TimeSheetRows[${rowIndex}].EstimatedHours" class="form-control col-sm-9" style="width:90px;" readonly="readonly" />
                                                            </td>
                                                                    <td class="col-md-1">
                                                                                <input type="text" name="TimeSheetRows[${rowIndex}].TotalSpent"  class="form-control col-sm-9" style="width:90px;" readonly="readonly" />
                                                                    </td>
                                                            <td class="col-md-3">
                                                                       <input type="text" name="TimeSheetRows[${rowIndex}].SpentTime"
                       class="form-control col-sm-12 spentTimeInput"
                       style="width: 72px; text-align: center;"
                       maxlength="5"
                       placeholder="HH:MM"
                               autocomplete="off" />
                                                 <span class="spentTimeError" style="color:red;"></span>
                                                            </td>
                                                            <td class="col-md-1" style="text-align: center; vertical-align: middle;">
                                                                <input type="checkbox" name="TimeSheetRows[${rowIndex}].Billable" value="true" style="width: 16px; height: 16px;" />
                                                            </td>
                                                                            <input type="hidden" name="TimeSheetRows[${rowIndex}].IsNewEntry" value="true" />
                                                            <td class="col-md-1">
                                                                <button type="button" class="btn btn-danger remove-row">Remove</button>
                                                            </td>
                                                        </tr>`;
                $('#timeSheetTableBody').append(newRow);

                prevrowIndex = rowIndex;
                initializeDropdowns(rowIndex);
                initializeActivitySearch(rowIndex);
            });


            function initializeActivitySearch(rowIndex) {
                const activityInput = $(`#activitySearchInput${rowIndex}`);
                const suggestionsContainer = $(`#activitySuggestions${rowIndex}`);

                // Trigger suggestions when typing in the input
                activityInput.on("input", function () {
                    const taskId = $(`#taskDropdown${rowIndex}`).val();
                    const query = $(this).val().trim();
                 
                    if (query.length > 0) {
                        $.ajax({
                            url: '@Url.Action("SearchActivities", "TimeSheet")',
                            type: 'GET',
                            data: { searchText: query, taskId: taskId },
                            success: function (data) {
                                suggestionsContainer.empty().hide(); // Clear old suggestions

                                if (data && data.length > 0) {
                                    data.forEach(activity => {
                                        const suggestionItem = $(
                                            `<li class="list-group-item list-group-item-action" style="cursor: pointer;">
                                            ${activity.Text}
                                        </li>`
                                        );

                                        // Handle selecting a suggestion
                                        suggestionItem.on("click", function () {
                                            activityInput.val(activity.Text); // Set selected text in the input field
                                            suggestionsContainer.empty().hide(); // Hide suggestions
                                        });

                                        suggestionsContainer.append(suggestionItem);
                                    });

                                    // Display the suggestions
                                    suggestionsContainer.show();
                                }
                            },
                            error: function () {
                                console.error("Failed to fetch activities.");
                            }
                        });
                    } else {
                        suggestionsContainer.empty().hide(); // Hide if input is empty
                    }
                });

                // Hide suggestions when clicking outside the input or suggestion list
                $(document).on("click", function (e) {
                    if (!$(e.target).closest(`#activitySearchInput${rowIndex}, #activitySuggestions${rowIndex}`).length) {
                        suggestionsContainer.hide();
                    }
                });
            }


            // Handle removing rows
            $(document).on('click', '.remove-row', function () {
                var row = $(this).closest('tr');
                var id = row.find('input[name^="TimeSheetRows["][name$="].Id"]').val();
                removeRow(row, id);
            });

            // Handle search functionality
            $('#searchButton').click(function () {
                var employeeId = $('#employeeDropdown').val();
                var spentDate = $('input[name="SpentDate"]').val();
                var today = new Date();
                if (!employeeId) {
                    $('#employeeError').text('Please select an employee.');
                } else {
                    $('#employeeError').text('');
                }

                if (!spentDate) {
                    $('#dateError').text('Please enter a spent date.');
                } else {
                    var spentDateObj = new Date(spentDate);
                    if (spentDateObj > today) {
                        $('#dateError').text('Spent date cannot be in the future.');
                    } else {
                        $('#dateError').text('');
                    }
                }
                if (employeeId && spentDate && spentDateObj <= today) {
                    $.ajax({
                        url: '@Url.Action("GetPreviousEntries", "TimeSheet")',
                        type: 'GET',
                        data: { employeeId: employeeId, spentDate: spentDate },
                        success: function (data) {
                            $('#timeSheetTableBody').empty(); // Clear existing rows
                            if (data.length > 0) {
                                $.each(data, function (index, row) {
                                   
                                var newRow = ` <tr data-index="${index}" data-new="false" style="background-color: #fafafa;" data-original-project-id="${row.ProjectId}" data-original-task-id="${row.TaskId}" data-original-spent-time="${row.SpentTime}" data-original-activity-name="${row.ActivityName}" data-original-billable="${row.Billable}" data-original-estimated-hours="${row.EstimatedHours}" data-original-total-spent="${row.TotalSpent}">
                      <input type="hidden" name="TimeSheetRows[${index}].Id" value="${row.Id}" />
                      <td class="col-md-2">
                        <input type="hidden" name="TimeSheetRows[${index}].ProjectId" value="${row.ProjectId}" class="col-md-1" />
                        <select id="projectDropdown${index}" name="TimeSheetRows[${index}].ProjectId" class="form-control project-dropdown" disabled style="border: none; box-shadow: none;"></select>
                        <span class="projectError" style="color:red;"></span>
                      </td>
                      <td class="col-md-4">
                        <input type="hidden" name="TimeSheetRows[${index}].TaskId" value="${row.TaskId}" />
                        <select id="taskDropdown${index}" name="TimeSheetRows[${index}].TaskId" class="form-control task-dropdown" disabled style="border: none; box-shadow: none;"></select>
                        <span class="taskError" style="color:red;"></span>
                        <input type="hidden" name="TimeSheetRows[${index}].prevTaskId" value="${row.TaskId}" />
                      </td>

                <td class="col-md-4" >
                      <input type="text" id="activitySearchInput${index}" name="TimeSheetRows[${index}].ActivityName" class="form-control activity-search-input" placeholder="Search or enter a new activity" autocomplete="off" value="${row.ActivityName}" readonly="readonly" />
                                    <div id="activityContainer${index}" style="position: relative;">
                                     <ul id="activitySuggestions${index}" class="list-group activity-suggestions" style="display: none; "></ul>
                                    </div>
                            <input type="hidden" name="TimeSheetRows[${index}].prevActivityName" value="${row.ActivityName}" />
                    <span class="activityError" style="color:red;"></span>
                </td>

                      <td class="col-md-3">
                                        <input type="text" name="TimeSheetRows[${index}].EstimatedHours" class="form-control col-sm-9" style="width:90px;" value="${row.EstimatedTimeHHMM}" readonly="readonly" />
                      </td>
                      <td class="col-md-3">
                        <input type="text" name="TimeSheetRows[${index}].TotalSpent" class="form-control col-sm-9" style="width:90px;" value="${row.TotalSpent}" readonly="readonly" />
                      </td>
                      <td class="col-md-3">
                                <input type="text" name="TimeSheetRows[${index}].SpentTime"
                                class="form-control col-sm-12 spentTimeInput readonly-input"
                        style="width: 72px; text-align: center;"
                        maxlength="5"
                        placeholder="HH:MM"
                        autocomplete="off"
                                value="${row.SpentTime}" readonly="readonly" /> <!-- Ensure the value is populated -->

                    <input type="hidden" name="TimeSheetRows[${index}].prevSpentTime" value="${row.SpentTime}" />
                      </td>
                      </td>
                      <td class="col-md-1" style="text-align: center; vertical-align: middle;">
                        <input type="checkbox" name="TimeSheetRows[${index}].Billable" value="true" style="width: 16px; height: 16px;" ${row.Billable ? 'checked="checked"' : ''} disabled />
                      </td>
                      <td class="col-md-1" style="white-space: nowrap;">
                        <button type="button" class="btn btn-primary edit-row" style="display: inline-block; margin-right: 5px;">Edit</button>
                        <button type="button" class="btn btn-danger remove-row delete-button" style="display: inline-block;">X</button>
                      </td>undefined
                    </tr>undefined<input type="hidden" name="TimeSheetRows[${index}].IsNewEntry" value="false" />undefined<input type="hidden" name="TimeSheetRows[${index}].Id" value="${row.Id}" />undefined<input type="hidden" name="TimeSheetRows[${index}].EmployeeId" value="${row.EmployeeId}" id="EmployeeIdCurrent" />undefined<input type="hidden" name="TimeSheetRows[${index}].TaskId" value="${row.TaskId}" />`;

                                    $('#timeSheetTableBody').append(newRow);

                                initializeDropdowns(index, row.ProjectId, row.TaskId, row.SpentTime);
                                    initializeActivitySearch(index);
                                });


                                $('#fetchRecentBtn').hide();
                            } else {
                                $('#addRowButton').click();
                                $('#fetchRecentBtn').show();
                                
                            }
                            $('#tableContainer').show();
                        },
                        error: function (xhr, status, error) {
                            console.log("Error fetching previous entries: " + error);
                        }
                    });
                } else {
                    Console.Error("Please select both Employee and Spent Date.");

                }
            });
            //employee dropdown validation on change
            $('#employeeDropdown').on('change', function () {
                var employeeId = $(this).val();
                if (employeeId && employeeId !== '') {
                    $('#employeeError').text('');
                } else {
                    $('#employeeError').text('Please select a valid employee.');
                }
            });


            $('input[name="SpentDate"]').on('change', function () {
                var spentDate = $(this).val();
                if (spentDate && spentDate !== '') {
                    $('#dateError').text('');
                } else {
                    $('#dateError').text('Please enter a valid spent date.');
                }
            });


        $(document).on('input', '.spentTimeInput', function () {
            var inputVal = $(this).val().replace(/[^0-9:]/g, ''); // Allow only numbers and ":"

            // Ensure ":" is present only once
            var timeParts = inputVal.split(":");

            if (timeParts.length > 2) {
                inputVal = timeParts[0] + ":" + timeParts[1].slice(0, 2); // Prevent multiple colons
            }

            // Validate format (HH:MM)
            var isValid = timeParts.length === 2 && timeParts[0].length > 0 && timeParts[1].length > 0;

            // Ensure minutes do not exceed 59
            if (isValid && parseInt(timeParts[1], 10) > 59) {
                timeParts[1] = "59"; // Force max value of 59 for minutes
            }

            // Show validation message if format is incorrect
            if (!isValid) {
                $('#SpentTimeValidation').text("Invalid format. Use HH:MM");
            } else {
                $('#SpentTimeValidation').text("");
            }

            // Update input value
            $(this).val(timeParts.join(":"));
        });

            // Add validation for project and task dropdowns
            $('select[name^="TimeSheetRows["][name$=".ProjectId"]').on('change', function () {
                var projectId = $(this).val();
                var row = $(this).closest('tr');
                var taskDropdown = row.find('select[name$=".TaskId"]');
                var taskId = taskDropdown.val();

                // Reset task dropdown to its default state
                taskDropdown.val('');



                // Only trigger task validation if task dropdown is empty
                if (!taskId || taskId === '' || taskId == 0) {
                    row.find('span.taskError').text('Please select a valid task.');
                } else {
                    row.find('span.taskError').text('');
                }
            });


            $('select[name^="TimeSheetRows["][name$=".TaskId"]').on('change', function () {
                var taskId = $(this).val();
                if (taskId && taskId !== '' && taskId !== 0) {
                    $(this).closest('tr').find('span.taskError').text('');

                    // Update estimated hours based on the selected task
                    var row = $(this).closest('tr');
                    var index = row.data('index');
                    var projectId = row.find('input[name$=".ProjectId"]').val();
                    if (projectId && projectId !== '') {
                        $.ajax({
                            url: '@Url.Action("GetEstimatedTimeByTask", "TimeSheet")',
                            type: 'GET',
                            data: { taskId: taskId, projectId: projectId },
                            success: function (data) {
                                row.find(`input[name="TimeSheetRows[${index}].EstimatedHours"]`).val(data.EstimatedTime);
                                row.find(`input[name="TimeSheetRows[${index}].TotalSpent"]`).val(data.TotalSpent);
                            },
                            error: function (xhr, status, error) {
                                console.log("Error fetching estimated time: " + error);
                            }
                        });
                    }
                } else {
                    $(this).closest('tr').find('span.taskError').text('Please select a valid task.');
                }
            });


            $('#SaveNew').on('click', function (e) {
                var timeSheetRows = [];
                var employeeId = $('#employeeDropdown').val();
                var spentDate = $('input[name="SpentDate"]').val();
                e.preventDefault();

                $('#timeSheetTableBody tr').each(function () {
                    var row = $(this);
                    var timeSheetRow = {
                        EmployeeId: employeeId,
                        SpentDate: spentDate,
                        ProjectId: row.find('input[name$=".ProjectId"]').val(),
                        TaskId: parseInt(row.find('input[name$=".TaskId"]').val()),
                        ActivityName: row.find('input[name$=".ActivityName"]').val(),
                        EstimatedHours: row.find('input[name$=".EstimatedHours"]').val(),
                        TotalSpent: row.find('input[name$=".TotalSpent"]').val(),
                    SpentTime: row.find('input[name$=".SpentTime"]').val(),
                        Billable: row.find('input[name$=".Billable"]').is(':checked'),
                        IsNewEntry: row.data('new') === true
                    };

                    timeSheetRows.push(timeSheetRow);
                });

                var isValid = true;

                $.each(timeSheetRows, function (index, timeSheetRow) {
                    if (timeSheetRow.IsNewEntry) {
                        var row = $('#timeSheetTableBody tr').eq(index);
                    var inputField = row.find('input[name$=".SpentTime"]');

                        if (!timeSheetRow.ProjectId || timeSheetRow.ProjectId === '' || timeSheetRow.ProjectId == 0) {
                            row.find('span.projectError').text('Please select a valid project.');
                            isValid = false;
                            e.preventDefault();
                        } else {
                            row.find('span.projectError').text('');
                        }

                        if (!timeSheetRow.TaskId || timeSheetRow.TaskId === '' || timeSheetRow.TaskId == 0) {
                            row.find('span.taskError').text('Please select a valid task.');
                            isValid = false;
                            e.preventDefault();
                        } else {
                            row.find('span.taskError').text('');
                        }

                    // Spent Time Validation (HH:MM format)
                    var spentTimePattern = /^([0-9]{1,2}):([0-5][0-9])$/;
                    if (!spentTimePattern.test(timeSheetRow.SpentTime)) {
                        row.find('span.spentTimeError').text('Invalid time format. Use HH:MM.');
                        isValid = false;
                        e.preventDefault();
                    } else {
                     
                        row.find('span.spentTimeError').text('');
                    }
                    }
                });
               
                async function saveTimeSheetEntries(timeSheetRows) {
                    if (isValid) {
                        const postData = {
                            timeSheetEntries: timeSheetRows
                                .filter(timeSheetRow => timeSheetRow.IsNewEntry) 
                                .map(timeSheetRow => ({
                                    EmployeeId: parseInt(timeSheetRow.EmployeeId),
                                    SpentDate: timeSheetRow.SpentDate,
                                    ProjectId: parseInt(timeSheetRow.ProjectId),
                                    TaskId: parseInt(timeSheetRow.TaskId),
                                    ActivityName:timeSheetRow.ActivityName,
                                    EstimatedHours: parseFloat(timeSheetRow.EstimatedHours),
                                TotalSpent: timeSheetRow.TotalSpent,
                                SpentTime: timeSheetRow.SpentTime,
                                    Billable: timeSheetRow.Billable
                                }))
                        };

                        if (postData.timeSheetEntries.length > 0) {
                            addAntiForgeryToken(postData);

                            try {
                                const response = await $.ajax({
                                    cache: false,
                                    type: 'POST',
                                    url: '@Url.Action("SaveNewChanges", "TimeSheet")',
                                    data: postData,
                                    error: function (jqXHR) {
                                        console.log("Error saving changes: ", jqXHR.responseText);
                                    }
                                });

                                showNotification("New Timesheet Records Are Added Successfully.", "success");
                                // Handle success response
                               
                                // $('#employeeDropdown').val(timeSheetRow.EmployeeId);
                                // $('input[name="SpentDate"]').val(timeSheetRow.SpentDate);
                                $('#searchButton').trigger('click');

                            } catch (error) {
                                console.log("Error saving changes: ", error);
                            }
                        } else {
                            console.log("No new entries to save.");
                        }
                    }
                }

                 saveTimeSheetEntries(timeSheetRows);
               
            });

            // Handle 'Edit' button click

            $(document).on('click', '.edit-row', function () {
                var row = $(this).closest('tr');
                var isEditable = $(this).text() === 'Edit';

                // Set isEditing to true when the "Edit" button is clicked
                if (isEditable) {
                    isEditing = true;
                }

                // Toggle editability of row and its fields
            row.find('input[name$=".SpentTime"]').prop('readonly', function (index, attr) {
                    return !isEditable;
                });

                row.find('input[name$=".ActivityName"]').prop('readonly', function (index, attr) {
                    return !isEditable;
                });
              


                row.find('select').each(function () {
                    var dropdown = $(this).data("kendoDropDownList");
                    if (dropdown) {
                        dropdown.enable(isEditable);
                    }
                });
                row.find('input[name$=".Billable"]').prop('disabled', !isEditable); // Disable checkbox if not editable

               

                $(this).text(isEditable ? 'Save' : 'Edit');
                row.data('editButtonClicked', true);

                // Hide the Delete button
                row.find('.delete-button').hide();

                // Add Cancel button
                if (isEditable) {
                    var cancelButton = $('<button type="button" class="btn btn-secondary cancel-row">Cancel</button>');
                    row.find('.edit-row').after(cancelButton);
                } else {
                    row.find('.cancel-row').remove();
                }
            });

        $(document).on('change', 'input[name$=".SpentTime"]', function () {
                var row = $(this).closest('tr');
                if (!row.find('.edit-row').text() === 'Save') {
                    var index = row.data('index');
                var SpentTime = $(this).val();
                row.find(`input[name="TimeSheetRows[${index}].prevSpentTime"]`).val(SpentTime);
                }
            });

            $(document).on('change', 'input[name$=".ActivityName"]', function () {
                var row = $(this).closest('tr');
                if (!row.find('.edit-row').text() === 'Save') {
                    var index = row.data('index');
                    var activityName = $(this).val();
                    row.find(`input[name="TimeSheetRows[${index}].prevActivityName"]`).val(activityName);
                }
            });
            $(document).on('change', 'input[name$=".TaskId"]', function () {
                var row = $(this).closest('tr');
                if (!row.find('.edit-row').text() === 'Save') {
                    var index = row.data('index');
                    var taskId = $(this).val();
                    row.find(`input[name="TimeSheetRows[${index}].prevTaskId"]`).val(taskId);
                }
            });


            // Handle Save button click
            $(document).on('click', '.edit-row:contains("Save")', function () {

                var row = $(this).closest('tr');
                var index = row.data('index');

                var id = row.find('input[name^="TimeSheetRows["][name$="].Id"]').val();

                var projectId = parseInt(row.find(`input[name="TimeSheetRows[${index}].ProjectId"]`).val());
                var taskId = parseInt(row.find(`input[name="TimeSheetRows[${index}].TaskId"]`).val());
                var activityName = row.find(`input[name="TimeSheetRows[${index}].ActivityName"]`).val();
                var prevActivityName = row.find(`input[name="TimeSheetRows[${index}].prevActivityName"]`).val();

            var estimatedHours = parseFloat(row.find(`input[name="TimeSheetRows[${index}].EstimatedHours"]`).val());
            var totalSpent = row.find(`input[name="TimeSheetRows[${index}].TotalSpent"]`).val();
            var spentTime = row.find(`input[name="TimeSheetRows[${index}].SpentTime"]`).val();
            var prevSpentTime = row.find(`input[name="TimeSheetRows[${index}].prevSpentTime"]`).val();
                var prevTaskId = parseInt(row.find(`input[name="TimeSheetRows[${index}].prevTaskId"]`).val());
                var billable = row.find(`input[name="TimeSheetRows[${index}].Billable"]`).is(':checked');


                if (projectId == 0) {
                    taskId = 0;
                }

            saveRow(row, id, projectId, taskId, prevTaskId, activityName, prevActivityName, estimatedHours, totalSpent, spentTime, prevSpentTime, billable, index);

            });


        var inputField = $('input[name$=".SpentTime"]');
            inputField.on('input', function () {
                if (inputField.val()) {
                    applyValidationState(inputField, true);
                }
            });
            var inputField = $('input[name$=".ActivityName"]');
            inputField.on('input', function () {
                if (inputField.val()) {
                    applyValidationState(inputField, true);
                }
            });
            function applyValidationState(inputField, isValid) {
                if (isValid) {
                    inputField.removeClass('validation-error');
                } else {
                    inputField.addClass('validation-error');
                }
            }





        function saveRow(row, id, projectId, taskId, prevTaskId, activityName, prevActivityName, estimatedHours, totalSpent, spentTime, prevspentTime, billable, index) {

            var isValidate = true;
                if (!projectId || projectId === '' || projectId == 0) {
                    row.find('span.projectError').text('Please select a valid project.');
                    isValidate = false;

                } else {
                    row.find('span.projectError').text('');
                }
                // if (activityName == null) {
                //     row.find('span.activityError').text('Please enter activity name');
                //     isValidate = false;

                // } else {
                //     row.find('span.activityError').text('');
                // }

                // if (activityName != null)
                //     if (activityName.trim() == "") {
                //         row.find('span.activityError').text('Please enter activity name');
                //         isValidate = false;

                //     } else {
                //         row.find('span.activityError').text('');
                //     }


                if (!taskId || taskId === '' || taskId == 0) {
                    row.find('span.taskError').text('Please select a valid task.');
                    isValidate = false;
                } else {
                    row.find('span.taskError').text('');
                }
            if (spentTime == null || spentTime == "") {
                    $(this).val(''); // clear the input field
                    $(this).focus();
                    showNotification('Please enter a valid spent hours value.', 'error');
                    isValidate = false;
                }
            var spentTimePattern = /^([0-9]{1,2}):([0-5][0-9])$/;
            if (!spentTimePattern.test(spentTime)) {
                $(this).val(''); // clear the input field
                $(this).focus();
                isValidate = false;
                showNotification('Please enter a valid spent time value in HH:MM format.', 'error');
            }


                if (!isValidate) {
                    // Make fields editable again
                row.find('input[name$=".SpentTime"]').prop('readonly', false);
                    row.find('input[name$=".ActivityName"]').prop('readonly', false);

                    row.find('select').each(function () {
                        var dropdown = $(this).data("kendoDropDownList");
                        if (dropdown) {
                            dropdown.enable(true);
                        }
                    });
                    row.find('input[name$=".Billable"]').prop('disabled', false);
                    row.find('.edit-row').click();
                    // saveButton.show();
                    return;
                }

                // Set spentHours to the value of prevSpentHours
            row.find(`input[name="TimeSheetRows[${index}].prevSpentTime"]`).val(spentTime);
                row.find(`input[name="TimeSheetRows[${index}].prevTaskId"]`).val(taskId);
                row.find(`input[name="TimeSheetRows[${index}].prevActivityName"]`).val(activityName);

                
                row.find(`input[name="TimeSheetRows[${index}].EstimatedHours"]`).val(estimatedHours);
                row.find(`input[name="TimeSheetRows[${index}].TotalSpent"]`).val(totalSpent);

                $.ajax({
                    url: '@Url.Action("GetEstimatedTimeByTask", "TimeSheet")',
                    type: 'GET',
                    data: { taskId: taskId },
                    success: function (data) {

                        // Update the estimated hours input field with the returned value
                        estimatedHours = data.EstimatedTime; // Update estimatedHours value
                    totalSpent = data.TotalSpent;
                        row.find(`input[name="TimeSheetRows[${index}].EstimatedHours"]`).val(estimatedHours);
                        row.find(`input[name="TimeSheetRows[${index}].TotalSpent"]`).val(totalSpent);

                    },
                    error: function (xhr, status, error) {
                        console.log("Error fetching estimated time: " + error);
                    }
                });


                // Update TotalSpent value for all previous rows with the same TaskId
                var taskId = row.find('input[name$=".TaskId"]').val();
                $('#timeSheetTableBody tr').each(function () {
                    var row = $(this);
                    var rowTaskId = row.find('input[name$=".TaskId"]').val();
                    if (rowTaskId === taskId) {
                        var totalSpent = row.find('input[name$=".TotalSpent"]').val();
                        // Update the TotalSpent value
                        $.ajax({
                            url: '@Url.Action("GetEstimatedTimeByTask", "TimeSheet")',
                            type: 'GET',
                            data: { taskId: taskId },
                            success: function (data) {
                                estimatedHours = data.EstimatedTime; // Update estimatedHours value
                                totalSpent = data.TotalSpent
                                row.find(`input[name="TimeSheetRows[${index}].EstimatedHours"]`).val(estimatedHours);
                                row.find(`input[name="TimeSheetRows[${index}].TotalSpent"]`).val(totalSpent);

                                row.find('input[name$=".TotalSpent"]').val(totalSpent);
                            },
                            error: function (xhr, status, error) {
                                console.log("Error updating TotalSpent: " + error);
                            }
                        });
                    }
                });


                var postdata = { id: id, projectId: projectId, taskId: taskId, prevTaskId: prevTaskId, activityName: activityName, prevActivityName: prevActivityName, estimatedHours: estimatedHours, totalSpent: totalSpent, spentTime: spentTime, prevspentTime: prevspentTime, billable: billable }
            
                addAntiForgeryToken(postdata);
                $.ajax({
                    cache:false,
                    url: '@Url.Action("UpdateRow", "TimeSheet")',
                    type: 'POST',
                    data: postdata,
                    success: function (response) {
                        // Update original values
                        row.data('original-project-id', projectId);
                        row.data('original-task-id', taskId);
                    row.data('original-spent-time', spentTime);
                        row.data('original-activity-name', activityName);

                        row.data('original-billable', billable);
                        row.data('original-estimated-hours', estimatedHours);
                        row.data('original-total-spent', response.updatedTotalSpent);


                        // Make fields readonly again
                    row.find('input[name$=".spentTime"]').prop('readonly', true).addClass('readonly-input');
                        row.find('input[name$=".ActivityName"]').prop('readonly', true);

                        row.find('input[name$=".TotalSpent"]').val(response.updatedTotalSpent);


                        row.find('select').each(function () {
                            var dropdown = $(this).data("kendoDropDownList");
                            if (dropdown) {
                                dropdown.enable(false);
                            }
                        });
                        row.find('input[name$=".Billable"]').prop('disabled', true);

                        // Change Edit button text back to Edit
                        row.find('.edit-row').text('Edit');

                        // Show the Delete button
                        row.find('.delete-button').show();
                        showNotification("Timesheet Record has beed updated successfully", "success");
                        console.log("Row updated successfully.");
                    },
                    error: function (xhr, status, error) {
                        console.log("Error updating row: " + error);
                    }
                });
            }

            function deleteRow(row, index, id) {

                $.ajax({
                    url: '@Url.Action("DeleteRow", "TimeSheet")',
                    type: 'GET',
                    data: { id: id },
                    success: function (response) {
                        row.remove();
                        showNotification("Timesheet Record has beed deleted successfully", "error");

                        console.log("Row deleted successfully.");
                        // Update TotalSpent value for all previous rows with the same TaskId
                        var taskId = row.find('input[name$=".TaskId"]').val();
                        $('#timeSheetTableBody tr').each(function () {
                            var row = $(this);
                            var rowTaskId = row.find('input[name$=".TaskId"]').val();
                            if (rowTaskId === taskId && row.data('index') != index) {
                                var totalSpent = row.find('input[name$=".TotalSpent"]').val();
                                // Update the TotalSpent value
                                $.ajax({
                                    url: '@Url.Action("GetEstimatedTimeByTask", "TimeSheet")',
                                    type: 'GET',
                                    data: { taskId: taskId },
                                    success: function (response) {
                                        row.find('input[name$=".TotalSpent"]').val(response.TotalSpent);
                                    },
                                    error: function (xhr, status, error) {
                                        console.log("Error updating TotalSpent: " + error);
                                    }
                                });
                            }
                        });
                    },
                    error: function (xhr, status, error) {
                        console.log("Error deleting row: " + error);
                    }
                });
            }

            function removeRow(row, id) {
                if (confirm("Are you sure you want to delete this row?")) {
                    var index = row.data('index');
                    deleteRow(row, index, id);
                }
            }
            function showNotification(message, type) {
                // Remove any existing notifications
                var existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(function (notification) {
                    notification.remove();
                });

                // Create notification element
                const notification = document.createElement('div');
                notification.classList.add('notification', type);
                notification.innerHTML = `<span class="Container-notification"><span class="notification-content">${message}</span><span class="close-button">×</span></span>`; // added close button

                // Add event listener to close button
                notification.querySelector('.close-button').addEventListener('click', () => {
                    notification.remove();
                });

                // Append to container
                document.getElementById('notification-container').appendChild(notification);

                // Style the notification to display at the top of the partial view screen and in a single line
                notification.style.width = '100%'; // set width to 100% of the partial view screen
                notification.style.top = '0'; // set top to 0 to display at the top of the partial view screen
                notification.style.textAlign = 'left'; // align text left
                notification.style.whiteSpace = 'nowrap'; // display in a single line
                notification.style.overflow = 'hidden'; // hide overflow text
                notification.style.textOverflow = 'ellipsis'; // add ellipsis to overflow text
                notification.style.height = '50px'; // reduce height to 30px
                notification.style.lineHeight = '30px'; // set line height to 30px
                notification.style.padding = '0 10px'; // reduce padding
                notification.style.color = 'white'; // set text color to white

                // Set color based on type
                if (type === 'error') {
                    notification.style.backgroundColor = '#dc3545'; // red-orange color for error
                    notification.style.borderColor = '#FF0000'; // red color for error
                } else if (type === 'success') {
                    notification.style.backgroundColor = '#17b76d'; // green color for success
                    notification.style.borderColor = '#008000'; // green color for success
                }

                // Optional: Add timeout to remove notification after a certain time
                // setTimeout(() => {
                //     notification.remove();
                // }, 10000); // Remove after 3 seconds
            }

            // Handle Cancel button click
            $(document).on('click', '.cancel-row', function () {

                var row = $(this).closest('tr');

                row.find('span.taskError').text('');
                row.find('span.projectError').text('');


                var originalProjectId = row.data('original-project-id');
                var originalTaskId = row.data('original-task-id');
            var originalSpentTime = row.data('original-spent-time');
                var originalActivityName = row.data('original-activity-name');

                var originalBillable = row.data('original-billable');
                var originalEstimatedHours = row.data('original-estimated-hours');
                var originalTotalSpent = row.data('original-total-spent');
               
                // Restore original values
                row.find('input[name$=".ProjectId"]').val(originalProjectId);
                row.find('select[name$=".ProjectId"]').data("kendoDropDownList").value(originalProjectId);
                row.find('select[name$=".ProjectId"]').data("kendoDropDownList").refresh();
                // Show the Delete button
                row.find('.delete-button').show();
                // Refresh task dropdown with new list of tasks based on selected project
                $.ajax({
                    url: '@Url.Action("GetTasksByProject", "TimeSheet")',
                    type: 'GET',
                    data: { projectId: originalProjectId },
                    success: function (data) {
                        row.find('select[name$=".TaskId"]').data("kendoDropDownList").dataSource.data(data);
                        row.find('select[name$=".TaskId"]').data("kendoDropDownList").refresh();
                        row.find('select[name$=".TaskId"]').data("kendoDropDownList").value(originalTaskId); // Select the original task value from the new list
                        row.find('select[name$=".TaskId"]').data("kendoDropDownList").trigger('change');
                        row.find('select[name$=".TaskId"]').data("kendoDropDownList").refresh();
                    },
                    error: function (xhr, status, error) {
                        console.log("Error fetching tasks: " + error);
                    }
                });
            row.find('input[name$=".SpentTime"]').val(originalSpentTime);
                row.find('input[name$=".Billable"]').prop('checked', originalBillable);
                row.find('input[name$=".EstimatedHours"]').val(originalEstimatedHours);
                row.find('input[name$=".ActivityName"]').val(originalActivityName);

                row.find('input[name$=".TotalSpent"]').val(originalTotalSpent);


                // Make fields readonly again
            row.find('input[name$=".SpentTime"]').prop('readonly', true);
                row.find('input[name$=".ActivityName"]').prop('readonly', true);

                row.find('select').each(function () {
                    var dropdown = $(this).data("kendoDropDownList");
                    if (dropdown) {
                        dropdown.enable(false);
                    }
                });
                row.find('input[name$=".Billable"]').prop('disabled', true);

                // Remove Cancel button
                $(this).remove();

                // Change Edit button text back to Edit
                row.find('.edit-row').text('Edit');
            });

           
            // Initialize dropdowns for existing rows if any
            $('#timeSheetTableBody tr').each(function () {
                var index = $(this).data('index');
                var projectId = $(this).find('input[name$=".ProjectId"]').val();
                var taskId = $(this).find('input[name$=".TaskId"]').val();
                initializeDropdowns(index, projectId, taskId);
            });

            // Show the table and buttons when search is clicked
            $('#searchButton').click(function () {
                $('#addRowButton').show();
                $('#saveChangesButton').show();
            });

           

        });

        // Handle button click event to remove focus
        $(document).on('click', 'button', function () {
            $(this).blur();
        });


        function checkRowsExist() {
            var rowsExist = $('#timeSheetTableBody tr').length > 0;
            if (rowsExist) {
                return 'Are you sure you want to leave this page? Ensure that all changes are saved.';
            }
        }

        $(window).on('beforeunload', function () {
            return checkRowsExist();
        });
    </script>


</section>
<style>
    .k-dropdown-wrap select {
        border: none;
        box-shadow: none;
    }

    #notification-container {
        /* changed to fixed to stick to top of screen */
        top: 0;
        left: 0;
        width: 100%;
        z-index: 9999;
        text-align: center;
    }

    .notification {
        margin: 0;
        border-radius: 0;
    }

    .notification-content {
        margin-right: 30px;
    }

    .close-button {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        text-decoration: none;
    }

    .Container-notification {
        display: flex;
        justify-content: space-between;
        margin: 10px;
    }

    .close-button:hover {
        color: #000;
    }

    .validation-error {
        border: solid 1.5px Red;
    }

    /* Hide the spinner for webkit browsers (Chrome, Safari) */
    .spentHours::-webkit-inner-spin-button,
    .spentHours::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Hide the spinner for Firefox */
    .spentHours {
        -moz-appearance: textfield;
    }
</style>
<style>



    .activity-search-input{
        width:250px;
    }

    .table-responsive {
        position: relative; /* Allows dropdown to position relative to this container */
        overflow-x: auto; /* Keep horizontal scrolling */
        overflow-y: hidden; /* Prevent vertical scrolling while hiding the vertical clipping */
    }

    .activity-suggestions {
        position: relative; /* Position the dropdown relative to the input */
        z-index: 1050; /* Ensure it appears on top */
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        max-height:80px; /* Limit height to avoid large dropdowns */
        overflow-y: auto; /* Enable scrolling for the dropdown */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none; /* Initially hidden */
    }

    .table-responsive {
        overflow-y: visible !important; /* Allow overflow for the suggestion list */
        position: relative; /* Ensure proper stacking context */
    }

    .table {
        overflow-y: visible !important; /* Prevent clipping within the table */
        position: relative; /* Ensure proper positioning */
    }

</style>