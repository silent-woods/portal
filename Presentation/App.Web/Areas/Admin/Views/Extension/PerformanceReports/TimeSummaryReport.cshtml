@using App.Web.Areas.Admin.Models.Extension.TimesheetReports

@model TimesheetReportSearchModel
@{
    //page title
    ViewBag.PageTitle = T("Admin.Configuration.ExportReports").Text;
    //active menu item (system name)
    NopHtml.SetActiveMenuItemSystemName("TimeSummaryReport");

    const string hideSearchBlockAttributeName = "ReportByEmployee.HideSearchBlock";
    var hideSearchBlock = await genericAttributeService.GetAttributeAsync<bool>(await workContext.GetCurrentCustomerAsync(), hideSearchBlockAttributeName);
}


<link rel="stylesheet" href="https://kendo.cdn.telerik.com/themes/8.2.1/default/default-main.css" />


<!-- Kendo UI JS -->
<script src="https://kendo.cdn.telerik.com/2023.2.829/js/kendo.all.min.js"></script>

<div class="content-header clearfix">
    <h1 class="float-left">
        @T("Admin.Configuration.ExportReports")
    </h1>
    <div class="float-right">
        <button type="button" id="create-invoice-btn" class="btn btn-success float-right">
            <i class="fas fa-plus-square"></i>
            @T("Satyanam.Plugin.Misc.AccountManagement.Admin.Invoice.CreateInvoice")
        </button>
        <button id="export-to-excel" class="btn btn-primary float-right hide-before">
            <i class="fas fa-file-excel"></i>
            Export to Excel
        </button>
    </div>
</div>
<section class="content">
    <div class="container-fluid">
        <div class="form-horizontal">
            <div class="cards-group">
                <div class="card card-default card-search">
                    <div class="card-body">
                        
                        <!-- First  Row: Employee -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-sm-3">
                                        <nop-label asp-for="SelectedProjectIds" />
                                    </div>
                                    <div class="col-sm-8">

                                        <select id="SelectedProjectIds" name="SelectedProjectIds" class="kendo-multi-select" style="min-height:30px;" multiple>
                                            @foreach (var project in Model.AvailableProjects)
                                            {
                                                <option value="@project.Value">@project.Text</option>
                                            }
                                        </select>
                                        <span style="color:red; font-weight:bold; position: absolute; right: -5px; top: 15px;">*</span>

                                        <script>
                                            $(document).ready(function () {
                                                var projectSelect = $('#SelectedProjectIds').kendoMultiSelect({
                                                    autoClose: true,
                                                    filter: "contains",

                                                }).data("kendoMultiSelect");

                                            @if (Model.AvailableProjects.Count == 0)
                                            {
                                                <text>
                                                        projectSelect.setOptions({
                                                            enable: false,
                                                            placeholder: '@T("Admin.Catalog.Products.NoAvailableProjects")'
                                                        });
                                                    projectSelect._placeholder();
                                                    projectSelect._enable();
                                                </text>
                                            }
                                                                                                                                                                                                                                                                                                            });
                                        </script>

                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-sm-3">
                                        <nop-label asp-for="ShowById" />
                                    </div>
                                    <div class="col-sm-8">
                                        <nop-select asp-for="ShowById" asp-items="Model.ShowByList" />
                                        <span asp-validation-for="ShowById"></span>
                                    </div>
                                </div>
                            </div>

                           
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-sm-3">
                                        <nop-label asp-for="SelectedTaskIds" />
                                    </div>
                                    <div class="col-sm-8">
                                        <div style="position: relative;">
                                            <nop-select asp-for="SelectedTaskIds" asp-items="Model.AvailableTasks" asp-multiple="true" class="form-control" id="SelectedTaskIds"  />
                                           
                                            <span style="color:red; font-weight:bold; position: absolute; right: -12px; top: 15px;">*</span>
                                        </div>
                                        <span id="Project-error"></span>
                                        <script>
                                            $(document).ready(function () {
                                                var selectElement = $('#@Html.IdFor(model => model.SelectedTaskIds)').data("kendoMultiSelect");

                                                selectElement.setOptions({
                                                    autoClose: true,
                                                    filter: "contains",

                                                });
                                                                                                                   });
                                        </script>
                                        <div id="Task-error"></div>
                                        <span asp-validation-for="SelectedTaskIds"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-sm-3">
                                        <nop-label asp-for="SearchPeriodId" />
                                    </div>
                                    <div class="col-sm-8">
                                        <nop-select asp-for="SearchPeriodId" asp-items="Model.PeriodList" />
                                        <span asp-validation-for="SearchPeriodId"></span>
                                    </div>
                                </div>
                            </div>

                            
                            
                        </div>
                       
                        <div class="row">

                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-sm-3">
                                        <nop-label asp-for="SelectedEmployeeIds" />
                                    </div>
                                    <div class="col-sm-8">
                                        <select id="SelectedEmployeeIds" name="SelectedEmployeeIds" class="kendo-multi-select" style="min-height:30px;" multiple>
                                            @foreach (var project in Model.AvailableEmployees)
                                            {
                                                <option value="@project.Value">@project.Text</option>
                                            }
                                        </select>
                                        <span style="color:red; font-weight:bold; position: absolute; right: -5px; top: 15px;">*</span>

                                        <script>
                                            $(document).ready(function () {
                                                var projectSelect = $('#SelectedEmployeeIds').kendoMultiSelect({
                                                    autoClose: true,
                                                    filter: "contains",

                                                }).data("kendoMultiSelect");

                                            @if (Model.AvailableEmployees.Count == 0)
                                            {
                                                <text>
                                                        projectSelect.setOptions({
                                                            enable: false,
                                                            placeholder: '@T("Admin.Catalog.Products.NoAvailableProjects")'
                                                        });
                                                    projectSelect._placeholder();
                                                    projectSelect._enable();
                                                </text>
                                            }
                                                 });
                                        </script>
                                   
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6" style="display:none;" id="from-container">
                                <div class="form-group row">
                                    <div class="col-sm-3">
                                        <nop-label asp-for="From" />
                                    </div>
                                    <div class="col-sm-9">
                                        <nop-editor asp-for="From" asp-required="true" />
                                        <span asp-validation-for="From"></span>
                                        <span id="From-error"></span>
                                    </div>
                                </div>
                            </div>
                            
                        </div>

                     
                        <div class="row">
                        
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-sm-3">
                                        <nop-label asp-for="HoursId" />
                                    </div>
                                    <div class="col-sm-8">
                                        <nop-select asp-for="HoursId" asp-items="Model.HoursList" />
                                        <span asp-validation-for="HoursId"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row" style="display:none;" id="to-container">
                                    <div class="col-sm-3">
                                        <nop-label asp-for="To" />
                                    </div>
                                    <div class="col-sm-9">
                                        <nop-editor asp-for="To" asp-required="true" />
                                        <span asp-validation-for="To"></span>
                                        <div id="To-error"></div>
                                    </div>
                                </div>
                            </div>
                         
                        </div>



                        <!-- Search Button -->
                        <div class="row">
                            <div class="text-center col-12">
                                <button type="submit" id="search-brands" class="btn btn-primary btn-search">
                                    <i class="fas fa-chart-line"></i>
                                    @T("Admin.Reports.MonthlyReport.RunReport")
                                </button>
                              
                            </div>
                        </div>
                    </div>
                 
                </div>
                <script>
                    $(document).ready(function () {

                         //for automatically change dropdown according to difference of date
                    function updateShowByDropdown() {
                        var fromDate = new Date($('#From').val());
                        var toDate = new Date($('#To').val());

                        // Ensure both dates are selected
                        if (!isNaN(fromDate) && !isNaN(toDate)) {
                            var timeDiff = toDate - fromDate;
                            var daysDiff = timeDiff / (1000 * 3600 * 24);

                            // Get the normal dropdown element
                            var showByDropdown = $('#ShowById');
                            if (daysDiff > 31) {
                                // If the difference is more than 1 months (31 days), set to Monthly
                                showByDropdown.val('3');
                            } else if (daysDiff > 7) {
                                // If the difference is more than 7 days, set to Weekly
                                showByDropdown.val('2');
                            } else {
                                // Otherwise, set to Daily
                                showByDropdown.val('1');
                            }
                        }
                    }

                    // Trigger the function when the From or To date changes
                    $('#From, #To').on('change', updateShowByDropdown);

                        $('#SearchPeriodId').on('change', function () {
                        var periodId = $(this).val();

                        $.ajax({
                          url: "@(Url.Action("GetPeriodDateRange", "Reports"))",
                            type: 'GET',
                            data: { periodId: periodId },
                            success: function (data) {
                                if (data.from && data.to) {

                                    // Not custom, auto-fill and hide custom fields
                                    $('#From').val(data.from);
                                    $('#To').val(data.to);
                                    $('#from-container').hide();
                                    $('#to-container').hide();
                                    updateShowByDropdown()
                                } else {
                                    // Custom selected
                                    $('#From').val('');
                                    $('#To').val('');
                                    $('#from-container').show();
                                    $('#to-container').show();
                                    updateShowByDropdown()
                                }
                            }
                        });
                    });
                     $('#SearchPeriodId').trigger('change');
                    });
                </script>


                <div class="card card-default hide-before" hidden>
                    <div class="card-body">
                        <div class="table-wrapper">
                            <table id="header-report-table" class="table">
                                <thead>
                                    <!-- Table header will be dynamically created here -->
                                </thead>
                                <tbody>
                                    <!-- Table body will be dynamically created here -->
                                </tbody>
                                <tfoot>
                                    <!-- Total row will be dynamically created here -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card card-default hide-before">
         
                    <div class="card-body">
                        <h4 class="float-left">
                            @T("Admin.Reports.TimeSummaryReport.ReportByTeamMember")
                        </h4>
                        <div class="table-wrapper">
                            <table id="employee-report-table" class="table">
                                <thead>
                                    <!-- Table header will be dynamically created here -->
                                </thead>
                                <tbody>
                                    <!-- Table body will be dynamically created here -->
                                </tbody>
                                <tfoot>
                                    <!-- Total row will be dynamically created here -->
                                </tfoot>
                            </table>
                        </div>
                        </div>
                        </div>


                <div class="card card-default hide-before">
                    <div class="card-body">
                        <h4 class="float-left">
                            @T("Admin.Reports.TimeSummaryReport.ReportByTask")
                        </h4>
                        <div class="table-wrapper">
                            <table id="timesheet-report-table" class="table">
                                <thead>
                                    <!-- Table header will be dynamically created here -->
                                </thead>
                                <tbody>
                                    <!-- Table body will be dynamically created here -->
                                </tbody>
                                <tfoot>
                                    <!-- Total row will be dynamically created here -->
                                </tfoot>
                            </table>
                        </div>
                        </div>
                    </div>


                <div class="card card-default hide-before">
                    <div class="card-body">
                        <h4 class="float-left">
                            @T("Admin.Reports.TimeSummaryReport.DailySummary")
                        </h4>
                        <div class="table-wrapper">
                            <table id="date-report-table" class="table">
                                <thead>
                                    <!-- Table header will be dynamically created here -->
                                </thead>
                                <tbody>
                                    <!-- Table body will be dynamically created here -->
                                </tbody>
                                <tfoot>
                                    <!-- Total row will be dynamically created here -->
                                </tfoot>
                            </table>
                        </div>
                      </div>
                    </div>
                </div>
                <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
                <script>
                    $(document).ready(function () {
                        
                        // Helper function to calculate monthly segments
                        // Initialize Kendo DropDownList for employees

                        $("#SelectedProjectIds").data("kendoMultiSelect").value(0);
                    $("#SelectedEmployeeIds").data("kendoMultiSelect").value(0);
                        fetchTasks();



                    $('#SelectedEmployeeIds').on('change', function () {
                        var projectMultiSelect = $("#SelectedEmployeeIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance
                        var selectedProjectIds = projectMultiSelect.value();  // Get the selected project IDs
                        console.log('Selected project IDs:', selectedProjectIds);
                        // Check if "All" (0) is selected
                        if (selectedProjectIds.includes('0')) {
                            // If "All" is the only selection, do nothing
                            if (selectedProjectIds.length === 1) {
                                return; // Only "All" is selected, do nothing
                            }

                            // If "All" is selected last, unselect all other options
                            if (selectedProjectIds[selectedProjectIds.length - 1] === '0') {
                                // Keep only "All"
                                projectMultiSelect.value(['0']);
                            } else {
                                // If another project is selected, unselect "All"
                                projectMultiSelect.value($.grep(selectedProjectIds, function (value) {
                                    return value !== '0'; // Remove "All" from selection
                                }));
                            }
                        } else {
                            // If no projects are selected, select "All" by default
                            if (selectedProjectIds.length === 0) {
                                projectMultiSelect.value(['0']); // Default to "All"
                            }
                        }
                    });
                    // Project selection change event
                    $('#SelectedProjectIds').on('change', function () {
                        var projectMultiSelect = $("#SelectedProjectIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance
                        var selectedProjectIds = projectMultiSelect.value();  // Get the selected project IDs
                        console.log('Selected project IDs:', selectedProjectIds);
                        // Check if "All" (0) is selected
                        if (selectedProjectIds.includes('0')) {
                            // If "All" is the only selection, do nothing
                            if (selectedProjectIds.length === 1) {
                                return; // Only "All" is selected, do nothing
                            }

                            // If "All" is selected last, unselect all other options
                            if (selectedProjectIds[selectedProjectIds.length - 1] === '0') {
                                // Keep only "All"
                                projectMultiSelect.value(['0']);
                            } else {
                                // If another project is selected, unselect "All"
                                projectMultiSelect.value($.grep(selectedProjectIds, function (value) {
                                    return value !== '0'; // Remove "All" from selection
                                }));
                            }
                        } else {
                            // If no projects are selected, select "All" by default
                            if (selectedProjectIds.length === 0) {
                                projectMultiSelect.value(['0']); // Default to "All"
                            }
                        }
                    });

                    $("#SelectedEmployeeIds").data("kendoMultiSelect").value(0);

                   


                        $("#EmployeeId").kendoDropDownList({
                            dataTextField: "Text",
                            dataValueField: "Value",
                            filter: "contains",
                            autoBind: false,
                            dataSource: @Html.Raw(Json.Serialize(Model.AvailableEmployees))
                                                                                });


                    // $('#SelectedEmployeeIds').on('change', function () {
                    //     var taskMultiSelect = $("#SelectedEmployeeIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance
                    //     var selectedTaskIds = taskMultiSelect.value();  // Get the selected task IDs

                    //     // Check if no employees are selected
                    //     if (selectedTaskIds.length === 0) {
                    //         // Select the "All" option by default
                    //         taskMultiSelect.value(['0']);
                    //     } else {
                    //         // Check if the "All" option is selected and another task is chosen
                    //         if (selectedTaskIds.includes('0') && selectedTaskIds.length > 1) {
                    //             console.log("selectedTaskIds", selectedTaskIds);
                    //             // Unselect the "All" option
                    //             taskMultiSelect.value($.grep(selectedTaskIds, function (value) {
                    //                 return value !== '0';
                    //             }));
                    //         }
                    //     }
                    // });

                    // Task selection change event
                    $('#SelectedTaskIds').on('change', function () {
                        var taskMultiSelect = $("#SelectedTaskIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance
                        var selectedTaskIds = taskMultiSelect.value();  // Get the selected task IDs

                        // Check if "All" (0) is selected
                        if (selectedTaskIds.includes(0)) {
                            // If "All" is the only selection, do nothing
                            if (selectedTaskIds.length === 1) {
                                return; // Only "All" is selected, do nothing
                            }

                            // If "All" is selected last, unselect all other options
                            if (selectedTaskIds[selectedTaskIds.length - 1] === 0) {
                                // Keep only "All"
                                taskMultiSelect.value([0]);
                            } else {
                                // If another task is selected, unselect "All"
                                taskMultiSelect.value($.grep(selectedTaskIds, function (value) {
                                    return value !== 0; // Remove "All" from selection
                                }));
                            }
                        } else {
                            // If no tasks are selected, select "All" by default
                            if (selectedTaskIds.length === 0) {
                                taskMultiSelect.value([0]); // Default to "All"
                            }
                        }
                    });


                 
                        function getMonthlySegments(fromDate, toDate) {
                            let segments = [];
                            let current = new Date(fromDate);

                            // Loop through months, even if partial
                            while (current <= toDate) {
                                let startOfMonth = new Date(current.getFullYear(), current.getMonth(), 1);
                                let endOfMonth = new Date(current.getFullYear(), current.getMonth() + 1, 0); // Last day of the month

                                // Adjust the segment start and end based on the selected range
                                let segmentStart = current > fromDate ? current : fromDate;
                                let segmentEnd = endOfMonth > toDate ? toDate : endOfMonth;

                                segments.push({
                                    start: new Date(segmentStart),
                                    end: new Date(segmentEnd)
                                });

                                // Move to the next month
                                current = new Date(endOfMonth);
                                current.setDate(current.getDate() + 1);
                            }

                            return segments;
                        }

                        // Helper function to calculate weekly segments
                        function getWeeklySegments(fromDate, toDate) {
                            let segments = [];
                            let current = new Date(fromDate);

                            // Loop to calculate weekly segments
                            while (current <= toDate) {
                                let weekStart = new Date(current);
                                let weekEnd = new Date(current);
                                weekEnd.setDate(current.getDate() + (7 - current.getDay())); // Set to the end of the week (Sunday if you do satuerday then do 6 insetd of 7 as old)
                                segments.push({
                                    start: new Date(weekStart),
                                    end: new Date(Math.min(weekEnd, toDate)) // Ensure we don't exceed the 'To' date
                                });
                                current = new Date(weekEnd);
                                current.setDate(current.getDate() + 1); // Move to the next week's start (Sunday)
                            }
                           

                            return segments;
                        }

                        // Format date as "Aug 1 - Aug 7"
                        function formatDateRange(startDate, endDate) {
                            let startMonth = startDate.toLocaleDateString('en-US', { month: 'short' });
                            let startDay = startDate.toLocaleDateString('en-US', { day: 'numeric' });
                            let endMonth = endDate.toLocaleDateString('en-US', { month: 'short' });
                            let endDay = endDate.toLocaleDateString('en-US', { day: 'numeric' });

                            if (startMonth === endMonth) {
                                return `${startMonth} ${startDay} - ${endDay}`;
                            } else {
                                return `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
                            }
                        }

                        function validateEmployeeSelection() {
                            var selectedProjectIds = $('#SelectedProjectIds').val(); // Get selected employee IDs
                            var From = $('#From').val();
                            var To = $('#To').val();
                            var selectedTaskIds = $('#SelectedTaskIds').val();
                        var selectedEmployeetIds = $('#SelectedEmployeeIds').val();

                            var isValid = true; // Assume valid unless we find errors

                            // Clear previous error messages
                            $('#Project-error').html('').css('color', '');
                            $('#From-error').html('').css('color', '');
                            $('#To-error').html('').css('color', '');
                            $('#Task-error').html('').css('color', '');
                        $('#Employee-error').html('').css('color', '');

                            // Validate selected employees
                        if (!selectedProjectIds || selectedProjectIds.length === 0) {
                                $('#Project-error').html('Please select project.').css('color', 'red'); // Show error message
                                isValid = false; // Validation failed
                            }

                            if (!selectedTaskIds || selectedTaskIds.length === 0 ||selectedTaskIds ==null) {
                                $('#Task-error').html('Please select at least one task.').css('color', 'red'); // Show error message
                                isValid = false; // Validation failed
                            }

                        if (!selectedEmployeetIds || selectedEmployeetIds.length === 0) {
                            $('#Employee-error').html('Please select employee.').css('color', 'red'); // Show error message
                            isValid = false; // Validation failed
                        }
                            // Validate From and To dates
                            if (!From || From == null) {
                                $('#From-error').html('Please select a start date.').css('color', 'red');
                                isValid = false; // Validation failed
                            }

                            if (!To) {
                                $('#To-error').html('Please select an end date.').css('color', 'red');
                                isValid = false; // Validation failed
                            }

                            if (From && To && new Date(To) < new Date(From)) {
                                $('#To-error').html('End date cannot be earlier than start date.').css('color', 'red');
                                isValid = false; // Validation failed
                            }

                            return isValid; // Return validation result
                        }

                        function fetchTasks() {
                            var projectIds = $('#SelectedProjectIds').val();  // Get the selected project IDs

                            // Validate project selection
                            if (projectIds && projectIds.length > 0) {
                                $('#projectError').text('');  // Clear error message if projects are selected

                                // Join project IDs into a comma-separated string
                                var projectIdsString = projectIds.join(',');

                                // Make GET request to fetch tasks based on selected project IDs
                                $.ajax({
                                    url: '@Url.Action("GetTasksFromProjects", "Reports")',  // Your controller method to fetch tasks
                                    type: 'GET',
                                    data: { projectIds: projectIdsString },  // Send selected project IDs as query parameters
                                    success: function (tasks) {
                                        var taskMultiSelect = $("#SelectedTaskIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance

                                        // Check if tasks were returned
                                        if (tasks && tasks.length > 0) {
                                            // Clear existing options
                                            taskMultiSelect.dataSource.data([]);  // Clear data source

                                            // Ensure the correct fields are set for Kendo MultiSelect
                                            taskMultiSelect.setOptions({
                                                dataTextField: "TaskName",  // Ensure this matches the field returned by the server
                                                dataValueField: "TaskId"    // Ensure this matches the field returned by the server
                                            });

                                            // Map the tasks to ensure correct TaskId and TaskName are used
                                            var taskData = tasks.map(function (task) {
                                                return {
                                                    TaskId: task.TaskId,      // Make sure TaskId exists in the response
                                                    TaskName: task.TaskName   // Make sure TaskName exists in the response
                                                };
                                            });

                                            // // Add the "All" option
                                            // taskData.unshift({ TaskId: 0, TaskName: 'All' });

                                            // Bind the new data to the Kendo MultiSelect
                                            taskMultiSelect.setDataSource(new kendo.data.DataSource                    ({
                                                data: taskData
                                            }));

                                            // Preselect the "All" option
                                            taskMultiSelect.value([0]);  // Select the "All" option with ID -1

                                            taskMultiSelect.refresh();  // Refresh the dropdown
                                        } else {
                                            // If no tasks available, clear the MultiSelect and display a message
                                            taskMultiSelect.setOptions({
                                                dataTextField: "TaskName",
                                                dataValueField: "TaskId"
                                            });

                                            taskMultiSelect.setDataSource(new kendo.data.DataSource({
                                                data: [{ TaskId: '', TaskName: 'No tasks available' }]
                                            }));

                                            taskMultiSelect.refresh();  // Refresh the dropdown
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error fetching tasks:', error);
                                        $('#employeeError').text('Failed to fetch tasks for the selected project(s).');
                                    }
                                });



                            } else {
                                $('#projectError').text('Please select a valid project.');  // Show error message if no projects are selected
                                $('#SelectedTaskIds').empty().append($('<option></option>').val('').text('Select a project first'));
                            }
                        }
                        function isWeekend(data, date) {
                            const utcTimestamp = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
                            const utcDate = new Date(utcTimestamp);
                            const dateString = utcDate.toISOString().split('T')[0]; // extract the date part in YYYY-MM-DD format
                         

                            const isweeked = data.some(item => {
                              
                                return item.SpentDate.startsWith(dateString) && item.IsWeekend;
                            });

                           
                            return isweeked;
                        }
                        function isHoliday(data, date) {
                            const utcTimestamp = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
                            const utcDate = new Date(utcTimestamp);
                            const dateString = utcDate.toISOString().split('T')[0]; // extract the date part in YYYY-MM-DD format
                         

                            const isholiday = data.some(item => {
                               
                                return item.SpentDate.startsWith(dateString) && item.IsHoliday;
                            });


                            return isholiday;
                        }
                      
                        // Update the table with data and date segments
                    function updateTable(data, fromDate, toDate, showById) {
                        if (data && data.length > 0) {
                            $('.hide-before').removeClass('hide-before');
                        } else {
                            $('.hide-before').addClass('hide-before');
                        }

                        var tableBody = $("#timesheet-report-table tbody");
                        var tableHead = $("#timesheet-report-table thead");
                        var tableFoot = $("#timesheet-report-table tfoot");

                        tableBody.empty();
                        tableHead.empty();
                        tableFoot.empty();

                        var segments = [];
                        if (showById == "2") {
                            segments = getWeeklySegments(new Date(fromDate), new Date(toDate));
                        } else if (showById == "3") {
                            segments = getMonthlySegments(new Date(fromDate), new Date(toDate));
                        } else {
                            let current = new Date(fromDate);
                            while (current <= new Date(toDate)) {
                                let segment = {
                                    start: new Date(current),
                                    end: new Date(current),
                                    isWeekend: isWeekend(data, current),
                                    isHoliday: isHoliday(data, current)
                                };
                                segments.push(segment);
                                current.setDate(current.getDate() + 1);
                            }
                        }

                        var headerRow = $("<tr></tr>");
                        headerRow.append($("<th></th>").text("Tasks"));

                        segments.forEach(function (segment) {
                            var segmentText;
                            if (showById == "2") {
                                segmentText = formatDateRange(segment.start, segment.end);
                            } else if (showById == "3") {
                                var startDate = segment.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                var endDate = segment.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                segmentText = startDate + " - " + endDate;
                            } else {
                                segmentText = segment.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            }

                            if (segment.isHoliday) {
                                headerRow.append($("<th style='color:#4caf50'></th>").text(segmentText));
                            } else if (segment.isWeekend) {
                                headerRow.append($("<th style='color: red'></th>").text(segmentText));
                            } else {
                                headerRow.append($("<th></th>").text(segmentText));
                            }
                        });

                        headerRow.append($("<th></th>").text("Total"));
                        tableHead.append(headerRow);

                        var groupedData = {};
                        data.forEach(function (item) {
                            if (!groupedData[item.TaskId]) {
                                groupedData[item.TaskId] = {
                                    name: item.TaskName,
                                    spentTimeByDate: {},
                                    totalSpentMinutes: 0
                                };
                            }

                            var spentMinutes = (item.SpentHours || 0) * 60 + (item.SpentMinutes || 0);
                            groupedData[item.TaskId].spentTimeByDate[item.SpentDate] = spentMinutes;
                            groupedData[item.TaskId].totalSpentMinutes += spentMinutes;
                        });

                        groupedData = Object.fromEntries(Object.entries(groupedData).filter(([taskId, taskData]) => {
                            return taskData.totalSpentMinutes > 0;
                        }));

                        Object.keys(groupedData).forEach(function (taskId) {
                            var taskData = groupedData[taskId];
                            var row = $("<tr></tr>");

                            row.append($("<td></td>").text(taskData.name));

                            segments.forEach(function (segment) {
                                var segmentTotal = 0;
                                Object.keys(taskData.spentTimeByDate).forEach(function (date) {
                                    var dateObj = new Date(date);
                                    if (dateObj >= segment.start && dateObj <= segment.end) {
                                        segmentTotal += taskData.spentTimeByDate[date];
                                    }
                                });

                                var formattedTime = segmentTotal ? formatMinutesToHHMM(segmentTotal) : "-";
                                row.append($("<td></td>").text(formattedTime));
                            });

                            row.append($("<td></td>").text(formatMinutesToHHMM(taskData.totalSpentMinutes)));
                            tableBody.append(row);
                        });

                        var totalRow = $("<tr></tr>").addClass('totalRow');
                        totalRow.append($("<th></th>").text("Total"));

                        var grandTotalMinutes = 0;
                        segments.forEach(function (segment) {
                            var dateSegmentTotal = 0;
                            Object.keys(groupedData).forEach(function (taskId) {
                                var taskData = groupedData[taskId];
                                Object.keys(taskData.spentTimeByDate).forEach(function (date) {
                                    var dateObj = new Date(date);
                                    if (dateObj >= segment.start && dateObj <= segment.end) {
                                        dateSegmentTotal += taskData.spentTimeByDate[date];
                                    }
                                });
                            });

                            totalRow.append($("<td class='totalRow'></td>").text(dateSegmentTotal ? formatMinutesToHHMM(dateSegmentTotal) : "-"));
                            grandTotalMinutes += dateSegmentTotal;
                        });

                        totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalMinutes)));
                        tableFoot.append(totalRow);


                        var table = document.getElementById("header-report-table");
                        var tableBody = $("#header-report-table tbody"); // Note the correct table ID

                        // Clear the previous rows
                        tableBody.empty();

                        // Create a new table row element for the dates
                        var row0 = document.createElement("tr");


                        // Create table cells for the From and To dates
                        var fromCell = document.createElement("td");
                        var fromDate = moment($("#From").val());
                        fromCell.textContent = "From: " + fromDate.format("D MMM YYYY");
                        fromCell.colSpan = 3;
                        var emptyCell = document.createElement("td");
                        emptyCell.textContent = "";


                        // Add the cells to the row
                        row0.appendChild(emptyCell);
                        row0.appendChild(fromCell);
                        tableBody.append(row0);
                        var row1 = document.createElement("tr");
                        var toCell = document.createElement("td");
                        var toDate = moment($("#To").val());
                        toCell.textContent = "To: " + toDate.format("D MMM YYYY");
                        toCell.colSpan = 2; // Span the cell across two columns

                        var emptyCell = document.createElement("td");
                        emptyCell.textContent = "";


                        // Add the cells to the row
                        row1.appendChild(emptyCell);

                        row1.appendChild(toCell);
                        // Add the row to the table body
                        tableBody.append(row1);




                        // Create a new table row element for the selected projects
                        var row2 = document.createElement("tr");

                        var selectedProjectNames = [];

                        if ($("#SelectedProjectIds option:selected").val() === "All" || $("#SelectedProjectIds option:selected").text() === "All") {
                            // Retrieve all project names, excluding the "All" option
                            $("#SelectedProjectIds option").each(function () {
                                if ($(this).text() !== "All") {
                                    selectedProjectNames.push($(this).text());
                                }
                            });
                        } else {
                            // Retrieve only the selected project names
                            $("#SelectedProjectIds option:selected").each(function () {
                                selectedProjectNames.push($(this).text());
                            });
                        }

                        var projectsCell = document.createElement("td");
                        projectsCell.textContent = "Project: " + selectedProjectNames.join(", ");
                        projectsCell.colSpan = 2; // Span the cell across two columns


                        var emptyCell = document.createElement("td");
                        emptyCell.textContent = "";


                        // Add the cells to the row
                        row2.appendChild(emptyCell);

                        // Add the cell to the row
                        row2.appendChild(projectsCell);

                        // Add the row to the table body
                        tableBody.append(row2);


                    }

              
                    function updateEmployeeTable(data, fromDate, toDate, showById) {
                        var tableBody = $("#employee-report-table tbody");
                        var tableHead = $("#employee-report-table thead");
                        var tableFoot = $("#employee-report-table tfoot");

                        // Clear previous data
                        tableBody.empty();
                        tableHead.empty();
                        tableFoot.empty();

                        // Calculate the date segments based on ShowById
                        var segments = [];
                        if (showById == "2") {
                            // Weekly view
                            segments = getWeeklySegments(new Date(fromDate), new Date(toDate));
                        } else if (showById == "3") {
                            // Monthly view
                            segments = getMonthlySegments(new Date(fromDate), new Date(toDate));
                        } else {
                            // Daily view
                            let current = new Date(fromDate);
                            while (current <= new Date(toDate)) {
                                let segment = {
                                    start: new Date(current),
                                    end: new Date(current),
                                    isWeekend: isWeekend(data, current),
                                    isHoliday: isHoliday(data, current)
                                };
                                segments.push(segment);
                                current.setDate(current.getDate() + 1);
                            }
                        }

                        // Create table header with segment ranges
                        var headerRow = $("<tr></tr>");
                        headerRow.append($("<th></th>").text("Team Members")); // First column for employee names

                        segments.forEach(function (segment) {
                            var segmentText;
                            if (showById == "2") {
                                // Weekly format: "Aug 1 - Aug 7"
                                segmentText = formatDateRange(segment.start, segment.end);
                            } else if (showById == "3") {
                                // Monthly format: "Aug 1 - Aug 31"
                                segmentText = segment.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + " - " +
                                    segment.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            } else {
                                // Daily format: "Aug 1"
                                segmentText = segment.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            }

                            var headerCell = $("<th></th>").text(segmentText);
                            if (segment.isHoliday) {
                                headerCell.css("color", "#4caf50");
                            } else if (segment.isWeekend) {
                                headerCell.css("color", "red");
                            }
                            headerRow.append(headerCell);
                        });

                        headerRow.append($("<th></th>").text("Total"));
                        tableHead.append(headerRow);

                        // Group data by EmployeeId
                        var groupedData = {};
                        data.forEach(function (item) {
                            if (!groupedData[item.EmployeeId]) {
                                groupedData[item.EmployeeId] = {
                                    name: item.EmployeeName,
                                    spentTimeByDate: {},
                                    totalSpentMinutes: 0
                                };
                            }

                            // Convert hours & minutes into total minutes
                            var spentMinutes = (item.SpentHours || 0) * 60 + (item.SpentMinutes || 0);
                            groupedData[item.EmployeeId].spentTimeByDate[item.SpentDate] = spentMinutes;
                            groupedData[item.EmployeeId].totalSpentMinutes += spentMinutes;
                        });

                        // Filter out empty rows
                        groupedData = Object.fromEntries(Object.entries(groupedData).filter(([_, taskData]) => taskData.totalSpentMinutes > 0));

                        // Add data rows for each employee
                        Object.keys(groupedData).forEach(function (employeeId) {
                            var taskData = groupedData[employeeId];
                            var row = $("<tr></tr>");
                            row.append($("<td></td>").text(taskData.name));

                            // Hours for each segment
                            segments.forEach(function (segment) {
                                var segmentTotalMinutes = 0;
                                Object.keys(taskData.spentTimeByDate).forEach(function (date) {
                                    var dateObj = new Date(date);
                                    if (dateObj >= segment.start && dateObj <= segment.end) {
                                        segmentTotalMinutes += taskData.spentTimeByDate[date];
                                    }
                                });

                                // Convert minutes to HH:MM format
                                var formattedTime = formatMinutesToHHMM(segmentTotalMinutes);
                                row.append($("<td></td>").text(formattedTime !== "00:00" ? formattedTime : "-"));
                            });

                            // Total time in HH:MM format
                            row.append($("<td></td>").text(formatMinutesToHHMM(taskData.totalSpentMinutes)));
                            tableBody.append(row);
                        });

                        // Add a row for the total of all employees
                        var totalRow = $("<tr></tr>").addClass('totalRow');
                        totalRow.append($("<th></th>").text("Total"));

                        var grandTotalMinutes = 0;
                        segments.forEach(function (segment) {
                            var segmentTotalMinutes = 0;
                            Object.keys(groupedData).forEach(function (employeeId) {
                                var taskData = groupedData[employeeId];
                                Object.keys(taskData.spentTimeByDate).forEach(function (date) {
                                    var dateObj = new Date(date);
                                    
                                    if (dateObj >= segment.start && dateObj <= segment.end) {
                                        segmentTotalMinutes += taskData.spentTimeByDate[date];
                                    }
                                });
                            });
                            console.log("segments-", segments);
                            totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(segmentTotalMinutes)));
                            grandTotalMinutes += segmentTotalMinutes;
                        });

                        // Grand total in HH:MM format
                        totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalMinutes)));
                        tableFoot.append(totalRow);
                    }

                    // ✅ Function to Convert Minutes into HH:MM Format
                    function formatMinutesToHHMM(totalMinutes) {
                        var hours = Math.floor(totalMinutes / 60);
                        var minutes = totalMinutes % 60;
                        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    }

                    // ✅ Function to Format Date Ranges for Weekly Segments
                    function formatDateRange(start, end) {
                        var startDate = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        var endDate = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        return startDate + " - " + endDate;
                    }



                    function updateDateReportTable(data, fromDate, toDate, showById) {
                        var tableBody = $("#date-report-table tbody");
                        var tableHead = $("#date-report-table thead");
                        var tableFoot = $("#date-report-table tfoot");

                        // Clear previous data
                        tableBody.empty();
                        tableHead.empty();
                        tableFoot.empty();

                        // Create table header
                        var headerRow = $("<tr></tr>");
                        headerRow.append($("<th></th>").text("Task Name"));
                        headerRow.append($("<th></th>").text("Project"));
                        headerRow.append($("<th></th>").text("Employee"));
                        headerRow.append($("<th></th>").text("Spent Date"));
                        headerRow.append($("<th></th>").text("Spent Time"));

                        tableHead.append(headerRow);

                        // Add data rows for each item
                        var totalSpentMinutes = 0;
                        data.forEach(function (item) {
                            var row = $("<tr></tr>");

                            row.append($("<td></td>").text(item.TaskName));
                            row.append($("<td></td>").text(item.ProjectName));
                            row.append($("<td></td>").text(item.EmployeeName));
                            row.append($("<td></td>").text(moment(item.SpentDate).format("D MMM YYYY")));

                            var spentMinutes = (item.SpentHours || 0) * 60 + (item.SpentMinutes || 0);
                            totalSpentMinutes += spentMinutes;

                            row.append($("<td></td>").text(formatMinutesToHHMM(spentMinutes)));
                            tableBody.append(row);
                        });

                        // Add total row
                        var totalRow = $("<tr style='font-weight: bold;'></tr>");
                        totalRow.append($("<td></td>").text("Total"));
                        totalRow.append($("<td></td>").text("")); // empty cell for project
                        totalRow.append($("<td></td>").text("")); // empty cell for employee
                        totalRow.append($("<td></td>").text("")); // empty cell for spent date
                        totalRow.append($("<td></td>").text(formatMinutesToHHMM(totalSpentMinutes))); // display total spent time

                        tableBody.append(totalRow);
                    }



                        // Fetch data when the "Run Report" button is clicked
                        function fetchData() {

                            if (!validateEmployeeSelection()) {
                                return; // Stop further execution if validation fails
                            }
                        // Clear previous data
                        $("#timesheet-report-table tbody").empty();
                        $("#timesheet-report-table thead").empty();
                        $("#timesheet-report-table tfoot").empty();
                            var employeeId = $('#EmployeeId').val(); // Array of employee IDs
                            var From = $('#From').val();
                            var To = $('#To').val();
                            var showById = $('#ShowById').val();
                            var selectedProjectIds = $('#SelectedProjectIds').val();
                            var selectedTaskIds = $('#SelectedTaskIds').val();
                            var hours = $('#HoursId').val();
                            var isHide = $('#IsHideEmpty').val();
                            var selectedEmployeeIds = $('#SelectedEmployeeIds').val();

                         
                            var aggregatedData = [];
                            var totalRequests = 0;
                            var completedRequests = 0;
                          
                            // Fetch data based on employees or all employees
                            if (selectedTaskIds.includes("0")) {
                                // Fetch all employees' data
                                var projectIdsString = selectedProjectIds.join(',');
                                var employeeIdsString = selectedEmployeeIds.join(',');
                                $.ajax({
                                    url: "@(Url.Action("GetAllTasksData", "Reports"))",
                                    type: "GET",
                                    data: { From: From, To: To, ShowById: showById, EmployeeIds: employeeIdsString, HoursId: hours, projectIds: projectIdsString, IsHideEmpty: isHide },
                                    success: function (data) {
                                        aggregatedData = data;

                                        updateTable(aggregatedData, From, To, showById);
                                     
                                        // Pass date range and showById to updateTable
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error fetching data for all employees:', error);
                                    }
                                });
                            } else {
                                totalRequests = selectedTaskIds.length;
                                var employeeIdsString = selectedEmployeeIds.join(',');
                                selectedTaskIds.forEach(function (taskId) {
                                    $.ajax({
                                        url: "@(Url.Action("GetReportByTask", "Reports"))",
                                        type: "GET",
                                        data: { searchEmployeeId: employeeIdsString, From: From, To: To, ShowById: showById, HoursId: hours, TaskId: taskId, IsHideEmpty: isHide },
                                        success: function (data) {

                                            aggregatedData = aggregatedData.concat(data);
                                            completedRequests++;
                                            if (completedRequests === totalRequests) {
                                               
                                                updateTable(aggregatedData, From, To, showById);
                                               // Pass date range and showById to updateTable
                                            }
                                        },
                                        error: function (xhr, status, error) {
                                            console.error('Error fetching data for employee ID ' + employeeId + ':', error);
                                            completedRequests++;
                                            if (completedRequests === totalRequests) {
                                                updateTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                            }
                                        }
                                    });
                                });
                            }
                        }



                        function fetchEmployeeData() {

                            if (!validateEmployeeSelection()) {
                                return; // Stop further execution if validation fails
                            }
                        // Clear previous data
                        $("#employee-report-table tbody").empty();
                        $("#employee-report-table thead").empty();
                        $("#employee-report-table tfoot").empty();
                            var selectedEmployeeIds = $('#SelectedEmployeeIds').val(); // Array of employee IDs
                            var From = $('#From').val();
                            var To = $('#To').val();
                            var showById = $('#ShowById').val();
                            var selectedProjectIds = $('#SelectedProjectIds').val();
                            var selectedTaskIds = $('#SelectedTaskIds').val();
                            var hours = $('#HoursId').val();
                            var isHide = $('#IsHideEmpty').val();

                            

                            var aggregatedData = [];
                            var totalRequests = 0;
                            var completedRequests = 0;
                          
                            // Fetch data based on employees or all employees
                            if (selectedEmployeeIds.includes("0")) {
                                // Fetch all employees' data
                                var projectIdsString = selectedProjectIds.join(',');
                                var taskIdsString = selectedTaskIds.join(',');


                              
                                $.ajax({
                                    url: "@(Url.Action("GetAllEmployeesWithProjectsData", "Reports"))",
                                    type: "GET",
                                    data: { From: From, To: To, ShowById: showById, ProjectIds: projectIdsString, HoursId: hours, TaskIds: taskIdsString },
                                    success: function (data) {
                                        aggregatedData = data;

                                        updateEmployeeTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error fetching data for all employees:', error);
                                    }
                                });
                            } else {
                                var projectIdsString = selectedProjectIds.join(',');
                                var taskIdsString = selectedTaskIds.join(',');

                                totalRequests = selectedEmployeeIds.length;
                                selectedEmployeeIds.forEach(function (employeeId) {
                                    $.ajax({
                                        url: "@(Url.Action("GetReportByWithProjectsEmployee", "Reports"))",
                                        type: "GET",
                                        data: { searchEmployeeId: employeeId, From: From, To: To, ShowById: showById, ProjectIds: projectIdsString, HoursId: hours, TaskIds: taskIdsString },
                                        success: function (data) {
                                           
                                            aggregatedData = aggregatedData.concat(data);
                                            completedRequests++;
                                            if (completedRequests === totalRequests) {
                                                
                                                updateEmployeeTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                            }
                                        },
                                        error: function (xhr, status, error) {
                                            console.error('Error fetching data for employee ID ' + employeeId + ':', error);
                                            completedRequests++;
                                            if (completedRequests === totalRequests) {
                                                updateEmployeeTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                            }
                                        }
                                    });
                                });
                            }
                        }


                        function fetchDateData() {

                        if (!validateEmployeeSelection()) {
                            return; // Stop further execution if validation fails
                        }
                    
                  

                            var employeeId = $('#EmployeeId').val(); // Array of employee IDs
                            var From = $('#From').val();
                            var To = $('#To').val();
                            var showById = $('#ShowById').val();
                            var selectedProjectIds = $('#SelectedProjectIds').val();
                            var selectedTaskIds = $('#SelectedTaskIds').val();
                            var hours = $('#HoursId').val();
                            var isHide = $('#IsHideEmpty').val();
                            var selectedEmployeeIds = $('#SelectedEmployeeIds').val();

                    // Clear previous data
                    $("#date-report-table tbody").empty();
                    $("#date-report-table thead").empty();
                    $("#date-report-table tfoot").empty();
                      
                                // Fetch all employees' data
                                var projectIdsString = selectedProjectIds.join(',');
                                var employeeIdsString = selectedEmployeeIds.join(',');
                                var taskIdsString = selectedTaskIds.join(',');
                           
                                $.ajax({
                                    url: "@(Url.Action("GetDateReportData", "Reports"))",
                                    type: "GET",
                                data: { From: From, To: To, ShowById: showById, EmployeeIds: employeeIdsString, projectIds: projectIdsString, taskIds: taskIdsString, HoursId: hours },
                                    success: function (data) {
                                        aggregatedData = data;

                                     
                                        updateDateReportTable(aggregatedData, From, To);
                                        // Pass date range and showById to updateTable
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error fetching data for all employees:', error);
                                    }
                                });
                            
                        }

                        //if change then validation text is gone
                        $('#SelectedProjectIds').change(function () {
                            $('#Project-error').html('').css('color', '');
                        });

                    $('#SelectedEmployeeIds').change(function () {
                        $('#Employee-error').html('').css('color', '');
                    });

                        $('#SelectedTaskIds').change(function () {
                            $('#Task-error').html('').css('color', '');
                        });

                        $('#From').change(function () {
                            $('#From-error').html('').css('color', '');

                        });

                        $('#To').change(function () {
                            $('#To-error').html('').css('color', '');
                        });

                        $('#SelectedProjectIds').on('change', function () {
                            var projectIds = $(this).val();  // Get the selected project IDs

                            // Validate project selection
                            if (projectIds && projectIds.length > 0) {
                                $('#projectError').text('');  // Clear error message if projects are selected

                                // Join project IDs into a comma-separated string
                                var projectIdsString = projectIds.join(',');

                                // Make GET request to fetch tasks based on selected project IDs
                                $.ajax({
                                    url: '@Url.Action("GetTasksFromProjects", "Reports")',  // Your controller method to fetch tasks
                                    type: 'GET',
                                    data: { projectIds: projectIdsString },  // Send selected project IDs as query parameters
                                    success: function (tasks) {
                                   
                                        var taskMultiSelect = $("#SelectedTaskIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance
                                    var selectedProject = $('#SelectedProjectIds').val();
                                        // Check if tasks were returned
                                   
                                    if (selectedProject.includes('0') || (tasks && tasks.length > 0)) {
                                            // Clear existing options
                                            taskMultiSelect.dataSource.data([]);  // Clear data source

                                            // Ensure the correct fields are set for Kendo MultiSelect
                                            taskMultiSelect.setOptions({
                                                dataTextField: "TaskName",  // Ensure this matches the field returned by the server
                                                dataValueField: "TaskId"    // Ensure this matches the field returned by the server
                                            });

                                            // Map the tasks to ensure correct TaskId and TaskName are used
                                            var taskData = tasks.map(function (task) {
                                             
                                                return {
                                                    TaskId: task.TaskId,      // Make sure TaskId exists in the response
                                                    TaskName: task.TaskName   // Make sure TaskName exists in the response
                                                };
                                            });

                                            // // Add the "All" option
                                            // taskData.unshift({ TaskId: 0, TaskName: 'All' });


                                            // Bind the new data to the Kendo MultiSelect
                                            taskMultiSelect.setDataSource(new kendo.data.DataSource({
                                                data: taskData
                                            }));

                                            // Preselect the "All" option
                                            taskMultiSelect.value([0]);  // Select the "All" option with ID -1

                                            taskMultiSelect.refresh();  // Refresh the dropdown
                                        } else {
                                            // If no tasks available, clear the MultiSelect and display a message
                                            taskMultiSelect.setOptions({
                                                dataTextField: "TaskName",
                                                dataValueField: "TaskId"
                                            });

                                            taskMultiSelect.setDataSource(new kendo.data.DataSource({
                                                data: [{ TaskId: '', TaskName: 'No tasks available' }]
                                            }));

                                            taskMultiSelect.refresh();  // Refresh the dropdown
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error fetching tasks:', error);
                                        $('#employeeError').text('Failed to fetch tasks for the selected project(s).');
                                    }
                                });

                            } else {
                                $('#projectError').text('Please select a valid project.');  // Show error message if no projects are selected
                                $('#SelectedTaskIds').empty().append($('<option></option>').val('').text('Select a project first'));
                            }


                        });


                        // Attach click event to search button
                        $('#search-brands').click(fetchData);
                        $('#search-brands').click(fetchEmployeeData);
                        $('#search-brands').click(fetchDateData);

                        // Call fetchData initially to populate the table
                    });
                function exportReportToExcel() {
                   
                    // Create an Excel workbook
                    var workbook = new ExcelJS.Workbook();
                    var worksheet = workbook.addWorksheet("Report");

                    worksheet.pageSetup = {
                        orientation: 'landscape', // Set orientation to landscape
                        fitToWidth: 1,
                    };
                    var rowCount = 1;
                    // Get the data from the first table
                    var tableData1 = [];
                    $("#header-report-table tbody tr").each(function () {
                        var row = [];
                        $(this).find("td").each(function () {
                            row.push($(this).text());
                        });
                        tableData1.push(row);
                        
                    });

                    // Add the total row from the tfoot section
                    var totalRow1 = [];
                    $("#header-report-table tfoot tr td").each(function () {
                        totalRow1.push($(this).text());
                        
                    });
                    tableData1.push(totalRow1);

                    // Get the data from the second table
                    var tableData2 = [];
                    var headerRow2 = [];
                    $("#employee-report-table thead th").each(function () {
                        headerRow2.push($(this).text());
                    });
                    tableData2.push(headerRow2);

                    $("#employee-report-table tbody tr").each(function () {
                        var row = [];
                        $(this).find("td").each(function () {
                            row.push($(this).text());
                        });
                        tableData2.push(row);
                    });

                    // Add the total row from the tfoot section
                    var totalRow2 = [];
                    totalRow2.push("Total"); // Add "Total" to the first cell
                    $("#employee-report-table tfoot tr td").each(function () {
                        totalRow2.push($(this).text());
                    });
                    tableData2.push(totalRow2);

                    // Get the data from the third table
                    var tableData3 = [];
                    var headerRow3 = [];
                    $("#timesheet-report-table thead th").each(function () {
                        headerRow3.push($(this).text());
                    });
                    tableData3.push(headerRow3);

                    $("#timesheet-report-table tbody tr").each(function () {
                        var row = [];
                        $(this).find("td").each(function () {
                            row.push($(this).text());
                        });
                        tableData3.push(row);
                    });

                    // Add the total row from the tfoot section
                    var totalRow3 = [];
                    totalRow3.push("Total"); // Add "Total" to the first cell
                    $("#timesheet-report-table tfoot tr td").each(function () {
                        totalRow3.push($(this).text());
                    });
                    tableData3.push(totalRow3);

                    // Get the data from the fourth table
                    var tableData4 = [];
                    var headerRow4 = [];
                    $("#date-report-table thead th").each(function () {
                        headerRow4.push($(this).text());
                    });
                    tableData4.push(headerRow4);

                    $("#date-report-table tbody tr").each(function () {
                        var row = [];
                        $(this).find("td").each(function () {
                            row.push($(this).text());
                        });
                        tableData4.push(row);
                    });

                    // Add the total row from the tfoot section
                    // var totalRow4 = [];
                    // totalRow4.push("Total"); // Add "Total" to the first cell
                    // $("#date-report-table tfoot tr td").each(function () {
                    //     totalRow4.push($(this).text());
                    // });
                    // tableData4.push(totalRow4);

                    // Add title and data to the worksheet
                    var startRow = 1;

                    const logoImage = workbook.addImage({
                        buffer: new Uint8Array(atob('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').split('').map(char => char.charCodeAt(0))),
                        extension: 'png',
                    });
                    worksheet.addImage(logoImage, {
                        tl: { col: 0, row: 0 }, // top-left corner of the image
                        ext: { width: 225, height: 120 }, // size of the image
                        editAs: 'oneCell'
                    });


                    worksheet.addRow(["", "Time Summary Report"]); // Add title
                    var worksheetRow = worksheet.getRow(worksheet.rowCount);
                    worksheetRow.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'ff4139' }, alignment: { horizontal: 'center', vertical: 'top', wrapText: true } }; 
                    worksheetRow.getCell(2).font = {
                        color: { argb: 'FFFFFF' },
                        bold: true,
                        size: 18 
                    }; 
                    startRow++;

                  
                    worksheetRow = worksheet.getRow(1);
                   
                    worksheetRow.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '5770c9' } }; 
                    worksheetRow.getCell(3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '5770c9' } }; 
                    worksheetRow.getCell(4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '5770c9' } }; 
                    worksheetRow.getCell(5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '5770c9' } }; 
                    worksheetRow.getCell(6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '5770c9' } }; 
                    worksheetRow.getCell(7).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '5770c9' } }; 

                  

                    tableData1.forEach(function (row, rowIndex) {
                        var worksheetRow = worksheet.addRow(row);
                        worksheetRow.getCell(1).alignment = { wrapText: true };
                    

                        for (var i = 1; i <= row.length; i++) {
                            var cell = worksheetRow.getCell(i);
                            cell.numFmt = "@@";
                            if (rowIndex === 0) { // Header row
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '5770c9' } }; // Set background color
                                cell.font = { color: { argb: 'FFFFFF' }, bold: true }; // Set text color to white and bold
                            } else if (rowIndex === tableData1.length - 1) { // Total row
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFC080' } }; // Yellow background
                                cell.font = { bold: true };
                            } else { // Data rows
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } }; // White background
                            }
                          
                          
                        }
                    });
                 
                    // Set rows 2-5 to light blue background till column G
                    for (var i = 2; i <= 5; i++) {
                        worksheetRow = worksheet.getRow(i);
                        worksheetRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } }; 
                        worksheetRow.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } }; 
                        worksheetRow.getCell(3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } };
                        worksheetRow.getCell(4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } }; 
                        worksheetRow.getCell(5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } }; 
                        worksheetRow.getCell(6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } };
                        worksheetRow.getCell(7).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } }; 


                        worksheetRow.getCell(1).font = { color: { argb: '000000' }, bold: true, size: 12 }; // White font color
                        worksheetRow.getCell(2).font = { color: { argb: '000000' }, bold: true, size: 12 }; // White font color
                        worksheetRow.getCell(3).font = { color: { argb: '000000' }, bold: true, size: 12 }; // White font color
                        worksheetRow.getCell(4).font = { color: { argb: '000000' }, bold: true, size: 12 }; // White font color
                        worksheetRow.getCell(5).font = { color: { argb: '000000' }, bold: true, size: 12 }; // White font color
                        worksheetRow.getCell(6).font = { color: { argb: '000000' }, bold: true, size: 12 }; // White font color
                        worksheetRow.getCell(7).font = { color: { argb: '000000' }, bold: true, size: 12 }; // White font color
                    }

                    worksheet.addRow([]);
                    worksheet.addRow([]); // Add blank row
                    worksheet.addRow([]); // Add blank row
                    worksheet.addRow(["Team Summary"]); // Add title
                    var worksheetRow = worksheet.getRow(worksheet.rowCount);
                    worksheetRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '5770c9' } }; // Change background color to yellow
                    worksheetRow.getCell(1).font = {
                        color: { argb: 'FFFFFF' },
                        bold: true,
                        size: 15 // Increase font size to 18
                    }; // Set text color to white and bold
                    worksheetRow.getCell(1).border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                   
                    startRow++;


                    tableData2.forEach(function (row, rowIndex) {
                        var worksheetRow = worksheet.addRow(row);
                        worksheetRow.getCell(1).alignment = { wrapText: true };
                  

                        for (var i = 1; i <= row.length; i++) {
                            var cell = worksheetRow.getCell(i);
                            cell.numFmt = "@@";
                            if (rowIndex === 0) { // Header row
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'dae2f2' } }; // Set background color
                                cell.font = { color: { argb: '000000' }, bold: true }; // Set text color to white and bold
                            } else if (rowIndex === tableData2.length - 1) { // Total row
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'C6E2B5' } }; // Light green background
                                cell.font = { bold: true };
                            } else { // Data rows
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } }; // White background
                            }
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        }
                    });

                    worksheet.addRow([]); // Add blank row
                    worksheet.addRow([]); // Add blank row
                    worksheet.addRow(["Task Summary"]); // Add title
                    var worksheetRow = worksheet.getRow(worksheet.rowCount);
                    worksheetRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '5770c9 ' } }; // Change background color to yellow
                    worksheetRow.getCell(1).font = {
                        color: { argb: 'FFFFFF' },
                        bold: true,
                        size: 15 // Increase font size to 18
                    }; // Set text color to white and bold
                    // Add title
                    // Apply text wrapping to the first column
                    worksheetRow.getCell(1).border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                    startRow++;


                    tableData3.forEach(function (row, rowIndex) {
                        var worksheetRow = worksheet.addRow(row);
                        worksheetRow.getCell(1).alignment = { wrapText: true };
                        

                        for (var i = 1; i <= row.length; i++) {
                            var cell = worksheetRow.getCell(i);
                            cell.numFmt = "@@";
                            if (rowIndex === 0) { // Header row
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'dae2f2' } };
                                cell.font = { color: { argb: '000000' }, bold: true }; 
                            } else if (rowIndex === tableData3.length - 1) { // Total row
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'C6E2B5' } }; 
                                cell.font = { bold: true };
                            } else { 
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } }; 
                            }
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        }
                    });

                    worksheet.addRow([]); // Add blank row
                    worksheet.addRow([]); // Add blank row
                    worksheet.addRow(["Daily Summary"]); // Add title
                    var worksheetRow = worksheet.getRow(worksheet.rowCount);
                    worksheetRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '5770c9' } }; // Change background color to yellow
                    worksheetRow.getCell(1).font = {
                        color: { argb: 'FFFFFF' },
                        bold: true,
                        size: 15 // Increase font size to 18
                    }; // Set text color to white and bold
                    worksheetRow.getCell(1).border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                  

                    // Apply text wrapping to the first column
                    worksheet.getRow(startRow).getCell(1).alignment = { wrapText: true };
                    startRow++;


                    tableData4.forEach(function (row, rowIndex) {
                        var worksheetRow = worksheet.addRow(row);
                        worksheetRow.getCell(1).alignment = { wrapText: true };
                        worksheetRow.getCell(2).alignment = { wrapText: true };

                        for (var i = 1; i <= row.length; i++) {
                            var cell = worksheetRow.getCell(i);
                            cell.numFmt = "@@";
                            if (rowIndex === 0) { // Header row
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'dae2f2' } }; // Set background color
                                cell.font = { color: { argb: '000000' }, bold: true }; // Set text color to white and bold
                            } else if (rowIndex === tableData4.length - 1) { // Total row
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'C6E2B5' } }; // Light green background
                                cell.font = { bold: true };
                            } 
                            else { // Data rows
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } }; // White background
                            }
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        }
                        // Apply text wrapping to the first column
                        worksheet.getRow(startRow).getCell(1).alignment = { wrapText: true };
                    });

                   
                    // Set column widths
                    worksheet.columns = [
                        { width: 34 }, // First column
                        { width: 13 }, // Second column
                        { width: 13 }, // Third column
                        { width: 13 }, // Fourth column
                        { width: 13 }, // Fifth column
                        { width: 13 }, // Sixth column
                        { width: 13 }, // Seventh column
                        { width: 10 }, // Eighth column
                        { width: 10 }, // Ninth column
                        { width: 10 }, // Tenth column
                    ];

                    // Export the workbook to an Excel file
                    workbook.xlsx.writeBuffer()
                        .then(function (buffer) {
                            var blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                            var link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = "Time Summary Reports.xlsx";
                            link.click();
                        });

                   
                }
                        $("#export-to-excel").click(exportReportToExcel);

                // Handle button click event to remove focus
                $(document).on('click', 'button', function () {
                    $(this).blur();
                });

                </script>

                <script>
                    $(document).ready(function () {

                        $('#create-invoice-btn').click(function () {
                            var projectIds = $('#SelectedProjectIds').data('kendoMultiSelect').value();

                            $.ajax({
                                url: '@Url.Action("CreateInvoiceFromTimeSummaryReport", "AccountManagement")',
                                type: 'GET',
                                data: {
                                    from: $('#From').val(),
                                    to: $('#To').val(),
                                    projectId: projectIds[0],
                                    periodId: $('#SearchPeriodId').val(),
                                    hoursId: $('#HoursId').val()
                                },
                                success: function (response) {
                                    if (response.redirectUrl) {
                                        window.open(response.redirectUrl, '_blank');
                                    }
                                },
                                error: function (xhr, status, error) {
                                    console.error(error);
                                }
                            });
                        });
                    });
                </script>
            </div>
        </div>
    </div>

    <nop-alert asp-alert-id="deleteSelectedFailed" />
    <nop-alert asp-alert-id="nothingSelectedAlert" />
</section>


<style>
  
    .table-wrapper {
        width: 100%;
        overflow-x: auto; /* Enables horizontal scroll only when content overflows */
        position: relative;
    }

    #timesheet-report-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        position: relative; /* Ensure the table is positioned relatively to handle sticky positioning */
    }

        /* Ensure cells do not wrap text */
        #timesheet-report-table th,
        #timesheet-report-table td {
            padding: 10px;
            text-align: left;
        }

        /* Fix the first column */
        #timesheet-report-table thead th:first-child,
        #timesheet-report-table tbody td:first-child,
        #timesheet-report-table tfoot th:first-child,
        #timesheet-report-table tfoot td:first-child {
            position: sticky;
            left: 0;
            background-color: #ffffff; /* White background for better visibility */
            z-index: 2; /* Ensure it stays on top of other columns */
        }

        /* Fix the last column */
        #timesheet-report-table thead th:last-child,
        #timesheet-report-table tbody td:last-child,
        #timesheet-report-table tfoot th:last-child,
        #timesheet-report-table tfoot td:last-child {
            position: sticky;
            right: 0;
            background-color: #ffffff; /* White background for better visibility */
            z-index: 2; /* Ensure it stays on top of other columns */
        }

        /* Style for task name column */
        #timesheet-report-table th:nth-child(1),
        #timesheet-report-table td:nth-child(1) {
            max-width: 200px; 
            min-width: 150px; /* Set a fixed width for the task name column */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #timesheet-report-table td:nth-child(1) {
            overflow-wrap: break-word; /* Allow wrapping of long text */
        }

        #timesheet-report-table th {
            white-space: nowrap;
        }

    /* Style for total row cells */
    .totalRow {
        font-weight: bold; /* Make the text bold */
        text-align: right; /* Align text to the right for numerical values */
        padding: 10px;
        border-top: 2px solid #ddd; /* Top border to separate total row from the data rows */
    }


    #employee-report-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        position: relative; /* Ensure the table is positioned relatively to handle sticky positioning */
    }

        /* Ensure cells do not wrap text */
        #employee-report-table th,
        #employee-report-table td {
            padding: 10px;
            text-align: left;
        }

        /* Fix the first column */
        #employee-report-table thead th:first-child,
        #employee-report-table tbody td:first-child,
        #employee-report-table tfoot th:first-child,
        #employee-report-table tfoot td:first-child {
            position: sticky;
            left: 0;
            background-color: #ffffff; /* White background for better visibility */
            z-index: 2; /* Ensure it stays on top of other columns */
        }

        /* Fix the last column */
        #employee-report-table thead th:last-child,
        #employee-report-table tbody td:last-child,
        #employee-report-table tfoot th:last-child,
        #employee-report-table tfoot td:last-child {
            position: sticky;
            right: 0;
            background-color: #ffffff; /* White background for better visibility */
            z-index: 2; /* Ensure it stays on top of other columns */
        }

        /* Style for task name column */
        #employee-report-table th:nth-child(1),
        #employee-report-table td:nth-child(1) {
            max-width: 200px;
            min-width: 150px; /* Set a fixed width for the task name column */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #employee-report-table td:nth-child(1) {
            overflow-wrap: break-word; /* Allow wrapping of long text */
        }

        #employee-report-table th {
            white-space: nowrap;
        }

            #date-report-table th:nth-child(1),
            #date-report-table td:nth-child(1) {
                max-width: 200px;
                min-width: 150px; /* Set a fixed width for the task name column */
                overflow: hidden;
                text-overflow: ellipsis;
            }

    .hide-before {
        display: none;
    }

        .hide-before table:not(:empty) {
            display: block;
        }

</style>
