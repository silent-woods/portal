@using App.Web.Models.Extension.TimesheetReports

@model TimesheetReportSearchModel
@{
    //page title
    Layout = "_ColumnsOne";

    NopHtml.AddTitleParts(T("Account.TimeSummaryReport").Text);
    NopHtml.AppendPageCssClassParts("html-account-page");
    NopHtml.AppendPageCssClassParts("html-customer-info-page");
  
}

<link rel="stylesheet" href="@Url.Content("~/Themes/DefaultClean/Content/css/summaryreports.css")" />
<!-- Kendo UI CSS -->
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/themes/8.2.1/default/default-main.css" />
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Kendo UI JS -->
<script src="https://kendo.cdn.telerik.com/2023.2.829/js/kendo.all.min.js"></script>
@* <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"/>
 *@

<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>


@* jqxgrid *@
<link rel="stylesheet" href="https://jqwidgets.com/public/jqwidgets/styles/jqx.base.css" type="text/css" />
<script type="text/javascript" src="https://jqwidgets.com/public/jqwidgets/jqx-all.js"></script>

<div id="notification-container"></div>
<div class="content-header clearfix">
    <h1 class="float-left">
        @T("Admin.Configuration.ExportReports")
    </h1>
</div>
<section class="content">
    <div class="container-fluid">
        <div class="form-horizontal">
            <div class="cards-group">
                <div class="card card-default card-search">
                    <div class="card-body">
                      
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label asp-for="SelectedProjectIds" asp-postfix=":"></label>
                                    <select id="SelectedProjectIds" name="SelectedProjectIds" class="kendo-multi-select" multiple>
                                        @foreach (var project in Model.AvailableProjects)
                                        {
                                            <option value="@project.Value">@project.Text</option>
                                        }
                                    </select>
                                    <script>
                                        $(document).ready(function () {
                                            var projectSelect = $('#SelectedProjectIds').kendoMultiSelect({
                                                autoClose: true,
                                                filter: "contains"
                                            }).data("kendoMultiSelect");

                                        @if (Model.AvailableProjects.Count == 0)
                                        {
                                            <text>
                                                    projectSelect.setOptions({
                                                        enable: false,
                                                        placeholder: '@T("Admin.Catalog.Products.NoAvailableProjects")'
                                                    });
                                                projectSelect._placeholder();
                                                projectSelect._enable();
                                            </text>
                                        }
                                                          });
                                    </script>
                                </div>
                            </div>

                            <div class="col-md-6">
 
                                
                                    <div class="form-group row">
                                        <div class="col-sm-3">
                                            <nop-label asp-for="ShowById" />
                                        </div>
                                        <div class="col-sm-8">
                                            <nop-select asp-for="ShowById" asp-items="Model.ShowByList" />
                                            <span asp-validation-for="ShowById"></span>
                                        </div>
                                    </div>
                                
                               
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label asp-for="SelectedTaskIds" asp-postfix=":"></label>
                                    <select id="SelectedTaskIds" name="SelectedTaskIds" class="kendo-multi-select" multiple>
                                        
                                        @if (Model.AvailableTasks != null)
                                        {
                                            @foreach (var project in Model.AvailableTasks)
                                            {
                                                <option value="@project.Value">@project.Text</option>
                                            }
                                        }
                                    </select>
                                    <script>
                                        $(document).ready(function () {
                                            var projectSelect = $('#SelectedTaskIds').kendoMultiSelect({
                                                autoClose: true,
                                                filter: "contains"
                                            }).data("kendoMultiSelect");

                                        @if (Model.AvailableTasks == null || Model.AvailableTasks.Count == 0)
                                        {
                                            <text>
                                                    projectSelect.setOptions({
                                                        enable: true,
                                                        placeholder: '@T("Admin.Catalog.Products.NoAvailableProjects")'
                                                    });
                                                projectSelect._placeholder();
                                                projectSelect._enable();
                                            </text>
                                        }
                                                });
                                    </script>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-sm-3">
                                        <nop-label asp-for="SearchPeriodId" />
                                    </div>
                                    <div class="col-sm-8">
                                        <nop-select asp-for="SearchPeriodId" asp-items="Model.PeriodList" id="SearchPeriodId" />
                                        <span asp-validation-for="SearchPeriodId"></span>
                                    </div>
                                </div>
                                </div>
                          

                        </div>
                        <!-- First Row: From and Show By -->
                        <div class="row">


                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label asp-for="SelectedEmployeeIds" asp-postfix=":"></label>
                                    <select id="SelectedEmployeeIds" name="SelectedEmployeeIds" class="kendo-multi-select" multiple>
                                        @foreach (var project in Model.AvailableEmployees)
                                        {
                                            <option value="@project.Value">@project.Text</option>
                                        }
                                    </select>
                                    <script>
                                        $(document).ready(function () {
                                            var projectSelect = $('#SelectedEmployeeIds').kendoMultiSelect({
                                                autoClose: true,
                                                filter: "contains",
                                                value: [@Html.Raw(Model.EmployeeId)],
                                            }).data("kendoMultiSelect");

                                        @if (Model.AvailableEmployees.Count == 0)
                                        {
                                            <text>
                                                    projectSelect.setOptions({
                                                        enable: false,
                                                        placeholder: '@T("Admin.Catalog.Products.NoAvailableProjects")'
                                                    });
                                                projectSelect._placeholder();
                                                projectSelect._enable();
                                            </text>
                                        }
                                                                                                                                });
                                    </script>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group row" style="display:none;" id="from-container">
                                    <div class="col-md-3">
                                        <label asp-for="From" asp-postfix=":"></label>
                                    </div>
                                    <div class="col-md-4">
                                        <input asp-for="From" type="date" id="From" />
                                        <p style="color:red; " id="fromError"></p>
                                    </div>
                                </div>
                               
                            </div>
                          
                        </div>

                   <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-sm-3">
                                        <nop-label asp-for="HoursId" />
                                    </div>
                                    <div class="col-sm-8">
                                        <nop-select asp-for="HoursId" asp-items="Model.HoursList" />
                                        <span asp-validation-for="HoursId"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                            <div class="form-group row" style="display:none;" id="to-container">
                                <div class="col-md-3">
                                    <label asp-for="To" asp-postfix=":"></label>
                                </div>
                                <div class="col-md-4">
                                    <input asp-for="To" type="date" id="To" />
                                    <p style="color:red; " id="toError"></p>
                                </div>
                            </div>
                            </div>
                   </div>


                        <!-- Search Button -->
                        <div class="row">
                            <div class="text-center col-12">
                                <button type="submit" id="search-brands" class="btn btn-primary btn-search">
                                    <i class="fas fa-chart-line"></i>
                                    @T("Admin.Reports.MonthlyReport.RunReport")
                                </button>

                            </div>
                        </div>
                    </div>
                </div>
                <script>
                    $(document).ready(function () {

                         //for automatically change dropdown according to difference of date
                    function updateShowByDropdown() {
                        var fromDate = new Date($('#From').val());
                        var toDate = new Date($('#To').val());

                        // Ensure both dates are selected
                        if (!isNaN(fromDate) && !isNaN(toDate)) {
                            var timeDiff = toDate - fromDate;
                            var daysDiff = timeDiff / (1000 * 3600 * 24);
                           
                            // Get the normal dropdown element
                            var showByDropdown = $('#ShowById');
                            if (daysDiff > 31) {
                                // If the difference is more than 1 months (31 days), set to Monthly
                                showByDropdown.val('3');
                            } else if (daysDiff > 7) {
                                // If the difference is more than 7 days, set to Weekly
                                showByDropdown.val('2');
                            } else {
                                // Otherwise, set to Daily
                                showByDropdown.val('1');
                            }
                        }
                    }

                    // Trigger the function when the From or To date changes
                    $('#From, #To').on('change', updateShowByDropdown);

                        $('#SearchPeriodId').on('change', function () {
                        var periodId = $(this).val();
                      
                        $.ajax({
                          url: "@(Url.Action("GetPeriodDateRange", "Reports"))",
                            type: 'GET',
                            data: { periodId: periodId },
                            success: function (data) {
                                if (data.from && data.to) {

                                    // Not custom, auto-fill and hide custom fields
                                    $('#From').val(data.from);
                                    $('#To').val(data.to);
                                    $('#from-container').hide();
                                    $('#to-container').hide();
                                    updateShowByDropdown()
                                } else {
                                    // Custom selected
                                    $('#From').val('');
                                    $('#To').val('');
                                    $('#from-container').show();
                                    $('#to-container').show();
                                    updateShowByDropdown()
                                }
                            }
                        });
                    });
                     $('#SearchPeriodId').trigger('change');
                    });
                </script>
                <script>
                    $(document).ready(function () {
                        $('#search-brands').on('click', function (e) {
                            e.preventDefault(); // Prevent default form submission

                            // Get the values of the From and To fields
                            var fromDate = $('#From').val();
                            var toDate = $('#To').val();

                            var isValid = true;

                            // Clear previous errors
                            $('#fromError').text('');
                            $('#toError').text('');

                            // Validate From date
                            if (!fromDate) {
                                $('#fromError').text('Please select a valid "From" date.');
                                isValid = false;
                            }

                            // Validate To date
                            if (!toDate) {
                                $('#toError').text('Please select a valid "To" date.');
                                isValid = false;
                            }

                            // Validate that From date is not after To date
                            if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
                                $('#toError').text('"To" date must be after "From" date.');
                                isValid = false;
                            }

                            // If validation fails, stop further execution
                            if (!isValid) {
                                return;
                            }

                            // If validation passes, perform the search (add your logic here)
                            console.log("Performing search with dates:", fromDate, toDate);
                        });
                    });
                </script>


                <div class="card card-default hide-before" hidden>
                    <div class="card-body">
                        <div class="table-wrapper">
                            <table id="header-report-table" class="table">
                                <>
                                    <!-- Table header will be dynamically created here -->
                                <tbody>
                                    <!-- Table body will be dynamically created here -->
                                </tbody>
                                <tfoot>
                                    <!-- Total row will be dynamically created here -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card card-default hide-before">

                    <div class="card-body">
                        <h2 class="float-left">
                            @T("Admin.Reports.TimeSummaryReport.ReportByEmployee")
                        </h2>
                        <div class="table-wrapper">
                            <table id="employee-report-table" class="table">
                                <thead>
                                    <!-- Table header will be dynamically created here -->
                                </thead>
                                <tbody>
                                    <!-- Table body will be dynamically created here -->
                                </tbody>
                                <tfoot>
                                    <!-- Total row will be dynamically created here -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card card-default hide-before">

                    <div class="card-body">
                        <h2 class="float-left">
                            @T("Admin.Reports.TimeSummaryReport.ReportByProject")
                        </h2>
                        <div class="table-wrapper">
                            <table id="project-report-table" class="table">
                                <thead>
                                    <!-- Table header will be dynamically created here -->
                                </thead>
                                <tbody>
                                    <!-- Table body will be dynamically created here -->
                                </tbody>
                                <tfoot>
                                    <!-- Total row will be dynamically created here -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>


                <div class="card card-default hide-before">
                    <div class="card-body">
                        <h2 class="float-left">
                            @T("Admin.Reports.TimeSummaryReport.ReportByTask")
                        </h2>
                        <div class="table-wrapper">
                            <table id="timesheet-report-table" class="table">
                                <thead>
                                    <!-- Table header will be dynamically created here -->
                                </thead>
                                <tbody>
                                    <!-- Table body will be dynamically created here -->
                                </tbody>
                                <tfoot>
                                    <!-- Total row will be dynamically created here -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>


                <div class="card card-default hide-before">
                    <div class="card-body">
                        <h2 class="float-left">
                            @T("Admin.Reports.TimeSummaryReport.DailySummary")
                        </h2>
                        <div id="date-report-grid"></div>
                    </div>
                </div>

            </div>
            <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
            <script>
                
                $(document).ready(function () {
                 
                    $("#SelectedProjectIds").data("kendoMultiSelect").value(0);
                    
                    fetchTasks();

                    // Task selection change event
                    $('#SelectedTaskIds').on('change', function () {
                        var taskMultiSelect = $("#SelectedTaskIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance
                        var selectedTaskIds = taskMultiSelect.value();  // Get the selected task IDs
                        console.log('Selected task IDs:', selectedTaskIds);
                        // Check if "All" (0) is selected
                        if (selectedTaskIds.includes(0)) {
                            // If "All" is the only selection, do nothing
                            if (selectedTaskIds.length === 1) {
                                return; // Only "All" is selected, do nothing
                            }

                            if (selectedTaskIds[selectedTaskIds.length - 1] === 0) {
                                // Keep only "All"
                                taskMultiSelect.value([0]);
                            } else {
                                // If another task is selected, unselect "All"
                                taskMultiSelect.value($.grep(selectedTaskIds, function (value) {
                                    return value !== 0; // Remove "All" from selection
                                }));
                            }
                        } else {
                            // If no tasks are selected, select "All" by default
                            if (selectedTaskIds.length === 0) {
                                taskMultiSelect.value([0]); // Default to "All"
                            }
                        }
                    });
                    
                    // Project selection change event
                    $('#SelectedProjectIds').on('change', function () {
                        var projectMultiSelect = $("#SelectedProjectIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance
                        var selectedProjectIds = projectMultiSelect.value();  // Get the selected project IDs
                        console.log('Selected project IDs:', selectedProjectIds);
                        // Check if "All" (0) is selected
                        if (selectedProjectIds.includes('0')) {
                            // If "All" is the only selection, do nothing
                            if (selectedProjectIds.length === 1) {
                                return; // Only "All" is selected, do nothing
                            }

                            // If "All" is selected last, unselect all other options
                            if (selectedProjectIds[selectedProjectIds.length - 1] === '0') {
                                // Keep only "All"
                                projectMultiSelect.value(['0']);
                            } else {
                                // If another project is selected, unselect "All"
                                projectMultiSelect.value($.grep(selectedProjectIds, function (value) {
                                    return value !== '0'; // Remove "All" from selection
                                }));
                            }
                        } else {
                            // If no projects are selected, select "All" by default
                            if (selectedProjectIds.length === 0) {
                                projectMultiSelect.value(['0']); // Default to "All"
                            }
                        }
                    });

                    // Employee selection change event

                    $('#SelectedEmployeeIds').on('change', function () {
                        var projectMultiSelect = $("#SelectedEmployeeIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance
                        var selectedProjectIds = projectMultiSelect.value();  // Get the selected project IDs
                        console.log('Selected project IDs:', selectedProjectIds);
                        // Check if "All" (0) is selected
                        if (selectedProjectIds.includes('0')) {
                            // If "All" is the only selection, do nothing
                            if (selectedProjectIds.length === 1) {
                                return; // Only "All" is selected, do nothing
                            }

                            // If "All" is selected last, unselect all other options
                            if (selectedProjectIds[selectedProjectIds.length - 1] === '0') {
                                // Keep only "All"
                                projectMultiSelect.value(['0']);
                            } else {
                                // If another project is selected, unselect "All"
                                projectMultiSelect.value($.grep(selectedProjectIds, function (value) {
                                    return value !== '0'; // Remove "All" from selection
                                }));
                            }
                        } else {
                            // If no projects are selected, select "All" by default
                            if (selectedProjectIds.length === 0) {
                                projectMultiSelect.value(['0']); // Default to "All"
                            }
                        }
                    });

                 
                    function getMonthlySegments(fromDate, toDate) {
                        let segments = [];
                        let current = new Date(fromDate);

                        // Loop through months, even if partial
                        while (current <= toDate) {
                            let startOfMonth = new Date(current.getFullYear(), current.getMonth(), 1);
                            let endOfMonth = new Date(current.getFullYear(), current.getMonth() + 1, 0); // Last day of the month

                            // Adjust the segment start and end based on the selected range
                            let segmentStart = current > fromDate ? current : fromDate;
                            let segmentEnd = endOfMonth > toDate ? toDate : endOfMonth;

                            segments.push({
                                start: new Date(segmentStart),
                                end: new Date(segmentEnd)
                            });

                            // Move to the next month
                            current = new Date(endOfMonth);
                            current.setDate(current.getDate() + 1);
                        }

                        return segments;
                    }

                    // Helper function to calculate weekly segments
                    function getWeeklySegments(fromDate, toDate) {
                        let segments = [];
                        let current = new Date(fromDate);

                        // Loop to calculate weekly segments
                        while (current <= toDate) {
                            let weekStart = new Date(current);
                            let weekEnd = new Date(current);
                            weekEnd.setDate(current.getDate() + (7 - current.getDay())); // Set to the end of the week (Sunday if you do satuerday then do 6 insetd of 7 as old)
                            segments.push({
                                start: new Date(weekStart),
                                end: new Date(Math.min(weekEnd, toDate))
                            });
                            current = new Date(weekEnd);
                            current.setDate(current.getDate() + 1); // Move to the next week's start (Sunday)
                        }


                        return segments;
                    }

                    // Format date as "Aug 1 - Aug 7"
                    function formatDateRange(startDate, endDate) {
                        let startMonth = startDate.toLocaleDateString('en-US', { month: 'short' });
                        let startDay = startDate.toLocaleDateString('en-US', { day: 'numeric' });
                        let endMonth = endDate.toLocaleDateString('en-US', { month: 'short' });
                        let endDay = endDate.toLocaleDateString('en-US', { day: 'numeric' });

                        if (startMonth === endMonth) {
                            return `${startMonth} ${startDay} - ${endDay}`;
                        } else {
                            return `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
                        }
                    }

                    function validateEmployeeSelection() {
                        var selectedProjectIds = $('#SelectedProjectIds').val(); // Get selected employee IDs
                        var From = $('#From').val();
                        var To = $('#To').val();
                        var selectedTaskIds = $('#SelectedTaskIds').val();
                        

                        var isValid = true; 

                        // Clear previous error messages
                        $('#Project-error').html('').css('color', '');
                        $('#From-error').html('').css('color', '');
                        $('#To-error').html('').css('color', '');
                        $('#Task-error').html('').css('color', '');
                        
                            


                        // Validate selected employees
                        if (!selectedProjectIds || selectedProjectIds.length === 0) {
                            $('#Project-error').html('Please select project.').css('color', 'red'); // Show error message
                            isValid = false; // Validation failed
                        }

                        if (!selectedTaskIds || selectedTaskIds.length === 0 || selectedTaskIds == null) {
                            $('#Task-error').html('Please select at least one task.').css('color', 'red'); // Show error message
                            isValid = false; // Validation failed
                        }

                      


                        // Validate From and To dates
                        if (!From || From == null) {
                            $('#From-error').html('Please select a start date.').css('color', 'red');
                            isValid = false; // Validation failed
                        }

                        if (!To) {
                            $('#To-error').html('Please select an end date.').css('color', 'red');
                            isValid = false; // Validation failed
                        }

                        if (From && To && new Date(To) < new Date(From)) {
                            $('#To-error').html('End date cannot be earlier than start date.').css('color', 'red');
                            isValid = false; // Validation failed
                        }

                        return isValid; // Return validation result
                    }

                    function fetchTasks() {
                        var projectIds = $('#SelectedProjectIds').val();  // Get the selected project IDs

                        // Validate project selection
                        if (projectIds && projectIds.length > 0) {
                            $('#projectError').text('');  // Clear error message if projects are selected

                            // Join project IDs into a comma-separated string
                            var projectIdsString = projectIds.join(',');

                            // Make GET request to fetch tasks based on selected project IDs
                            $.ajax({
                                url: '@Url.Action("GetTasksFromProjects", "Reports")',  // Your controller method to fetch tasks
                                type: 'GET',
                                data: { projectIds: projectIdsString },  // Send selected project IDs as query parameters
                                success: function (tasks) {
                                    var taskMultiSelect = $("#SelectedTaskIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance

                                    // Check if tasks were returned
                                    if (tasks && tasks.length > 0) {
                                        // Clear existing options
                                        taskMultiSelect.dataSource.data([]);  // Clear data source

                                        // Ensure the correct fields are set for Kendo MultiSelect
                                        taskMultiSelect.setOptions({
                                            dataTextField: "TaskName",  // Ensure this matches the field returned by the server
                                            dataValueField: "TaskId"    // Ensure this matches the field returned by the server
                                        });

                                        // Map the tasks to ensure correct TaskId and TaskName are used
                                        var taskData = tasks.map(function (task) {
                                            return {
                                                TaskId: task.TaskId,      // Make sure TaskId exists in the response
                                                TaskName: task.TaskName   // Make sure TaskName exists in the response
                                            };
                                        });

                                        // // Add the "All" option
                                        // taskData.unshift({ TaskId: 0, TaskName: 'All' });


                                        // Bind the new data to the Kendo MultiSelect
                                        taskMultiSelect.setDataSource(new kendo.data.DataSource({
                                            data: taskData
                                        }));

                                        // Preselect the "All" option
                                        taskMultiSelect.value([0]);  // Select the "All" option with ID -1

                                        taskMultiSelect.refresh();  // Refresh the dropdown
                                    } else {
                                        // If no tasks available, clear the MultiSelect and display a message
                                        taskMultiSelect.setOptions({
                                            dataTextField: "TaskName",
                                            dataValueField: "TaskId"
                                        });

                                        taskMultiSelect.setDataSource(new kendo.data.DataSource({
                                            data: [{ TaskId: '', TaskName: 'No tasks available' }]
                                        }));

                                        taskMultiSelect.refresh();  // Refresh the dropdown
                                    }
                                },
                                error: function (xhr, status, error) {
                                    console.error('Error fetching tasks:', error);
                                   
                                }
                            });

                        } else {
                            $('#projectError').text('Please select a valid project.');  // Show error message if no projects are selected
                            $('#SelectedTaskIds').empty().append($('<option></option>').val('').text('Select a project first'));
                        }
                    }
                    function isWeekend(data, date) {
                        const utcTimestamp = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
                        const utcDate = new Date(utcTimestamp);
                        const dateString = utcDate.toISOString().split('T')[0]; // extract the date part in YYYY-MM-DD format

                        const isweeked = data.some(item => {

                            return item.SpentDate.startsWith(dateString) && item.IsWeekend;
                        });


                        return isweeked;
                    }
                    function isHoliday(data, date) {
                        const utcTimestamp = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
                        const utcDate = new Date(utcTimestamp);
                        const dateString = utcDate.toISOString().split('T')[0]; // extract the date part in YYYY-MM-DD format


                        const isholiday = data.some(item => {

                            return item.SpentDate.startsWith(dateString) && item.IsHoliday;
                        });


                        return isholiday;
                    }

                    // Update the table with data and date segments
                    function updateTable(data, fromDate, toDate, showById) {
                        if (data && data.length > 0) {
                            $('.hide-before').removeClass('hide-before');
                        } else {
                            $('.hide-before').addClass('hide-before');
                        }

                        var tableBody = $("#timesheet-report-table tbody");
                        var tableHead = $("#timesheet-report-table thead");
                        var tableFoot = $("#timesheet-report-table tfoot");

                        tableBody.empty();
                        tableHead.empty();
                        tableFoot.empty();

                        var segments = [];
                        if (showById == "2") {
                            segments = getWeeklySegments(new Date(fromDate), new Date(toDate));
                        } else if (showById == "3") {
                            segments = getMonthlySegments(new Date(fromDate), new Date(toDate));
                        } else {
                            let current = new Date(fromDate);
                            while (current <= new Date(toDate)) {
                                let segment = {
                                    start: new Date(current),
                                    end: new Date(current),
                                    isWeekend: isWeekend(data, current),
                                    isHoliday: isHoliday(data, current)
                                };
                                segments.push(segment);
                                current.setDate(current.getDate() + 1);
                            }
                        }

                        var headerRow = $("<tr></tr>");
                        headerRow.append($("<th></th>").text("Tasks"));

                        segments.forEach(function (segment) {
                            var segmentText;
                            if (showById == "2") {
                                segmentText = formatDateRange(segment.start, segment.end);
                            } else if (showById == "3") {
                                var startDate = segment.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                var endDate = segment.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                segmentText = startDate + " - " + endDate;
                            } else {
                                segmentText = segment.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            }

                            if (segment.isHoliday) {
                                headerRow.append($("<th style='color:#4caf50'></th>").text(segmentText));
                            } else if (segment.isWeekend) {
                                headerRow.append($("<th style='color: red'></th>").text(segmentText));
                            } else {
                                headerRow.append($("<th></th>").text(segmentText));
                            }
                        });
                        headerRow.append($("<th></th>").text("Billable"));
                        headerRow.append($("<th></th>").text("Not-Bil."));
                        headerRow.append($("<th></th>").text("Total"));
                        tableHead.append(headerRow);

                        var groupedData = {};
                        data.forEach(function (item) {
                            if (!groupedData[item.TaskId]) {
                                groupedData[item.TaskId] = {
                                    name: item.TaskName,
                                    spentTimeByDate: {},
                                    totalSpentMinutes: 0,
                                    BillableMinutes:0
                                };
                            }

                            var spentMinutes = (item.SpentHours || 0) * 60 + (item.SpentMinutes || 0);
                            groupedData[item.TaskId].spentTimeByDate[item.SpentDate] = spentMinutes;
                            groupedData[item.TaskId].totalSpentMinutes += spentMinutes;
                             groupedData[item.TaskId].BillableMinutes += (item.BillableMinutes || 0);
                        });

                        groupedData = Object.fromEntries(Object.entries(groupedData).filter(([taskId, taskData]) => {
                            return taskData.totalSpentMinutes > 0;
                        }));

                        Object.keys(groupedData).forEach(function (taskId) {
                            var taskData = groupedData[taskId];
                            var row = $("<tr></tr>");

                                          var taskLink = $("<a></a>")
                    .attr("href", "/ProjectTask/Edit?id=" + taskId)
                    .attr("target", "_blank")
                    .text(taskData.name)
                    .css({
                        color: "#1e88e5",
                        textDecoration: "none",
                        fontWeight: "500"
                    });

                row.append($("<td></td>").append(taskLink));


                            segments.forEach(function (segment) {
                                var segmentTotal = 0;
                                Object.keys(taskData.spentTimeByDate).forEach(function (date) {
                                    var dateObj = new Date(date);
                                    if (dateObj >= segment.start && dateObj <= segment.end) {
                                        segmentTotal += taskData.spentTimeByDate[date];
                                    }
                                });

                                var formattedTime = segmentTotal ? formatMinutesToHHMM(segmentTotal) : "-";
                                row.append($("<td></td>").text(formattedTime));
                            });
                            var nonBillableMinutes = taskData.totalSpentMinutes - taskData.BillableMinutes;
                           row.append($("<td></td>").text(formatMinutesToHHMM(taskData.BillableMinutes)));
                            row.append($("<td></td>").text(formatMinutesToHHMM(nonBillableMinutes)));
                            row.append($("<td></td>").text(formatMinutesToHHMM(taskData.totalSpentMinutes)));
                            tableBody.append(row);
                        });
                var totalRow = $("<tr></tr>").addClass('totalRow');
                totalRow.append($("<th></th>").text("Total"));

                var grandTotalMinutes = 0;
                var grandTotalBillableMinutes = 0;

                // Loop through each date segment (day/week/month)
                segments.forEach(function (segment) {
                    var dateSegmentTotal = 0;

                    // Sum all tasks' minutes within this segment
                    Object.keys(groupedData).forEach(function (taskId) {
                        var taskData = groupedData[taskId];

                        Object.keys(taskData.spentTimeByDate).forEach(function (date) {
                            var dateObj = new Date(date);
                            if (dateObj >= segment.start && dateObj <= segment.end) {
                                dateSegmentTotal += taskData.spentTimeByDate[date];
                            }
                        });
                    });

                    totalRow.append(
                        $("<td class='totalRow'></td>").text(
                            dateSegmentTotal ? formatMinutesToHHMM(dateSegmentTotal) : "-"
                        )
                    );

                    grandTotalMinutes += dateSegmentTotal;
                });

                // Calculate totals for Billable and Non-Billable
                grandTotalBillableMinutes = Object.values(groupedData)
                    .reduce((sum, task) => sum + (task.BillableMinutes || 0), 0);

                var grandTotalNonBillableMinutes = grandTotalMinutes - grandTotalBillableMinutes;

                // Append totals to footer
                totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalBillableMinutes)));
                totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalNonBillableMinutes)));
                totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalMinutes)));

                tableFoot.append(totalRow);

                                                                                                                             
                    }


                    function updateEmployeeTable(data, fromDate, toDate, showById) {
                        var tableBody = $("#employee-report-table tbody");
                        var tableHead = $("#employee-report-table thead");
                        var tableFoot = $("#employee-report-table tfoot");

                        // Clear previous data
                        tableBody.empty();
                        tableHead.empty();
                        tableFoot.empty();

                        // Calculate the date segments based on ShowById
                        var segments = [];
                        if (showById == "2") {
                            // Weekly view
                            segments = getWeeklySegments(new Date(fromDate), new Date(toDate));
                        } else if (showById == "3") {
                            // Monthly view
                            segments = getMonthlySegments(new Date(fromDate), new Date(toDate));
                        } else {
                            // Daily view
                            let current = new Date(fromDate);
                            while (current <= new Date(toDate)) {
                                let segment = {
                                    start: new Date(current),
                                    end: new Date(current),
                                    isWeekend: isWeekend(data, current),
                                    isHoliday: isHoliday(data, current)
                                };
                                segments.push(segment);
                                current.setDate(current.getDate() + 1);
                            }
                        }

                        // Create table header with segment ranges
                        var headerRow = $("<tr></tr>");
                        headerRow.append($("<th></th>").text("Team Members")); // First column for employee names
                                                 
                        segments.forEach(function (segment) {
                            var segmentText;
                            if (showById == "2") {
                                // Weekly format: "Aug 1 - Aug 7"
                                segmentText = formatDateRange(segment.start, segment.end);
                            } else if (showById == "3") {
                                // Monthly format: "Aug 1 - Aug 31"
                                segmentText = segment.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + " - " +
                                    segment.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            } else {
                                // Daily format: "Aug 1"
                                segmentText = segment.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            }

                            var headerCell = $("<th></th>").text(segmentText);
                            if (segment.isHoliday) {
                                headerCell.css("color", "#4caf50");
                            } else if (segment.isWeekend) {
                                headerCell.css("color", "red");
                            }
                            headerRow.append(headerCell);
                        });
                        headerRow.append($("<th></th>").text("Billable"));
                        headerRow.append($("<th></th>").text("Not-Bil."));
                        headerRow.append($("<th></th>").text("Total"));
                        tableHead.append(headerRow);

                        // Group data by EmployeeId
                        var groupedData = {};
                        data.forEach(function (item) {
                            if (!groupedData[item.EmployeeId]) {
                                groupedData[item.EmployeeId] = {
                                    name: item.EmployeeName,
                                    spentTimeByDate: {},
                                    totalSpentMinutes: 0,
                                    BillableMinutes:0
                                };
                            }
                             
                            // Convert hours & minutes into total minutes
                            var spentMinutes = (item.SpentHours || 0) * 60 + (item.SpentMinutes || 0);
                            groupedData[item.EmployeeId].spentTimeByDate[item.SpentDate] = spentMinutes;
                            groupedData[item.EmployeeId].totalSpentMinutes += spentMinutes;
                             groupedData[item.EmployeeId].BillableMinutes += (item.BillableMinutes || 0);
                        });

                        // Filter out empty rows
                        groupedData = Object.fromEntries(Object.entries(groupedData).filter(([_, taskData]) => taskData.totalSpentMinutes > 0));

                        // Add data rows for each employee
                        Object.keys(groupedData).forEach(function (employeeId) {
                            var taskData = groupedData[employeeId];
                            var row = $("<tr></tr>");
                            row.append($("<td></td>").text(taskData.name));

                            // Hours for each segment
                            segments.forEach(function (segment) {
                                var segmentTotalMinutes = 0;
                                Object.keys(taskData.spentTimeByDate).forEach(function (date) {
                                    var dateObj = new Date(date);
                                    if (dateObj >= segment.start && dateObj <= segment.end) {
                                        segmentTotalMinutes += taskData.spentTimeByDate[date];
                                    }
                                });

                                // Convert minutes to HH:MM format
                                var formattedTime = formatMinutesToHHMM(segmentTotalMinutes);
                                row.append($("<td></td>").text(formattedTime !== "00:00" ? formattedTime : "-"));
                            });
                            var nonBillableMinutes = taskData.totalSpentMinutes - taskData.BillableMinutes;

                            row.append($("<td></td>").text(formatMinutesToHHMM(taskData.BillableMinutes)));
                            row.append($("<td></td>").text(formatMinutesToHHMM(nonBillableMinutes)));
                            row.append($("<td></td>").text(formatMinutesToHHMM(taskData.totalSpentMinutes)));
                            tableBody.append(row);
                        });

                        // Add a row for the total of all employees
                        var totalRow = $("<tr></tr>").addClass('totalRow');
                        totalRow.append($("<th></th>").text("Total"));

                        var grandTotalMinutes = 0;
                         var grandTotalBillableMinutes = 0;
                        segments.forEach(function (segment) {
                            var segmentTotalMinutes = 0;
                            Object.keys(groupedData).forEach(function (employeeId) {
                                var taskData = groupedData[employeeId];
                                Object.keys(taskData.spentTimeByDate).forEach(function (date) {
                                    var dateObj = new Date(date);

                                    if (dateObj >= segment.start && dateObj <= segment.end) {
                                        segmentTotalMinutes += taskData.spentTimeByDate[date];
                                    }
                                });
                            });
 
                            totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(segmentTotalMinutes)));
                            grandTotalMinutes += segmentTotalMinutes;
                        });
                                                grandTotalBillableMinutes = Object.values(groupedData)
                .reduce((sum, emp) => sum + emp.BillableMinutes, 0);
                var grandTotalNonBillableMinutes = grandTotalMinutes - grandTotalBillableMinutes;

                totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalBillableMinutes)));
                totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalNonBillableMinutes)));

                        totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalMinutes)));
                        tableFoot.append(totalRow);
                    }
                    //  Function to Convert Minutes into HH:MM Format
                    function formatMinutesToHHMM(totalMinutes) {
                        var hours = Math.floor(totalMinutes / 60);
                        var minutes = totalMinutes % 60;
                        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    }

                    //  Function to Format Date Ranges for Weekly Segments
                    function formatDateRange(start, end) {
                        var startDate = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        var endDate = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        return startDate + " - " + endDate;
                    }
                    function updateProjectTable(data, fromDate, toDate, showById) {
                        var tableBody = $("#project-report-table tbody");
                        var tableHead = $("#project-report-table thead");
                        var tableFoot = $("#project-report-table tfoot");

                        // Clear previous data
                        tableBody.empty();
                        tableHead.empty();
                        tableFoot.empty();

                        // Calculate the date segments based on ShowById
                        var segments = [];
                        if (showById == "2") {
                            segments = getWeeklySegments(new Date(fromDate), new Date(toDate));
                        } else if (showById == "3") {
                            segments = getMonthlySegments(new Date(fromDate), new Date(toDate));
                        } else {
                            let current = new Date(fromDate);
                            while (current <= new Date(toDate)) {
                                let segment = {
                                    start: new Date(current),
                                    end: new Date(current),
                                    isWeekend: isWeekend(data, current),
                                    isHoliday: isHoliday(data, current)
                                };
                                segments.push(segment);
                                current.setDate(current.getDate() + 1);
                            }
                        }

                        // Create table header
                        var headerRow = $("<tr></tr>").addClass("header-row");
                        headerRow.append($("<th></th>").text("Projects"));

                        segments.forEach(function (segment) {
                            var segmentText;
                            if (showById == "2") {
                                segmentText = formatDateRange(segment.start, segment.end);
                            } else if (showById == "3") {
                                var startDate = segment.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                var endDate = segment.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                segmentText = startDate + " - " + endDate;
                            } else {
                                segmentText = segment.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            }

                            var headerCell = $("<th></th>").text(segmentText);
                            if (segment.isHoliday) headerCell.css("color", "#4caf50");
                            if (segment.isWeekend) headerCell.css("color", "red");
                            headerRow.append(headerCell);
                        });
                        headerRow.append($("<th></th>").text("Billable"));
                        headerRow.append($("<th></th>").text("Not-Bil."));
                        headerRow.append($("<th></th>").text("Total"));

                        tableHead.append(headerRow);

                        // Group data by ProjectId
                        var groupedData = {};
                        data.forEach(function (item) {
                            if (!groupedData[item.ProjectId]) {
                                groupedData[item.ProjectId] = {
                                    name: item.ProjectName,
                                    spentTimeByDate: {},
                                    totalSpentMinutes: 0,
                                    BillableMinutes:0
                                };
                            }

                            var spentMinutes = (item.SpentHours || 0) * 60 + (item.SpentMinutes || 0);
                            groupedData[item.ProjectId].spentTimeByDate[item.SpentDate] = spentMinutes;
                            groupedData[item.ProjectId].totalSpentMinutes += spentMinutes;
                             groupedData[item.ProjectId].BillableMinutes += (item.BillableMinutes || 0);
                        });

                        groupedData = Object.fromEntries(Object.entries(groupedData).filter(([_, taskData]) => taskData.totalSpentMinutes > 0));

                        // Add data rows for each project
                        Object.keys(groupedData).forEach(function (projectId) {
                            var projectData = groupedData[projectId];
                            var row = $("<tr></tr>").addClass("row-border");

                            row.append($("<td></td>").text(projectData.name));

                            segments.forEach(function (segment) {
                                var segmentTotal = 0;
                                Object.keys(projectData.spentTimeByDate).forEach(function (date) {
                                    var dateObj = new Date(date);
                                    if (dateObj >= segment.start && dateObj <= segment.end) {
                                        segmentTotal += projectData.spentTimeByDate[date];
                                    }
                                });

                                var formattedTime = segmentTotal ? formatMinutesToHHMM(segmentTotal) : "-";
                                row.append($("<td></td>").text(formattedTime));
                            });
                              var nonBillableMinutes = projectData.totalSpentMinutes - projectData.BillableMinutes;
                           row.append($("<td></td>").text(formatMinutesToHHMM(projectData.BillableMinutes)));
                            row.append($("<td></td>").text(formatMinutesToHHMM(nonBillableMinutes)));
                            row.append($("<td></td>").text(formatMinutesToHHMM(projectData.totalSpentMinutes)));
                            tableBody.append(row);
                        });

                        // Add total row
                        var totalRow = $("<tr></tr>").addClass('totalRow row-border');
       
                        totalRow.append($("<th></th>").text("Total"));


                        var grandTotalMinutes = 0;
                        var grandTotalBillableMinutes =0;
                        segments.forEach(function (segment) {
                            var dateSegmentTotal = 0;
                            Object.keys(groupedData).forEach(function (projectId) {
                                var projectData = groupedData[projectId];
                                Object.keys(projectData.spentTimeByDate).forEach(function (date) {
                                    var dateObj = new Date(date);
                                    if (dateObj >= segment.start && dateObj <= segment.end) {
                                        dateSegmentTotal += projectData.spentTimeByDate[date];
                                    }
                                });
                            });

                            totalRow.append($("<td class='totalRow'></td>").text(dateSegmentTotal ? formatMinutesToHHMM(dateSegmentTotal) : "-"));
                            grandTotalMinutes += dateSegmentTotal;
                        });
                          grandTotalBillableMinutes = Object.values(groupedData)
                .reduce((sum, emp) => sum + emp.BillableMinutes, 0);
                var grandTotalNonBillableMinutes = grandTotalMinutes - grandTotalBillableMinutes;

                totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalBillableMinutes)));
                totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalNonBillableMinutes)));

                        totalRow.append($("<td class='totalRow'></td>").text(formatMinutesToHHMM(grandTotalMinutes)));
                        tableFoot.append(totalRow);
                    }

  

                    function updateDateReportTable(data, fromDate, toDate, showById) {
                        // Convert SpentHours to HH:MM format before passing to jqxGrid
                        data.forEach(function (item) {
                            var spentMinutes = (item.SpentHours || 0) * 60 + (item.SpentMinutes || 0);
                            item.SpentTimeFormat = formatMinutesToHHMM(spentMinutes);
                        });

                        $("#date-report-grid").jqxGrid({
                            width: '100%',
                            autoheight: true,
                            sortable: true,
                            columnsresize: true,
                            source: {
                                datatype: 'json',
                                datafields: [
                                    { name: 'TaskId' },

                                    { name: 'TaskName' },
                                    { name: 'ProjectName' },
                                    { name: 'EmployeeName' },
                                    { name: 'SpentDateFormat' },
                                    { name: 'SpentTimeFormat' } // Updated to store formatted HH:MM value
                                ],
                                localdata: data // Use the updated data with formatted time
                            },
                            columns: [
                                               {
                    text: 'Task Name',
                    datafield: 'TaskName',
                    width: '35%',
                    minwidth: 150,
                    cellclassname: 'wrap-text',
                    cellsrenderer: function (row, column, value, defaulthtml, columnproperties, rowdata) {
                        if (!rowdata.TaskId) return value;
                        
                        return `
                            <a href="/ProjectTask/Edit?id=${rowdata.TaskId}"
                               target="_blank"
                               style="color:#1e88e5; font-weight:500; text-decoration:none; ">
                               ${value}
                            </a>
                        `;
                    }
                },

                                { text: 'Project', datafield: 'ProjectName', width: '25%', cellclassname: 'wrap-text' },
                                { text: 'Employee', datafield: 'EmployeeName', width: '20%', cellclassname: 'wrap-text' },
                                { text: 'Spent Date', datafield: 'SpentDateFormat', width: '10%', minwidth: 80, cellsformat: 'd', cellclassname: 'wrap-text' },
                                { text: 'Spent Time', datafield: 'SpentTimeFormat', width: '10%', minwidth: 60, cellclassname: 'wrap-text' } // Updated to use formatted time
                            ],
                            pageable: true,
                            pagesize: 20,
                            pagesizeoptions: ['10', '20', '50', '100'],
                            pagerMode: 'advanced',
                            showaggregates: false,
                            showstatusbar: false,
                            columnsresize: true
                        });
                    }

                    



                    // Fetch data when the "Run Report" button is clicked
                    function fetchData() {

                        if (!validateEmployeeSelection()) {
                            return; // Stop further execution if validation fails
                        }

                        
                        var From = moment($("#From").val()).format("M/D/YYYY");
                        var To = moment($("#To").val()).format("M/D/YYYY");
                        var showById = $('#ShowById').val();
                        var selectedProjectIds = $('#SelectedProjectIds').val();
                        var selectedTaskIds = $('#SelectedTaskIds').val();
                        var selectedEmployeeIds = $('#SelectedEmployeeIds').val();
                        var currCustomer = @Html.Raw(Model.EmployeeId);
                        var hours = $('#HoursId').val();
                        var isHide = $('#IsHideEmpty').val();
                       

                        // Clear previous data
                        $("#timesheet-report-table tbody").empty();
                        $("#timesheet-report-table thead").empty();
                        $("#timesheet-report-table tfoot").empty();

                        var aggregatedData = [];
                        var totalRequests = 0;
                        var completedRequests = 0;

                        var employeeIdsString = selectedEmployeeIds.join(',');
 
                        // Fetch data based on employees or all employees
                        if (selectedTaskIds.includes("0")) {
                            // Fetch all employees' data
                            var projectIdsString = selectedProjectIds.join(',');
                           
                            var postData ={ From: From, To: To, ShowById: showById, HoursId: hours, projectIds: projectIdsString, employeeIds: employeeIdsString, IsHideEmpty: isHide, currCustomer: currCustomer };
                            addAntiForgeryToken(postData);
                            $.ajax({
                                url: "@(Url.Action("GetAllTasksData", "Reports"))",
                                type: "POST",
                                data: postData,
                                success: function (data) {
                                    aggregatedData = data;
                                    console.log("aggregatedDataalltask", aggregatedData)
                                    updateTable(aggregatedData, From, To, showById);

                                    // Pass date range and showById to updateTable
                                },
                                error: function (xhr, status, error) {
                                    console.error('Error fetching data for all employees:', error);
                                }
                            });
                        } else {
                            totalRequests = selectedTaskIds.length;
                            
                            selectedTaskIds.forEach(function (taskId) {
                                var postData = { From: From, To: To, ShowById: showById, HoursId: hours, TaskId: taskId, employeeIds: employeeIdsString, IsHideEmpty: isHide, currCustomer: currCustomer }
                                addAntiForgeryToken(postData);
                                $.ajax({
                                    url: "@(Url.Action("GetReportByTask", "Reports"))",
                                    type: "POST",
                                    data: postData,
                                    success: function (data) {

                                        aggregatedData = aggregatedData.concat(data);
                                        completedRequests++;
                                        if (completedRequests === totalRequests) {

                                            updateTable(aggregatedData, From, To, showById);
                                            // Pass date range and showById to updateTable
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                     
                                        completedRequests++;
                                        if (completedRequests === totalRequests) {
                                            updateTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                        }
                                    }
                                });
                            });
                        }
                    }

                    function fetchProjectData() {

                        if (!validateEmployeeSelection()) {
                            return; // Stop further execution if validation fails
                        }

                        
                     
                        var From = moment($("#From").val()).format("M/D/YYYY");
                        var To = moment($("#To").val()).format("M/D/YYYY");
                        var showById = $('#ShowById').val();
                        var selectedProjectIds = $('#SelectedProjectIds').val();
                        var selectedEmployeeIds = $('#SelectedEmployeeIds').val();
                        var selectedTaskIds = $('#SelectedTaskIds').val();
                        var hours = $('#HoursId').val();
                        var isHide = $('#IsHideEmpty').val();
                        var currCustomer = @Html.Raw(Model.EmployeeId);

                        // Clear previous data
                        $("#project-report-table tbody").empty();
                        $("#project-report-table thead").empty();
                        $("#project-report-table tfoot").empty();

                        var aggregatedData = [];
                        var totalRequests = 0;
                        var completedRequests = 0;
                        var employeeIdsString = selectedEmployeeIds.join(',');
                        // Fetch data based on employees or all employees
                        if (selectedProjectIds.includes("0")) {
                            // Fetch all employees' data
                           
                            var taskIdsString = selectedTaskIds.join(',');
                            var postData={ From: From, To: To, ShowById: showById, HoursId: hours, TaskIds: taskIdsString, EmployeeIds: employeeIdsString, currCustomer: currCustomer }
                            addAntiForgeryToken(postData);
                            $.ajax({
                                url: "@(Url.Action("GetAllProjectsDataForSummary", "Reports"))",
                                type: "POST",
                                data: postData,
                                success: function (data) {
                                    aggregatedData = data;
                                  
                                    updateProjectTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                },
                                error: function (xhr, status, error) {
                                    console.error('Error fetching data for all employees:', error);
                                }
                            });
                        } else {
                           
                            var taskIdsString = selectedTaskIds.join(',');

                            totalRequests = selectedProjectIds.length;
                            selectedProjectIds.forEach(function (projectId) {
                                var postData=  { projectId: projectId, From: From, To: To, ShowById: showById, HoursId: hours, TaskIds: taskIdsString, EmployeeIds: employeeIdsString, currCustomer: currCustomer };
                                addAntiForgeryToken(postData);
                                $.ajax({
                                    url: "@(Url.Action("GetReportByProjectForSummary", "Reports"))",
                                    type: "POST",
                                    data: postData,
                                    success: function (data) {
                                        console.log(data);
                                        aggregatedData = aggregatedData.concat(data);
                                        completedRequests++;
                                        if (completedRequests === totalRequests) {
                                            console.log("fetched data", aggregatedData);
                                            updateProjectTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                       
                                        completedRequests++;
                                        if (completedRequests === totalRequests) {
                                            updateProjectTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                        }
                                    }
                                });
                            });
                        }
                    }
                    function fetchEmployeeData() {

                        if (!validateEmployeeSelection()) {
                            return; // Stop further execution if validation fails
                        }

                        var selectedEmployeeIds = $('#SelectedEmployeeIds').val(); // Array of employee IDs
                        var From = moment($("#From").val()).format("M/D/YYYY");
                        var To = moment($("#To").val()).format("M/D/YYYY");
                        var showById = $('#ShowById').val();
                        var selectedProjectIds = $('#SelectedProjectIds').val();
                        var selectedTaskIds = $('#SelectedTaskIds').val();
                        var hours = $('#HoursId').val();
                        var isHide = $('#IsHideEmpty').val();
                        var currCustomer = @Html.Raw(Model.EmployeeId);
                        // Clear previous data
                        $("#employee-report-table tbody").empty();
                        $("#employee-report-table thead").empty();
                        $("#employee-report-table tfoot").empty();

                        var aggregatedData = [];
                        var totalRequests = 0;
                        var completedRequests = 0;
                        console.log("selectedEmployeeIds", selectedEmployeeIds)
                        // Fetch data based on employees or all employees
                        if (selectedEmployeeIds.includes("0")) {
                            // Fetch all employees' data
                            var projectIdsString = selectedProjectIds.join(',');
                            var taskIdsString = selectedTaskIds.join(',');

                            var postData = { From: From, To: To, ShowById: showById, ProjectIds: projectIdsString, HoursId: hours, TaskIds: taskIdsString, currCustomer: currCustomer };

                            addAntiForgeryToken(postData);
                            $.ajax({
                                url: "@(Url.Action("GetAllEmployeesWithProjectsData", "Reports"))",
                                type: "POST",
                                data: postData,
                                success: function (data) {
                                    aggregatedData = data;

                                    updateEmployeeTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                },
                                error: function (xhr, status, error) {
                                    console.error('Error fetching data for all employees:', error);
                                }
                            });
                        } else {
                            var projectIdsString = selectedProjectIds.join(',');
                            var taskIdsString = selectedTaskIds.join(',');

                            totalRequests = selectedEmployeeIds.length;
                            selectedEmployeeIds.forEach(function (employeeId) {

                                var postData={ searchEmployeeId: employeeId, From: From, To: To, ShowById: showById, ProjectIds: projectIdsString, HoursId: hours, TaskIds: taskIdsString, currCustomer };
                                addAntiForgeryToken(postData);

                                $.ajax({
                                    url: "@(Url.Action("GetReportByWithProjectsEmployee", "Reports"))",
                                    type: "POST",
                                    data: postData,
                                    success: function (data) {
                                        console.log(data);
                                        aggregatedData = aggregatedData.concat(data);
                                        completedRequests++;
                                        if (completedRequests === totalRequests) {
                                         
                                            updateEmployeeTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error fetching data for employee ID ' + employeeId + ':', error);
                                        completedRequests++;
                                        if (completedRequests === totalRequests) {
                                            updateEmployeeTable(aggregatedData, From, To, showById); // Pass date range and showById to updateTable
                                        }
                                    }
                                });
                            });
                        }
                    }

                    function fetchDateData() {

                        if (!validateEmployeeSelection()) {
                            return; // Stop further execution if validation fails
                        }
                       
                        var From = $('#From').val();
                        var To = $('#To').val();
                        var showById = $('#ShowById').val();
                        var selectedProjectIds = $('#SelectedProjectIds').val();
                        var selectedTaskIds = $('#SelectedTaskIds').val();
                        var selectedEmployeeIds = $('#SelectedEmployeeIds').val();
                        var currCustomer = @Html.Raw(Model.EmployeeId);
                        var hours = $('#HoursId').val();
                        var isHide = $('#IsHideEmpty').val();
                       

                        // Clear previous data
                        $("#date-report-table tbody").empty();
                        $("#date-report-table thead").empty();
                        $("#date-report-table tfoot").empty();

                        var projectIdsString = selectedProjectIds.join(',');
                        var employeeIdsString = selectedEmployeeIds.join(',');
                        var taskIdsString = selectedTaskIds.join(',');
                   

                        var postData = { From: From, To: To, ShowById: showById, projectIds: projectIdsString, taskIds: taskIdsString, EmployeeIds: employeeIdsString, HoursId: hours, currCustomer: currCustomer };
                        addAntiForgeryToken(postData);
                        $.ajax({
                            url: "@(Url.Action("GetDateReportData", "Reports"))",
                            type: "POST",
                            data: postData,
                            success: function (data) {
                                aggregatedData = data;

                                console.log("aggregatedData", aggregatedData);
                                updateDateReportTable(aggregatedData, From, To);
                                // Pass date range and showById to updateTable
                            },
                            error: function (xhr, status, error) {
                                console.error('Error fetching data for all employees:', error);
                            }
                        });

                    }

                    //if change then validation text is gone
                    $('#SelectedProjectIds').change(function () {
                        $('#Project-error').html('').css('color', '');
                    });

                   
                    $('#SelectedTaskIds').change(function () {
                        $('#Task-error').html('').css('color', '');
                    });

                    $('#From').change(function () {
                        $('#From-error').html('').css('color', '');

                    });

                    $('#To').change(function () {
                        $('#To-error').html('').css('color', '');
                    });

                    $('#SelectedProjectIds').on('change', function () {
                        var projectIds = $(this).val();  // Get the selected project IDs

                        // Validate project selection
                        if (projectIds && projectIds.length > 0) {
                            $('#projectError').text('');  // Clear error message if projects are selected

                            // Join project IDs into a comma-separated string
                            var projectIdsString = projectIds.join(',');

                            // Make GET request to fetch tasks based on selected project IDs
                            $.ajax({
                                url: '@Url.Action("GetTasksFromProjects", "Reports")',  // Your controller method to fetch tasks
                                type: 'GET',
                                data: { projectIds: projectIdsString },  // Send selected project IDs as query parameters
                                success: function (tasks) {
                                    console.log('tasks:', tasks);
                                    var taskMultiSelect = $("#SelectedTaskIds").data("kendoMultiSelect");  // Get Kendo MultiSelect instance
                                    var selectedProject = $('#SelectedProjectIds').val();
                                    // Check if tasks were returned
                                    console.log('selectedProject:', selectedProject.includes('0'));
                                    if (selectedProject.includes('0') || (tasks && tasks.length > 0)) {
                                        // Clear existing options
                                        taskMultiSelect.dataSource.data([]);  // Clear data source

                                        // Ensure the correct fields are set for Kendo MultiSelect
                                        taskMultiSelect.setOptions({
                                            dataTextField: "TaskName",  // Ensure this matches the field returned by the server
                                            dataValueField: "TaskId"    // Ensure this matches the field returned by the server
                                        });

                                        // Map the tasks to ensure correct TaskId and TaskName are used
                                        var taskData = tasks.map(function (task) {

                                            return {
                                                TaskId: task.TaskId,      // Make sure TaskId exists in the response
                                                TaskName: task.TaskName   // Make sure TaskName exists in the response
                                            };
                                        });

                                        // // Add the "All" option
                                        // taskData.unshift({ TaskId: 0, TaskName: 'All' });


                                        // Bind the new data to the Kendo MultiSelect
                                        taskMultiSelect.setDataSource(new kendo.data.DataSource({
                                            data: taskData
                                        }));

                                        // Preselect the "All" option
                                        taskMultiSelect.value([0]);  // Select the "All" option with ID -1

                                        taskMultiSelect.refresh();  // Refresh the dropdown
                                    } else {
                                        // If no tasks available, clear the MultiSelect and display a message
                                        taskMultiSelect.setOptions({
                                            dataTextField: "TaskName",
                                            dataValueField: "TaskId"
                                        });

                                        taskMultiSelect.setDataSource(new kendo.data.DataSource({
                                            data: [{ TaskId: '', TaskName: 'No tasks available' }]
                                        }));

                                        taskMultiSelect.refresh();  // Refresh the dropdown
                                    }
                                },
                                error: function (xhr, status, error) {
                                    console.error('Error fetching tasks:', error);
                                    
                                }
                            });



                        } else {
                            $('#projectError').text('Please select a valid project.');  // Show error message if no projects are selected
                            $('#SelectedTaskIds').empty().append($('<option></option>').val('').text('Select a project first'));
                        }


                    });


                    // Attach click event to search button
                    $('#search-brands').click(fetchData);
                    $('#search-brands').click(fetchProjectData);
                    $('#search-brands').click(fetchDateData);
                    $('#search-brands').click(fetchEmployeeData);



                    // Call fetchData initially to populate the table
                });
                
                $(document).on('click', 'button', function () {
                    $(this).blur();
                });
            </script>
        </div>
    </div>
</section>