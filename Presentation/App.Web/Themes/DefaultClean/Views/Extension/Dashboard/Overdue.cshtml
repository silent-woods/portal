@model App.Web.Models.Dashboard.PendingDashboardModel

@{
    Layout = "_ColumnsOne";
}
<link rel="stylesheet" href="@Url.Content("~/Themes/DefaultClean/Content/css/dashboard.css")" />
<div class="code-review-dashboard">
    <div class="page-header-bar">
        <h1>
            <span class="dashboard-text">Dashboard</span>
        </h1>
        <div class="page-nav">
            <a href="@Url.Action("FollowUp", "Dashboard")"
               class="page-nav-link">
                Follow-Up
            </a>
            <a href="@Url.Action("CodeReview", "Dashboard")"
               class="page-nav-link">
                Code Review
                @if (Model.PendingCodeReviewCount > 0)
                {
                    <span class="nav-count">
                        @Model.PendingCodeReviewCount
                    </span>
                }
            </a>
            <a href="@Url.Action("ReadyToTest", "Dashboard")"
               class="page-nav-link">
                Ready To Test
                @if (Model.PendingReadyToTestCount > 0)
                {
                    <span class="nav-count">
                        @Model.PendingReadyToTestCount
                    </span>
                }
            </a>
            <a href="@Url.Action("Overdue", "Dashboard")"
               class="page-nav-link active">
                Overdue
            </a>
        </div>
    </div>
    <div class="cr-filter-bar">
        <select id="projectId" class="cr-filter-input">
            <option value="0">All Projects</option>
            @foreach (var p in Model.AvailableProjects)
            {
                <option value="@p.Value">@p.Text</option>
            }
        </select>
        <select id="employeeId" class="cr-filter-input">
            <option value="0">All Employees</option>
            @foreach (var e in Model.AvailableEmployees)
            {
                <option value="@e.Value">@e.Text</option>
            }
        </select>
        <input type="text"
               id="taskName"
               class="cr-filter-input"
               placeholder="Search task name..." />
        <button id="btnSearch" class="cr-search-btn">
            Search
        </button>
    </div>
    <input type="hidden" id="selectedStatusId" value="0" />
    <div class="status-filter-bar">
        @foreach (var wfGroup in Model.StatusFilters
                .Where(s => s.Count > 0)
                .GroupBy(s => s.ProcessWorkflowName))
        {
            <div class="workflow-row">
                <span class="workflow-title">@wfGroup.Key</span>

                <div class="status-list">
                    @foreach (var s in wfGroup)
                    {
                        <span class="status-pill @(s.StatusId == Model.SelectedStatusId ? "active" : "")"
                              data-statusid="@s.StatusId">
                            <span class="dot" style="background:@s.ColorCode"></span>
                            @s.StatusName
                            <span class="count">@s.Count</span>
                        </span>
                    }
                </div>
            </div>
        }
    </div>
    <div id="overdueTaskContainer">
        @await Html.PartialAsync("/Themes/DefaultClean/Views/Extension/Dashboard/_OverdueTaskList.cshtml",Model)
    </div>
</div>

<script>
    $("#btnSearch").on("click", function () {
          $("#selectedStatusId").val(0);
    $(".status-pill").removeClass("active");
        loadOverdueTasks();
    });
    function loadOverdueTasks() {
         var statusId = $("#selectedStatusId").val()
        $.get("/Dashboard/SearchOverdueTasks", {
            projectId: $("#projectId").val(),
            employeeId: $("#employeeId").val(),
            taskName: $("#taskName").val(),
            statusId: statusId
        })
        .done(function (html) {
            $("#overdueTaskContainer").html(html);
            if(statusId ==0)
             updateStatusCountsFromTasks();
        })
        .fail(function () {
            alert("Failed to load overdue tasks");
        });
    }

      $(document).on("click", ".status-pill", function () {
        var $this = $(this);
        if ($this.hasClass("disabled"))
            return;

        var statusId = $this.data("statusid");
        var $hidden = $("#selectedStatusId");
        if ($this.hasClass("active")) {
            $this.removeClass("active");
            $hidden.val(0); 
        } else {
            $(".status-pill").removeClass("active");
            $this.addClass("active");
            $hidden.val(statusId);
        }

        loadOverdueTasks();
    });

       function updateStatusCountsFromTasks() {
        var counts = {};
        var selectedStatusId = $("#selectedStatusId").val();
        $("#overdueTaskContainer tr[data-statusid]").each(function () {
            var sid = $(this).data("statusid");
            counts[sid] = (counts[sid] || 0) + 1;
        });
        $(".status-pill").each(function () {

            var $pill = $(this);
            var sid = $pill.data("statusid");
            var count = counts[sid] || 0;
            $pill.find(".count").text(count);
            if (selectedStatusId == 0) {
                if (count === 0) {
                    $pill.hide();
                } else {
                    $pill.show();
                }
            } else {
                $pill.show();
            }
        });
    }
</script>
