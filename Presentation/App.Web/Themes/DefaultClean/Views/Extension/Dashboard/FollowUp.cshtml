@model App.Web.Models.Dashboard.PendingDashboardModel

@{
    Layout = "_ColumnsOne";
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/themes/8.2.1/default/default-main.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
<script src="https://kendo.cdn.telerik.com/2023.2.829/js/kendo.all.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="@Url.Content("~/Themes/DefaultClean/Content/css/dashboard.css")" />
<div class="page-header-bar">
    <h1><span class="dashboard-text">Dashboard</span></h1>
    <div class="page-nav">
        <a href="@Url.Action("FollowUp", "Dashboard")"
           class="page-nav-link active">
            Follow-Up
        </a>
        <a href="@Url.Action("CodeReview", "Dashboard")"
           class="page-nav-link">
            Code Review
            @if (Model.PendingCodeReviewCount > 0)
            {
                <span class="nav-count">
                    @Model.PendingCodeReviewCount
                </span>
            }
        </a>
         <a href="@Url.Action("ReadyToTest", "Dashboard")"
               class="page-nav-link">
                Ready To Test
            @if (Model.PendingReadyToTestCount > 0)
            {
                <span class="nav-count">
                    @Model.PendingReadyToTestCount
                </span>
            }
            </a>
        <a href="@Url.Action("Overdue", "Dashboard")"
           class="page-nav-link">
            Overdue
            @if (Model.PendingOverdueCount > 0)
            {
                <span class="nav-count">
                    @Model.PendingOverdueCount
                </span>
            }
        </a>
    </div>
</div>
<div class="filter-bar">
    <div class="filter-row">
        <select id="projectFilter"
                name="projectFilter"
                class="kendo-multi-select"
                multiple>
            @foreach (var p in Model.AvailableProjects)
            {
                <option value="@p.Value">@p.Text</option>
            }
        </select>

        <select id="employeeId"
                name="employeeId"
                class="kendo-multi-select"
                multiple>
            @foreach (var e in Model.AvailableEmployees)
            {
                <option value="@e.Value">@e.Text</option>
            }
        </select>
        <script>
              $(document).ready(function () {
                var projectMulti = $("#projectFilter").kendoMultiSelect({
                    autoClose: true,
                    filter: "contains",
                    placeholder: "Select Project(s)"
                }).data("kendoMultiSelect");

                var employeeMulti = $("#employeeId").kendoMultiSelect({
                    autoClose: true,
                    filter: "contains",
                    placeholder: "Select Employee(s)"
                }).data("kendoMultiSelect");
            });
            </script>
        <input type="text"
               id="taskSearch"
               class="filter-input filter-task"
               placeholder="Search task name..." />
        <select asp-for="SearchPeriodId"
                asp-items="Model.AvailableSearchPeriods"
                class="filter-input filter-period"
                id="SearchPeriodId">
        </select>
        <div id="from-container">
            <input type="date" asp-for="From" id="From" class="filter-input" />
        </div>
        <div id="to-container">
            <input type="date" asp-for="To" id="To" class="filter-input" />
        </div>
        <select id="typeFilter" class="filter-input filter-type">
            <option value="">Select Type</option>
            <option value="manual">Manual</option>
            <option value="auto">Auto</option>
        </select>
        <select id="percentageFilter" class="filter-input filter-percentage">
            @foreach (var p in Model.AvailableAlertPercentages)
            {
                <option value="@p.Value">
                    @p.Text
                </option>
            }
        </select>
        <select id="processWorkflow" class="filter-input workflow-filter">
            @foreach (var p in Model.AvailableProcessWorkflow)
            {
                if (p.Selected)
                {
                    <option value="@p.Value" selected="selected">
                        @p.Text
                    </option>
                }
                else
                {
                    <option value="@p.Value">
                        @p.Text
                    </option>
                }
            }
        </select>
            <div class="select2-wrap" style="width:220px;">
                <select id="SearchStatusId"
                        asp-for="SearchStatusId"
                        asp-items="Model.AvailableStatus"
                        style="width:100%;">
                </select>
            </div>
        <label class="filter-checkbox">
            <input type="checkbox" id="showOnlyNotTrack" />
            Not On Track
        </label>
        <button id="btnSearch" class="search-btn">
            Search
        </button>
    </div>
</div>
<div id="followupTablesContainer">
    @await Html.PartialAsync("/Themes/DefaultClean/Views/Extension/Dashboard/_FollowupTables.cshtml", Model)
</div>
<div id="crCommentPopover" class="cr-comment-popover" style="display:none;">
    <div class="cr-comment-header">
        <span>Last Comment</span>
        <span class="cr-comment-close">✖</span>
    </div>
    <div class="cr-comment-body"></div>
</div>
<script>
         function changePageSize() {
        var size = $("#pageSize").val();
        loadCompleted(1, size);
    }
       function loadCompleted(page, size) {
        size = size || $("#pageSize").val();
        $.get("/Dashboard/CompletedFollowUp?page=" + page + "&pageSize=" + size,
            function (html) {
                $("#completedTable").html(html);
            });
    }
    loadCompleted(1)
</script>
<script>
    let openedAccordions = new Set();
            function captureOpenedAccordions() {
        openedAccordions.clear();
        $(".accordion-header.active").each(function () {
            const targetId = $(this).data("target");
            if (targetId) {
                openedAccordions.add(targetId);
            }
        });
    }
        function restoreOpenedAccordions() {
        if (openedAccordions.size === 0) return;
        openedAccordions.forEach(function (targetId) {
            const header = $('.accordion-header[data-target="' + targetId + '"]');
            const content = $(targetId);
            if (header.length && content.length) {
                header.addClass("active");
                content.show();
            }
        });
    }
    $(document).on("click", ".accordion-header", function (e) {
        e.preventDefault();
        var targetId = $(this).data("target");
        var target = $(targetId);
        var isOpen = target.is(":visible");
        var scrollTop = $(window).scrollTop();
        if (isOpen) {
            target.slideUp(200);
            $(this).removeClass("active");
            openedAccordions.delete(targetId);
        } else {
            target.slideDown(200);
            $(this).addClass("active");
            openedAccordions.add(targetId);
        }
    });
    $(document).ready(function () {
        if (openedAccordions.size === 0) {
            const dueTodayHeader = $('.accordion-header[data-target="#dueTodayTable"]');
            if (dueTodayHeader.length) {
                dueTodayHeader.addClass("active");
                $("#dueTodayTable").show();
                openedAccordions.add("#dueTodayTable");
            }
        }
    });
          $('#SearchPeriodId').on('change', function () {
        var periodId = $(this).val();
        if (!periodId) {
            $('#From').val('');
            $('#To').val('');
            $('#from-container').hide();
            $('#to-container').hide();
            return;
        }
        $.ajax({
            url: "@(Url.Action("GetPeriodDateRange", "Reports"))",
            type: 'GET',
            data: { periodId: periodId },
            success: function (data) {
                if (!data.from && !data.to) {
                    $('#From').val('');
                    $('#To').val('');
                    $('#from-container').show();
                    $('#to-container').show();
                }
                else {
                    $('#From').val(data.from);
                    $('#To').val(data.to);
                    $('#from-container').hide();
                    $('#to-container').hide();
                }
            }
        });
    });
    $('#SearchPeriodId').trigger('change');
       $("#btnSearch").click(function () {
        var keyword = $("#taskSearch").val();
        var projectIds = $('#projectFilter').val() || [];
        var employeeIds = $('#employeeId').val() || [];
        var showOnlyNotTrack = $("#showOnlyNotTrack").is(":checked");
        var sourceType = $("#typeFilter").val();
        var percentageFilter = $("#percentageFilter").val();
        var from = $("#From").val();
        var to = $("#To").val();
        var processWorkflow = $("#processWorkflow").val();
        var statusId = $("#SearchStatusId").val();
        var postData = { taskName: keyword, projectIds: projectIds.join(","),employeeIds: employeeIds.join(","),showOnlyNotTrack:showOnlyNotTrack ,sourceType: sourceType , from:from,to:to,percentageFilter:percentageFilter, processWorkflow:processWorkflow, statusId:statusId};
        addAntiForgeryToken(postData);
        $.ajax({
            url: "/Dashboard/SearchFollowup",
            type: "POST",
            data: postData,
            success: function (html) {
        $("#followupTablesContainer").html(html);
       restoreOpenedAccordions();
    },
            error: function () {
                alert("Search failed!");
            }
        });
    });
</script>
<script>
    $(document).ready(function () {
        function formatStatus(state) {
            if (!state.id || !state.text) return state.text;
            var parts = state.text.split("|||");
            var text = parts[0];
            var color = parts.length > 1 ? parts[1] : "";

            if (!color) return text;

            return $(
                '<div style="display:flex;align-items:center;gap:6px;">' +
                    '<div style="width:12px;height:12px;border-radius:50%;background-color:' + color + ';"></div>' +
                    '<span>' + text + '</span>' +
                '</div>'
            );
        }

        var $status = $('#SearchStatusId');
        var $wrap = $status.closest('.select2-wrap');

        function initStatusSelect2() {

            if ($status.data('select2')) {
                $status.select2('destroy');
            }

            $status.select2({
                width: '100%',
                dropdownParent: $wrap,
                templateResult: formatStatus,
                templateSelection: formatStatus,
                escapeMarkup: function (m) { return m; },
                minimumResultsForSearch: Infinity
            });
            var s2 = $status.data('select2');
            if (s2 && s2.$container) {
                s2.$container.css({ width: '220px', minWidth: '220px' });
                s2.$container.find('.select2-selection')
                    .css({ width: '220px', minWidth: '220px' });
            }
        }
        initStatusSelect2();
        var processWorkflowSelector =
            $('#processWorkflow');
            console.log("processWorkflowSelector",processWorkflowSelector)
        processWorkflowSelector.on('change', function () {

            var workflowId = $(this).val();
            $status.empty();

            if (!workflowId || workflowId === "0") {
                initStatusSelect2();
                return;
            }

            $.ajax({
                url: '/ProjectTask/GetStatusesByProcessWorkflow',
                type: 'GET',
                data: { processWorkflowId: workflowId },
                success: function (data) {

                    $.each(data, function (i, item) {
                        $status.append(
                            $('<option>')
                                .val(item.Value)
                                .text(item.Text) 
                        );
                    });

                    initStatusSelect2();
                },
                error: function () {
                    alert('Failed to load statuses.');
                }
            });
        });
          processWorkflowSelector.trigger('change');
    });
</script>
